{
  int degreeOfParallelism=2;
  int numSubTasksPerInstance=degreeOfParallelism;
  String pageWithRankInputPath="file://" + PlayConstants.PLAY_DIR + "test-inputs/danglingpagerank/pageWithRank";
  String transitionMatrixInputPath="file://" + PlayConstants.PLAY_DIR + "test-inputs/danglingpagerank/transitionMatrix";
  String outputPath="file:///tmp/stratosphere/iterations";
  String confPath=PlayConstants.PLAY_DIR + "local-conf";
  int memoryPerTask=25;
  int memoryForMatch=memoryPerTask;
  int numIterations=25;
  long numVertices=4;
  long numDanglingVertices=1;
  int failingWorker=1;
  int failingIteration=2;
  double messageLoss=0.75;
  if (args.length == 14) {
    degreeOfParallelism=Integer.parseInt(args[0]);
    numSubTasksPerInstance=Integer.parseInt(args[1]);
    pageWithRankInputPath=args[2];
    transitionMatrixInputPath=args[3];
    outputPath=args[4];
    confPath=args[5];
    memoryPerTask=Integer.parseInt(args[6]);
    memoryForMatch=Integer.parseInt(args[7]);
    numIterations=Integer.parseInt(args[8]);
    numVertices=Long.parseLong(args[9]);
    numDanglingVertices=Long.parseLong(args[10]);
    failingWorker=Integer.parseInt(args[11]);
    failingIteration=Integer.parseInt(args[12]);
    messageLoss=Double.parseDouble(args[13]);
  }
  JobGraph jobGraph=new JobGraph("CompensatableDanglingPageRank");
  JobInputVertex pageWithRankInput=JobGraphUtils.createInput(DanglingPageGenerateRankInputFormat.class,pageWithRankInputPath,"DanglingPageWithRankInput",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig pageWithRankInputConfig=new TaskConfig(pageWithRankInput.getConfiguration());
  pageWithRankInputConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(pageWithRankInputConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  pageWithRankInputConfig.setStubParameter("pageRank.numVertices",String.valueOf(numVertices));
  JobInputVertex transitionMatrixInput=JobGraphUtils.createInput(RowPartitionedTransitionMatrixInputFormat.class,transitionMatrixInputPath,"TransitionMatrixInput",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig transitionMatrixInputConfig=new TaskConfig(transitionMatrixInput.getConfiguration());
  transitionMatrixInputConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(transitionMatrixInputConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex sortedPartitionedPageRank=JobGraphUtils.createTask(RegularPactTask.class,"SortedPartitionedPageRank",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig sortedPartitionedPageRankConfig=new TaskConfig(sortedPartitionedPageRank.getConfiguration());
  sortedPartitionedPageRankConfig.setDriver(SortingTempDriver.class);
  sortedPartitionedPageRankConfig.setStubClass(IdentityMap.class);
  sortedPartitionedPageRankConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  sortedPartitionedPageRankConfig.setNumFilehandles(10);
  sortedPartitionedPageRankConfig.setComparatorFactoryForInput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(sortedPartitionedPageRankConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex head=JobGraphUtils.createTask(IterationHeadPactTask.class,"IterationHead",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig headConfig=new TaskConfig(head.getConfiguration());
  headConfig.setDriver(MapDriver.class);
  headConfig.setStubClass(NormalizingMap.class);
  headConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  headConfig.setBackChannelMemoryFraction(0.8f);
  headConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(headConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  headConfig.setStubParameter("pageRank.numVertices",String.valueOf(numVertices));
  headConfig.setStubParameter("compensation.failingWorker",String.valueOf(failingWorker));
  headConfig.setStubParameter("compensation.failingIteration",String.valueOf(failingIteration));
  headConfig.setStubParameter("compensation.messageLoss",String.valueOf(messageLoss));
  JobTaskVertex tempIntermediate=JobGraphUtils.createTask(IterationIntermediatePactTask.class,"TempIntermediate",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig tempIntermediateConfig=new TaskConfig(tempIntermediate.getConfiguration());
  tempIntermediateConfig.setDriver(TempDriver.class);
  tempIntermediateConfig.setStubClass(IdentityMap.class);
  tempIntermediateConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  JobTaskVertex intermediate=JobGraphUtils.createTask(IterationIntermediatePactTask.class,"IterationIntermediate",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig intermediateConfig=new TaskConfig(intermediate.getConfiguration());
  intermediateConfig.setDriver(RepeatableHashjoinMatchDriverWithCachedBuildside.class);
  intermediateConfig.setStubClass(CompensatableDotProductMatch.class);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateConfig.getConfigForInputParameters(1),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  intermediateConfig.setMemorySize(memoryForMatch * JobGraphUtils.MEGABYTE);
  intermediateConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  intermediateConfig.setStubParameter("pageRank.numVertices",String.valueOf(numVertices));
  intermediateConfig.setStubParameter("compensation.failingWorker",String.valueOf(failingWorker));
  intermediateConfig.setStubParameter("compensation.failingIteration",String.valueOf(failingIteration));
  intermediateConfig.setStubParameter("compensation.messageLoss",String.valueOf(messageLoss));
  JobTaskVertex tail=JobGraphUtils.createTask(IterationTailPactTask.class,"IterationTail",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig tailConfig=new TaskConfig(tail.getConfiguration());
  tailConfig.setDriver(CoGroupDriver.class);
  tailConfig.setLocalStrategy(TaskConfig.LocalStrategy.SORT_SECOND_MERGE);
  tailConfig.setStubClass(CompensatableDotProductCoGroup.class);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(tailConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(tailConfig.getConfigForInputParameters(1),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  tailConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  tailConfig.setNumFilehandles(10);
  tailConfig.setStubParameter("pageRank.numVertices",String.valueOf(numVertices));
  tailConfig.setStubParameter("pageRank.numDanglingVertices",String.valueOf(numDanglingVertices));
  tailConfig.setStubParameter("compensation.failingWorker",String.valueOf(failingWorker));
  tailConfig.setStubParameter("compensation.failingIteration",String.valueOf(failingIteration));
  tailConfig.setStubParameter("compensation.messageLoss",String.valueOf(messageLoss));
  JobOutputVertex sync=JobGraphUtils.createSync(jobGraph,degreeOfParallelism);
  TaskConfig syncConfig=new TaskConfig(sync.getConfiguration());
  syncConfig.setNumberOfIterations(numIterations);
  syncConfig.setConvergenceCriterion(DiffL1NormConvergenceCriterion.class);
  JobOutputVertex output=JobGraphUtils.createFileOutput(jobGraph,"FinalOutput",degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig outputConfig=new TaskConfig(output.getConfiguration());
  outputConfig.setStubClass(PageWithRankOutFormat.class);
  outputConfig.setStubParameter(FileOutputFormat.FILE_PARAMETER_KEY,outputPath);
  JobOutputVertex fakeTailOutput=JobGraphUtils.createFakeOutput(jobGraph,"FakeTailOutput",degreeOfParallelism,numSubTasksPerInstance);
  JobGraphUtils.connect(pageWithRankInput,sortedPartitionedPageRank,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  JobGraphUtils.connect(sortedPartitionedPageRank,head,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(head,intermediate,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(tempIntermediate,tail,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(head,tempIntermediate,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  tempIntermediateConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,1);
  JobGraphUtils.connect(transitionMatrixInput,intermediate,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  intermediateConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,1);
  JobGraphUtils.connect(head,sync,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(head,output,ChannelType.INMEMORY,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(tail,fakeTailOutput,ChannelType.INMEMORY,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(intermediate,tail,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  tailConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,1);
  tailConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(1,degreeOfParallelism);
  fakeTailOutput.setVertexToShareInstancesWith(tail);
  tail.setVertexToShareInstancesWith(head);
  pageWithRankInput.setVertexToShareInstancesWith(head);
  sortedPartitionedPageRank.setVertexToShareInstancesWith(head);
  transitionMatrixInput.setVertexToShareInstancesWith(head);
  intermediate.setVertexToShareInstancesWith(head);
  output.setVertexToShareInstancesWith(head);
  sync.setVertexToShareInstancesWith(head);
  tempIntermediate.setVertexToShareInstancesWith(head);
  GlobalConfiguration.loadConfiguration(confPath);
  Configuration conf=GlobalConfiguration.getConfiguration();
  JobGraphUtils.submit(jobGraph,conf);
}
