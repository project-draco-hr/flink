{
  for (  int targetChannel : channelSelector.selectChannels(record,numChannels)) {
    RecordSerializer<T> serializer=serializers[targetChannel];
synchronized (serializer) {
      SerializationResult result=serializer.addRecord(record);
      while (result.isFullBuffer()) {
        Buffer buffer=serializer.getCurrentBuffer();
        if (buffer != null) {
          writer.writeBuffer(buffer,targetChannel);
          serializer.clearCurrentBuffer();
        }
        buffer=writer.getBufferProvider().requestBufferBlocking();
        if (reporter != null) {
          reporter.reportNumBytesOut(buffer.getSize());
        }
        result=serializer.setNextBuffer(buffer);
      }
      if (reporter != null) {
        reporter.reportNumRecordsOut(1);
      }
    }
  }
}
