{
  Configuration configuration=jobGraph.getJobConfiguration();
  LocalFlinkMiniCluster exec=null;
  configuration.setLong(ConfigConstants.TASK_MANAGER_MEMORY_SIZE_KEY,memorySize);
  configuration.setInteger(ConfigConstants.TASK_MANAGER_NUM_TASK_SLOTS,parallelism);
  if (customConf != null) {
    configuration.addAll(customConf);
  }
  if (LOG.isInfoEnabled()) {
    LOG.info("Running on mini cluster");
  }
  try {
    exec=new LocalFlinkMiniCluster(configuration,true);
    if (detached) {
      exec.submitJobDetached(jobGraph);
      return null;
    }
 else {
      SerializedJobExecutionResult result=exec.submitJobAndWait(jobGraph,printDuringExecution);
      return result.toJobExecutionResult(ClusterUtil.class.getClassLoader());
    }
  }
  finally {
    if (exec != null && !detached) {
      exec.stop();
    }
  }
}
