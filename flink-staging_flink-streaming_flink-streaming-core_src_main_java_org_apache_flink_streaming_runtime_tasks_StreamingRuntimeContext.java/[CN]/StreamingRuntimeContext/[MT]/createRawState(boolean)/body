{
  if (partitioned) {
    if (statePartitioner != null) {
      return new PartitionedStreamOperatorState(provider,statePartitioner,getUserCodeClassLoader());
    }
 else {
      throw new RuntimeException("Partitioned state can only be used with KeyedDataStreams.");
    }
  }
 else {
    return new StreamOperatorState(provider);
  }
}
