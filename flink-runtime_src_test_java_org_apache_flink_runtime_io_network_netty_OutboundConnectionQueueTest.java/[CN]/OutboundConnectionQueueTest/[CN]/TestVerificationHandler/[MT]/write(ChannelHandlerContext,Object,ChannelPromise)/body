{
  if (closeLatch.getCount() == 0) {
    throw new IllegalStateException("Write on closed channel.");
  }
  if (msg.getClass() == Envelope.class) {
    Envelope env=(Envelope)msg;
    final int currentSeqNum=env.getSequenceNumber();
    final ChannelID source=env.getSource();
    Integer previousSeqNum=receivedSequenceNums.put(source,currentSeqNum);
    if (previousSeqNum != null) {
      String errMsg=String.format("Received %s with unexpected sequence number.",env);
      Assert.assertEquals(errMsg,previousSeqNum + 1,currentSeqNum);
    }
    promise.setSuccess();
    Integer expectedSeqNum=expectedSequenceNums.get(source);
    if (expectedSeqNum != null && expectedSeqNum.equals(currentSeqNum)) {
      envelopeLatches.remove(source).countDown();
    }
  }
}
