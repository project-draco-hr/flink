{
  if (LOG.isInfoEnabled())   LOG.info(getLogString("Start PACT code"));
  try {
switch (this.config.getInputLocalStrategy(0)) {
case NONE:
      localStrategy=null;
    input=reader;
  break;
case SORT:
try {
  TypeComparatorFactory<IT> compFact=this.config.getInputComparator(0,this.userCodeClassLoader);
  if (compFact == null) {
    throw new Exception("Missing comparator factory for local strategy on input " + 0);
  }
  UnilateralSortMerger<IT> sorter=new UnilateralSortMerger<IT>(getEnvironment().getMemoryManager(),getEnvironment().getIOManager(),this.reader,this,this.inputTypeSerializer,compFact.createComparator(),this.config.getMemoryInput(0),this.config.getFilehandlesInput(0),this.config.getSpillingThresholdInput(0));
  this.localStrategy=sorter;
  this.input=sorter.getIterator();
}
 catch (Exception e) {
  throw new RuntimeException("Initializing the input processing failed" + e.getMessage() == null ? "." : ": " + e.getMessage(),e);
}
break;
default :
throw new RuntimeException("Invalid local strategy for DataSinkTask");
}
final MutableObjectIterator<IT> input=this.input;
final OutputFormat<IT> format=this.format;
final IT record=this.inputTypeSerializer.createInstance();
if (this.taskCanceled) {
return;
}
if (LOG.isDebugEnabled()) {
LOG.debug(getLogString("Starting to produce output"));
}
format.open(this.getEnvironment().getIndexInSubtaskGroup() + 1);
if (record.getClass() == PactRecord.class && format instanceof eu.stratosphere.api.record.io.FileOutputFormat) {
@SuppressWarnings("unchecked") final MutableObjectIterator<PactRecord> pi=(MutableObjectIterator<PactRecord>)input;
final PactRecord pr=(PactRecord)record;
final eu.stratosphere.api.record.io.FileOutputFormat pf=(eu.stratosphere.api.record.io.FileOutputFormat)format;
while (!this.taskCanceled && pi.next(pr)) {
pf.writeRecord(pr);
}
}
 else {
while (!this.taskCanceled && input.next(record)) {
format.writeRecord(record);
}
}
if (!this.taskCanceled) {
this.format.close();
this.format=null;
}
}
 catch (Exception ex) {
if (!this.taskCanceled) {
if (LOG.isErrorEnabled()) LOG.error(getLogString("Error in Pact user code: " + ex.getMessage()),ex);
throw ex;
}
}
 finally {
if (this.format != null) {
try {
this.format.close();
}
 catch (Throwable t) {
if (LOG.isWarnEnabled()) LOG.warn(getLogString("Error closing the ouput format."),t);
}
}
if (localStrategy != null) {
try {
this.localStrategy.close();
}
 catch (Throwable t) {
LOG.error("Error closing local strategy",t);
}
}
}
if (!this.taskCanceled) {
if (LOG.isDebugEnabled()) LOG.debug(getLogString("Finished producing output"));
if (LOG.isInfoEnabled()) LOG.info(getLogString("Finished PACT code"));
}
 else {
if (LOG.isWarnEnabled()) LOG.warn(getLogString("PACT code cancelled"));
}
}
