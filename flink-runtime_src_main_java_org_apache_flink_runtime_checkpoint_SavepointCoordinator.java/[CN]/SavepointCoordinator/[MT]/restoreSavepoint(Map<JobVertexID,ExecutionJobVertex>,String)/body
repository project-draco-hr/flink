{
  checkNotNull(savepointPath,"Savepoint path");
synchronized (lock) {
    if (isShutdown()) {
      throw new IllegalStateException("CheckpointCoordinator is shut down");
    }
    long recoveryTimestamp=System.currentTimeMillis();
    LOG.info("Rolling back to savepoint '{}'.",savepointPath);
    Savepoint savepoint=savepointStore.getState(savepointPath);
    CompletedCheckpoint checkpoint=savepoint.getCompletedCheckpoint();
    LOG.info("Savepoint: {}@{}",checkpoint.getCheckpointID(),checkpoint.getTimestamp());
    for (    StateForTask state : checkpoint.getStates()) {
      ExecutionJobVertex vertex=tasks.get(state.getOperatorId());
      if (vertex == null) {
        String msg=String.format("Failed to rollback to savepoint %s. " + "Cannot map old state for task %s to the new program. " + "This indicates that the program has been changed after "+ "the savepoint.",savepoint,state.getOperatorId());
        throw new IllegalStateException(msg);
      }
      Execution exec=vertex.getTaskVertices()[state.getSubtask()].getCurrentExecutionAttempt();
      exec.setInitialState(state.getState(),recoveryTimestamp);
    }
    long nextCheckpointId=checkpoint.getCheckpointID();
    checkpointIdCounter.setCount(nextCheckpointId + 1);
    LOG.info("Reset the checkpoint ID to {}",nextCheckpointId);
    this.appId=savepoint.getApplicationId();
    LOG.info("Reset the application ID to {}",appId);
    return appId;
  }
}
