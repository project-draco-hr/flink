{
  try {
    FileDataSource sourceNode=new FileDataSource(TextInputFormat.class,IN_FILE,"Input Lines");
    MapContract mapNode=MapContract.builder(TokenizeLine.class).input(sourceNode).name("Tokenize Lines").build();
    ReduceContract reduceNode=new ReduceContract.Builder(CountWords.class,PactString.class,0).input(mapNode).name("Count Words").build();
    FileDataSink out=new FileDataSink(RecordOutputFormat.class,OUT_FILE,reduceNode,"Word Counts");
    RecordOutputFormat.configureRecordFormat(out).recordDelimiter('\n').fieldDelimiter(' ').lenient(true).field(PactString.class,0).field(PactInteger.class,1);
    out.setGlobalOrder(new Ordering(0,PactString.class,Order.DESCENDING),new MockDataDistribution());
    Plan p=new Plan(out,"WordCount Example");
    p.setDefaultParallelism(DEFAULT_PARALLELISM);
    OptimizedPlan plan;
    if (estimates) {
      setSourceStatistics(sourceNode,1024 * 1024 * 1024* 1024L,24f);
      plan=compileWithStats(p);
    }
 else {
      plan=compileNoStats(p);
    }
    OptimizerPlanNodeResolver resolver=getOptimizerPlanNodeResolver(plan);
    SinkPlanNode sink=resolver.getNode("Word Counts");
    SingleInputPlanNode reducer=resolver.getNode("Count Words");
    SingleInputPlanNode mapper=resolver.getNode("Tokenize Lines");
    Assert.assertEquals(ShipStrategyType.FORWARD,mapper.getInput().getShipStrategy());
    Assert.assertEquals(ShipStrategyType.PARTITION_RANGE,reducer.getInput().getShipStrategy());
    Assert.assertEquals(ShipStrategyType.FORWARD,sink.getInput().getShipStrategy());
    Channel c=reducer.getInput();
    Assert.assertEquals(LocalStrategy.COMBININGSORT,c.getLocalStrategy());
    FieldList l=new FieldList(0);
    Assert.assertEquals(l,c.getShipStrategyKeys());
    Assert.assertEquals(l,c.getLocalStrategyKeys());
    Assert.assertFalse(c.getShipStrategySortOrder()[0]);
    Assert.assertFalse(c.getLocalStrategySortOrder()[0]);
    SingleInputPlanNode combiner=(SingleInputPlanNode)reducer.getPredecessor();
    Assert.assertEquals(DriverStrategy.PARTIAL_GROUP,combiner.getDriverStrategy());
    Assert.assertEquals(l,combiner.getKeys());
    Assert.assertEquals(ShipStrategyType.FORWARD,combiner.getInput().getShipStrategy());
  }
 catch (  Exception e) {
    e.printStackTrace();
    Assert.fail(e.getMessage());
  }
}
