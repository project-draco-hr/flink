{
  double distance=0;
  for (int index=0; index < schema.length; index++) {
    Value expected=expectedRecord.getField(index,schema[index]);
    Value actual=actualRecord.getField(index,schema[index]);
    List<ValueSimilarity<?>> sims=similarities.get(index);
    if (sims == null) {
      if (!actual.equals(expected))       return ValueSimilarity.NO_MATCH;
      continue;
    }
    double valueDistance=0;
    for (    ValueSimilarity sim : sims) {
      double simDistance=sim.getDistance(expected,actual);
      if (simDistance < 0)       return simDistance;
      valueDistance+=simDistance;
    }
    distance+=valueDistance / sims.size();
  }
  return distance;
}
