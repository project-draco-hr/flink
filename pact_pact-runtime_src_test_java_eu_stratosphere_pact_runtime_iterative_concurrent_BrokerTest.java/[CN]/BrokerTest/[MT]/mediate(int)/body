{
  Broker<Integer,String> broker=new Broker<Integer,String>();
  ConcurrentMap<Integer,String> results=Maps.newConcurrentMap();
  Thread[] heads=new Thread[subtasks];
  for (int subtask=0; subtask < subtasks; subtask++) {
    heads[subtask]=new Thread(new IterationHead(broker,subtask,"value" + subtask));
  }
  Thread[] tails=new Thread[subtasks];
  for (int subtask=0; subtask < subtasks; subtask++) {
    tails[subtask]=new Thread(new IterationTail(broker,subtask,results));
  }
  for (int subtask=0; subtask < subtasks; subtask++) {
    heads[subtask].start();
    tails[subtask].start();
  }
  for (int subtask=0; subtask < subtasks; subtask++) {
    heads[subtask].join();
    tails[subtask].join();
  }
  assertEquals(subtasks,results.size());
  for (int subtask=0; subtask < subtasks; subtask++) {
    assertEquals("value" + subtask,results.get(subtask));
  }
}
