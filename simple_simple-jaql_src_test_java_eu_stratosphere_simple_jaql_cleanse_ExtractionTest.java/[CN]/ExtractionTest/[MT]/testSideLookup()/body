{
  final SopremoPlan actualPlan=this.parseScript("using cleansing;\n" + "$scrubbedEarmarks = read 'scrubbedEarmarks.json';\n" + "extract from $scrubbedEarmarks into {\n"+ "	$funds = group $ by $.earmarkId into {\n"+ "		id: generateId('earmark'),\n"+ "		amount: sum($[*].amount),\n"+ "		currency: 'USD',\n"+ "		date: {\n"+ "			year: $[0].enactedYear\n"+ "		},\n"+ "		subject: $[0].shortDescription\n"+ "	},\n"+ "	$recipients = group $ by $.recipient into {\n"+ "		id: generateId('earmark_person'),\n"+ "		names: [$.recipient],\n"+ "		receivedFunds: project $ into {\n"+ "			id: $funds[$.earmarkId].id,\n"+ "			amount: $.amount\n"+ "		},\n"+ "		category: $[0].recipientType\n"+ "	}\n"+ "};\n"+ "write $funds to hdfs('Earmark_Funds.json');\n"+ "write $recipients to hdfs('Earmark_Recipients.json');");
  final SopremoPlan expectedPlan=new SopremoPlan();
  final Source scrubbedEarmarks=new Source("scrubbedEarmarks.json");
  final EntityExtraction extraction=new EntityExtraction().withInputs(scrubbedEarmarks);
  Grouping fundExtraction=new Grouping().withInputs(extraction.getInputs().get(0)).withGroupingKey(JsonUtil.createPath("0","earmarkId")).withResultProjection(new ObjectCreation(new ObjectCreation.FieldAssignment("id",new MethodCall("generateId",new ConstantExpression("earmark"))),new ObjectCreation.FieldAssignment("amount",new MethodCall("sum",new PathExpression(new InputSelection(0),new ArrayProjection(new ObjectAccess("amount"))))),new ObjectCreation.FieldAssignment("currency",new ConstantExpression("USD")),new ObjectCreation.FieldAssignment("date",new ObjectCreation(new ObjectCreation.FieldAssignment("year",JsonUtil.createPath("0","[0]","enactedYear")))),new ObjectCreation.FieldAssignment("subject",JsonUtil.createPath("0","[0]","shortDescription"))));
  Grouping recepientExtraction=new Grouping();
  Projection inlineProjection=new Projection().withInputs(recepientExtraction).withValueTransformation(new ObjectCreation(new ObjectCreation.FieldAssignment("id",new StreamIndexExpression(fundExtraction,JsonUtil.createPath("0","earmarkId"))),new ObjectCreation.FieldAssignment("amount",JsonUtil.createPath("0","amount"))));
  recepientExtraction.withInputs(extraction.getInputs().get(0)).withGroupingKey(JsonUtil.createPath("0","recipient")).withResultProjection(new ObjectCreation(new ObjectCreation.FieldAssignment("id",new MethodCall("generateId",new ConstantExpression("earmark_person"))),new ObjectCreation.FieldAssignment("names",new ArrayCreation(JsonUtil.createPath("0","recipient"))),new ObjectCreation.FieldAssignment("receivedFunds",new NestedOperatorExpression(inlineProjection)),new ObjectCreation.FieldAssignment("category",JsonUtil.createPath("0","[0]","recipientType"))));
  extraction.addExtraction(fundExtraction);
  extraction.addExtraction(recepientExtraction);
  expectedPlan.setSinks(new Sink("Earmark_Recipients.json").withInputs(extraction.getOutput(1)),new Sink("Earmark_Funds.json").withInputs(extraction.getOutput(0)));
  assertEquals(expectedPlan,actualPlan);
}
