{
  if (configuration == null) {
    String forkNumberString=System.getProperty("forkNumber");
    int forkNumber=-1;
    try {
      forkNumber=Integer.parseInt(forkNumberString);
    }
 catch (    NumberFormatException e) {
    }
    if (configDir != null) {
      GlobalConfiguration.loadConfiguration(configDir);
      configuration=GlobalConfiguration.getConfiguration();
    }
 else {
      configuration=getDefaultConfig(userConfiguration);
    }
    configuration.addAll(userConfiguration);
    if (forkNumber != -1) {
      int jobManagerRPC=1024 + forkNumber * 300;
      int taskManagerRPC=1024 + forkNumber * 300 + 100;
      int taskManagerDATA=1024 + forkNumber * 300 + 200;
      configuration.setInteger(ConfigConstants.JOB_MANAGER_IPC_PORT_KEY,jobManagerRPC);
      configuration.setInteger(ConfigConstants.TASK_MANAGER_IPC_PORT_KEY,taskManagerRPC);
      configuration.setInteger(ConfigConstants.TASK_MANAGER_DATA_PORT_KEY,taskManagerDATA);
    }
    initializeIOFormatClasses(configuration);
  }
  return configuration;
}
