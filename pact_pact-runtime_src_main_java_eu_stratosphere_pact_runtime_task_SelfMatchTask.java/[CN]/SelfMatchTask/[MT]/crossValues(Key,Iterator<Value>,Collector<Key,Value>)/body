{
  final SerializationCopier<Value>[] valBuffer=new SerializationCopier[VALUE_BUFFER_SIZE];
  this.keyCopier.setCopy(key);
  Key copyKey;
  Value outerVal;
  Value innerVal;
  int bufferValCnt;
  for (bufferValCnt=0; bufferValCnt < VALUE_BUFFER_SIZE; bufferValCnt++) {
    if (values.hasNext()) {
      valBuffer[bufferValCnt]=new SerializationCopier<Value>();
      valBuffer[bufferValCnt].setCopy(values.next());
    }
 else {
      break;
    }
  }
  for (int i=0; i < bufferValCnt; i++) {
    if (this.taskCanceled)     return;
    for (int j=0; j < bufferValCnt; j++) {
      if (this.taskCanceled)       return;
      copyKey=keySerialization.newInstance();
      this.keyCopier.getCopy(copyKey);
      outerVal=valSerialization.newInstance();
      valBuffer[i].getCopy(outerVal);
      innerVal=valSerialization.newInstance();
      valBuffer[j].getCopy(innerVal);
      stub.match(copyKey,outerVal,innerVal,out);
    }
  }
  if (!this.taskCanceled && values.hasNext()) {
    Iterator<Value> valReader=new Iterator<Value>(){
      @Override public boolean hasNext(){
        if (taskCanceled)         return false;
 else         return values.hasNext();
      }
      @Override public Value next(){
        Value nextVal=values.next();
        Key copyKey;
        Value outerVal;
        Value innerVal;
        innerValCopier.setCopy(nextVal);
        for (int i=0; i < VALUE_BUFFER_SIZE; i++) {
          copyKey=keySerialization.newInstance();
          keyCopier.getCopy(copyKey);
          outerVal=valSerialization.newInstance();
          valBuffer[i].getCopy(outerVal);
          innerVal=valSerialization.newInstance();
          innerValCopier.getCopy(innerVal);
          stub.match(copyKey,outerVal,innerVal,out);
        }
        return nextVal;
      }
      @Override public void remove(){
        throw new UnsupportedOperationException();
      }
    }
;
    SpillingResettableIterator<Value> outerValResettableIterator=null;
    SpillingResettableIterator<Value> innerValResettableIterator=null;
    try {
      ValueDeserializer<Value> v1Deserializer=new ValueDeserializer<Value>(stub.getFirstInValueType());
      outerValResettableIterator=new SpillingResettableIterator<Value>(getEnvironment().getMemoryManager(),getEnvironment().getIOManager(),valReader,(long)(this.availableMemory * (MEMORY_SHARE_RATIO / 2)),v1Deserializer,this);
      outerValResettableIterator.open();
      BufferIncludingIterator bii=new BufferIncludingIterator(valBuffer,outerValResettableIterator);
      if (!this.taskCanceled && outerValResettableIterator.hasNext()) {
        innerValResettableIterator=new SpillingResettableIterator<Value>(getEnvironment().getMemoryManager(),getEnvironment().getIOManager(),bii,(long)(this.availableMemory * (MEMORY_SHARE_RATIO / 2)),v1Deserializer,this);
        innerValResettableIterator.open();
        outerValResettableIterator.reset();
        while (!this.taskCanceled && outerValResettableIterator.hasNext()) {
          bufferValCnt=0;
          while (!this.taskCanceled && outerValResettableIterator.hasNext() && bufferValCnt < VALUE_BUFFER_SIZE) {
            valBuffer[bufferValCnt++].setCopy(outerValResettableIterator.next());
          }
          if (bufferValCnt == 0)           break;
          while (!this.taskCanceled && innerValResettableIterator.hasNext()) {
            innerVal=innerValResettableIterator.next();
            for (int i=0; i < bufferValCnt; i++) {
              copyKey=keySerialization.newInstance();
              keyCopier.getCopy(copyKey);
              outerVal=valSerialization.newInstance();
              valBuffer[i].getCopy(outerVal);
              stub.match(copyKey,outerVal,innerVal,out);
              if (i < bufferValCnt - 1)               innerVal=innerValResettableIterator.repeatLast();
            }
          }
          innerValResettableIterator.reset();
        }
      }
    }
 catch (    Exception e) {
      throw new RuntimeException(e);
    }
 finally {
      if (innerValResettableIterator != null) {
        innerValResettableIterator.close();
      }
      if (outerValResettableIterator != null) {
        outerValResettableIterator.close();
      }
    }
  }
}
