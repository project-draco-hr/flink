{
  if (minimumSizeOfBuffer > this.maximumBufferSize) {
    throw new IllegalArgumentException("Buffer of " + minimumSizeOfBuffer + " bytes is requested, but maximum buffer size is "+ this.maximumBufferSize);
  }
  while (true) {
    boolean async=false;
synchronized (this.buffers) {
      while (this.requestedNumberOfBuffers > this.designatedNumberOfBuffers) {
        final MemorySegment seg=this.buffers.poll();
        if (seg == null) {
          break;
        }
        this.globalBufferPool.releaseGlobalBuffer(seg);
        this.requestedNumberOfBuffers--;
      }
      while (this.buffers.isEmpty()) {
        if (this.requestedNumberOfBuffers < this.designatedNumberOfBuffers) {
          final MemorySegment memSeg=this.globalBufferPool.lockGlobalBuffer();
          if (memSeg != null) {
            this.buffers.add(memSeg);
            this.requestedNumberOfBuffers++;
            continue;
          }
        }
        if (this.asynchronousEventOccurred && block) {
          this.asynchronousEventOccurred=false;
          async=true;
          break;
        }
        if (block) {
          this.buffers.wait(100);
        }
 else {
          return null;
        }
      }
      if (!async) {
        final MemorySegment memSeg=this.buffers.poll();
        return BufferFactory.createFromMemory(minimumSizeOfBuffer,memSeg,this.bufferPoolConnector);
      }
    }
  }
}
