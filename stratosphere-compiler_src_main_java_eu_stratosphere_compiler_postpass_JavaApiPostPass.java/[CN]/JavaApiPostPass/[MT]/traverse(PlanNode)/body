{
  if (!alreadyDone.add(node)) {
    return;
  }
  if (node instanceof SinkPlanNode) {
    SinkPlanNode sn=(SinkPlanNode)node;
    Channel inchannel=sn.getInput();
    traverseChannel(inchannel);
  }
 else   if (node instanceof SourcePlanNode) {
    TypeInformation<?> typeInfo=getTypeInfoFromSource((SourcePlanNode)node);
    ((SourcePlanNode)node).setSerializer(createSerializer(typeInfo));
  }
 else   if (node instanceof BulkIterationPlanNode) {
    BulkIterationPlanNode iterationNode=(BulkIterationPlanNode)node;
    if (iterationNode.getRootOfStepFunction() instanceof NAryUnionPlanNode) {
      throw new CompilerException("Optimizer cannot compile an iteration step function where next partial solution is created by a Union node.");
    }
    PlanBulkIterationOperator<?> operator=(PlanBulkIterationOperator<?>)iterationNode.getPactContract();
    iterationNode.setSerializerForIterationChannel(createSerializer(operator.getReturnType()));
    traverseChannel(iterationNode.getInput());
    traverse(iterationNode.getRootOfStepFunction());
  }
 else   if (node instanceof WorksetIterationPlanNode) {
    WorksetIterationPlanNode iterationNode=(WorksetIterationPlanNode)node;
    if (iterationNode.getNextWorkSetPlanNode() instanceof NAryUnionPlanNode) {
      throw new CompilerException("Optimizer cannot compile a workset iteration step function where the next workset is produced by a Union node.");
    }
    if (iterationNode.getSolutionSetDeltaPlanNode() instanceof NAryUnionPlanNode) {
      throw new CompilerException("Optimizer cannot compile a workset iteration step function where the solution set delta is produced by a Union node.");
    }
    PlanDeltaIterationOperator<?,?> operator=(PlanDeltaIterationOperator<?,?>)iterationNode.getPactContract();
    iterationNode.setSolutionSetSerializer(createSerializer(operator.getSolutionsetType()));
    iterationNode.setWorksetSerializer(createSerializer(operator.getWorksetType()));
    iterationNode.setSolutionSetComparator(createComparator(operator.getSolutionsetType(),iterationNode.getSolutionSetKeyFields(),getSortOrders(iterationNode.getSolutionSetKeyFields(),null)));
    traverseChannel(iterationNode.getInput1());
    traverseChannel(iterationNode.getInput2());
    traverse(iterationNode.getSolutionSetDeltaPlanNode());
    traverse(iterationNode.getNextWorkSetPlanNode());
  }
 else   if (node instanceof SingleInputPlanNode) {
    SingleInputPlanNode sn=(SingleInputPlanNode)node;
    if (!(sn.getOptimizerNode().getPactContract() instanceof UnaryJavaPlanNode)) {
      if (sn.getOptimizerNode().getPactContract() instanceof NoOpUnaryUdfOp) {
        traverseChannel(sn.getInput());
        return;
      }
 else {
        throw new RuntimeException("Wrong operator type found in post pass.");
      }
    }
    UnaryJavaPlanNode<?,?> javaNode=(UnaryJavaPlanNode<?,?>)sn.getOptimizerNode().getPactContract();
    if (sn.getDriverStrategy().requiresComparator()) {
      sn.setComparator(createComparator(javaNode.getInputType(),sn.getKeys(),getSortOrders(sn.getKeys(),sn.getSortOrders())));
    }
    traverseChannel(sn.getInput());
    for (    Channel c : sn.getBroadcastInputs()) {
      traverseChannel(c);
    }
  }
 else   if (node instanceof DualInputPlanNode) {
    DualInputPlanNode dn=(DualInputPlanNode)node;
    if (!(dn.getOptimizerNode().getPactContract() instanceof BinaryJavaPlanNode)) {
      throw new RuntimeException("Wrong operator type found in post pass.");
    }
    BinaryJavaPlanNode<?,?,?> javaNode=(BinaryJavaPlanNode<?,?,?>)dn.getOptimizerNode().getPactContract();
    if (dn.getDriverStrategy().requiresComparator()) {
      dn.setComparator1(createComparator(javaNode.getInputType1(),dn.getKeysForInput1(),getSortOrders(dn.getKeysForInput1(),dn.getSortOrders())));
      dn.setComparator2(createComparator(javaNode.getInputType2(),dn.getKeysForInput2(),getSortOrders(dn.getKeysForInput2(),dn.getSortOrders())));
      dn.setPairComparator(createPairComparator(javaNode.getInputType1(),javaNode.getInputType2()));
    }
    traverseChannel(dn.getInput1());
    traverseChannel(dn.getInput2());
    for (    Channel c : dn.getBroadcastInputs()) {
      traverseChannel(c);
    }
  }
 else   if (node instanceof BulkPartialSolutionPlanNode || node instanceof SolutionSetPlanNode || node instanceof WorksetPlanNode) {
  }
 else   if (node instanceof NAryUnionPlanNode) {
    for (Iterator<Channel> channels=node.getInputs(); channels.hasNext(); ) {
      traverseChannel(channels.next());
    }
  }
 else {
    throw new CompilerPostPassException("Unknown node type encountered: " + node.getClass().getName());
  }
}
