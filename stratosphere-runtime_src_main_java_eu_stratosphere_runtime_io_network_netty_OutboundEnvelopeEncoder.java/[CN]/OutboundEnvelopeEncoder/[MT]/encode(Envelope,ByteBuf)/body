{
  out.writeInt(MAGIC_NUMBER);
  if (out.getInt(out.writerIndex() - 4) != MAGIC_NUMBER) {
    throw new RuntimeException();
  }
  out.writeInt(env.getSequenceNumber());
  env.getJobID().writeTo(out);
  env.getSource().writeTo(out);
  out.writeInt(env.getEventsSerialized() != null ? env.getEventsSerialized().remaining() : 0);
  out.writeInt(env.getBuffer() != null ? env.getBuffer().size() : 0);
  if (env.getEventsSerialized() != null) {
    out.writeBytes(env.getEventsSerialized());
  }
  if (env.getBuffer() != null) {
    Buffer envBuffer=env.getBuffer();
    out.writeBytes(envBuffer.getMemorySegment().wrap(0,envBuffer.size()));
    envBuffer.recycleBuffer();
  }
}
