{
  final ByteBuffer tmpBuffer=ByteBuffer.allocate(128);
  long bytesWritten=0;
  long diff=this.bufferSize - this.totalBytesWritten;
  if (diff <= 0) {
    return 0;
  }
  while (diff > 0) {
    if (diff < tmpBuffer.remaining()) {
      tmpBuffer.limit(tmpBuffer.position() + (int)diff);
    }
    final long b=readableByteChannel.read(tmpBuffer);
    if (b == 0) {
      break;
    }
    if (b == -1) {
      throw new IOException("Read unexception -1 from stream");
    }
    if (!tmpBuffer.hasRemaining()) {
      tmpBuffer.clear();
    }
    bytesWritten+=b;
    this.totalBytesWritten+=bytesWritten;
    diff=this.bufferSize - this.totalBytesWritten;
  }
  return (int)bytesWritten;
}
