{
  final int magicNumber=GlobalConfiguration.getInteger(MAGICNUMBER_KEY,DEFAULT_MAGICNUMBER);
  final int discoveryPort=GlobalConfiguration.getInteger(DISCOVERYPORT_KEY,DEFAULT_DISCOVERYPORT);
  InetSocketAddress jobManagerAddress=null;
  DatagramSocket socket=null;
  try {
    final Set<InetAddress> targetAddresses=getBroadcastAddresses();
    if (targetAddresses.isEmpty()) {
      throw new DiscoveryException("Could not find any broadcast addresses available to this host");
    }
    socket=new DatagramSocket();
    LOG.debug("Setting socket timeout to " + CLIENTSOCKETTIMEOUT);
    socket.setSoTimeout(CLIENTSOCKETTIMEOUT);
    final DatagramPacket responsePacket=new DatagramPacket(new byte[RESPONSE_PACKET_SIZE],RESPONSE_PACKET_SIZE);
    for (int retries=0; retries < DISCOVERFAILURERETRIES; retries++) {
      final DatagramPacket lookupRequest=createJobManagerLookupRequestPacket(magicNumber);
      for (      InetAddress broadcast : targetAddresses) {
        lookupRequest.setAddress(broadcast);
        lookupRequest.setPort(discoveryPort);
        LOG.debug("Sending discovery request to " + lookupRequest.getSocketAddress());
        socket.send(lookupRequest);
      }
      try {
        socket.receive(responsePacket);
      }
 catch (      SocketTimeoutException ste) {
        LOG.debug("Timeout wainting for discovery reply. Retrying...");
        continue;
      }
      if (!isPacketForUs(responsePacket,magicNumber)) {
        LOG.debug("Received packet which is not destined to this Nephele setup");
        continue;
      }
      final int packetTypeID=getPacketTypeID(responsePacket);
      if (packetTypeID != JM_LOOKUP_REPLY_ID) {
        LOG.debug("Received unexpected packet type " + packetTypeID + ", discarding... ");
        continue;
      }
      final int ipcPort=extractIpcPort(responsePacket);
      if (USE_IPV6) {
        if (responsePacket.getAddress() instanceof Inet6Address) {
          try {
            jobManagerAddress=new InetSocketAddress(InetAddress.getByAddress(responsePacket.getAddress().getAddress()),ipcPort);
          }
 catch (          UnknownHostException e) {
            throw new DiscoveryException(StringUtils.stringifyException(e));
          }
        }
 else {
          throw new DiscoveryException(responsePacket.getAddress() + " is not a valid IPv6 address");
        }
      }
 else {
        jobManagerAddress=new InetSocketAddress(responsePacket.getAddress(),ipcPort);
      }
      LOG.debug("Discovered job manager at " + jobManagerAddress);
      break;
    }
  }
 catch (  IOException ioe) {
    throw new DiscoveryException(ioe.toString());
  }
 finally {
    if (socket != null) {
      socket.close();
    }
  }
  if (jobManagerAddress == null) {
    LOG.debug("Unable to discover Jobmanager via IP broadcast");
    throw new DiscoveryException("Unable to discover JobManager via IP broadcast!");
  }
  return jobManagerAddress;
}
