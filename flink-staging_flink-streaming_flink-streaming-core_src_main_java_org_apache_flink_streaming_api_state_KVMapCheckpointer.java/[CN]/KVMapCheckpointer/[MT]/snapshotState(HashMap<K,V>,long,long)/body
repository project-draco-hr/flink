{
  ByteArrayOutputStream bos=new ByteArrayOutputStream(stateMap.size() * 16);
  DataOutputView out=new OutputViewDataOutputStreamWrapper(new DataOutputStream(bos));
  try {
    out.writeInt(stateMap.size());
    for (    Map.Entry<K,V> kv : stateMap.entrySet()) {
      keySerializer.serialize(kv.getKey(),out);
      valueSerializer.serialize(kv.getValue(),out);
    }
  }
 catch (  IOException e) {
    throw new RuntimeException("Failed to write snapshot",e);
  }
  return bos.toByteArray();
}
