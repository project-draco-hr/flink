{
  if (plan == null) {
    throw new IllegalArgumentException("The plan may not be null.");
  }
  ContextChecker checker=new ContextChecker();
  checker.check(plan);
synchronized (this.lock) {
    final boolean shutDownAtEnd;
    if (this.flink == null) {
      shutDownAtEnd=true;
      if (this.taskManagerNumSlots == DEFAULT_TASK_MANAGER_NUM_SLOTS) {
        int maxParallelism=plan.getMaximumParallelism();
        if (maxParallelism > 0) {
          this.taskManagerNumSlots=maxParallelism;
        }
      }
      start();
    }
 else {
      shutDownAtEnd=false;
    }
    try {
      PactCompiler pc=new PactCompiler(new DataStatistics());
      OptimizedPlan op=pc.compile(plan);
      NepheleJobGraphGenerator jgg=new NepheleJobGraphGenerator();
      JobGraph jobGraph=jgg.compileJobGraph(op);
      ActorRef jobClient=flink.getJobClient();
      return JobClient.submitJobAndWait(jobGraph,printStatusDuringExecution,jobClient,flink.timeout());
    }
  finally {
      if (shutDownAtEnd) {
        stop();
      }
    }
  }
}
