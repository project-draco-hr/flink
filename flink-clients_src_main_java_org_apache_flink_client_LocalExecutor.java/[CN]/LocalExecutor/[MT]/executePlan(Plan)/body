{
  if (plan == null) {
    throw new IllegalArgumentException("The plan may not be null.");
  }
synchronized (this.lock) {
    final boolean shutDownAtEnd;
    if (this.flink == null) {
      shutDownAtEnd=true;
      if (this.taskManagerNumSlots == DEFAULT_TASK_MANAGER_NUM_SLOTS) {
        int maxParallelism=plan.getMaximumParallelism();
        if (maxParallelism > 0) {
          this.taskManagerNumSlots=maxParallelism;
        }
      }
      start();
    }
 else {
      shutDownAtEnd=false;
    }
    try {
      Optimizer pc=new Optimizer(new DataStatistics(),this.flink.getConfiguration());
      OptimizedPlan op=pc.compile(plan);
      JobGraphGenerator jgg=new JobGraphGenerator();
      JobGraph jobGraph=jgg.compileJobGraph(op);
      boolean sysoutPrint=isPrintingStatusDuringExecution();
      SerializedJobExecutionResult result=flink.submitJobAndWait(jobGraph,sysoutPrint);
      return result.toJobExecutionResult(ClassLoader.getSystemClassLoader());
    }
  finally {
      if (shutDownAtEnd) {
        stop();
      }
    }
  }
}
