{
  acquire();
  try {
    Long committed;
    if (subscriptions.assignedPartitions().contains(partition)) {
      committed=this.subscriptions.committed(partition);
      if (committed == null) {
        coordinator.refreshCommittedOffsetsIfNeeded();
        committed=this.subscriptions.committed(partition);
      }
    }
 else {
      Map<TopicPartition,Long> offsets=coordinator.fetchCommittedOffsets(Collections.singleton(partition));
      committed=offsets.get(partition);
    }
    if (committed == null)     throw new NoOffsetForPartitionException("No offset has been committed for partition " + partition);
    return committed;
  }
  finally {
    release();
  }
}
