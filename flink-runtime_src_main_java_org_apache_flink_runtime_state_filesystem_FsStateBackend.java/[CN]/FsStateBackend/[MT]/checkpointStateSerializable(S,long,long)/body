{
  checkFileSystemInitialized();
  Path checkpointDir=createCheckpointDirPath(checkpointID);
  int bufferSize=Math.max(DEFAULT_WRITE_BUFFER_SIZE,fileStateThreshold);
  FsCheckpointStateOutputStream stream=new FsCheckpointStateOutputStream(checkpointDir,filesystem,bufferSize,fileStateThreshold);
  try (ObjectOutputStream os=new ObjectOutputStream(stream)){
    os.writeObject(state);
    return stream.closeAndGetHandle().toSerializableHandle();
  }
 }
