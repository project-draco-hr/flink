{
synchronized (this) {
    if (!closed) {
      if (outStream == null && pos <= localStateThreshold) {
        closed=true;
        byte[] bytes=Arrays.copyOf(writeBuffer,pos);
        return new ByteStreamStateHandle(bytes);
      }
 else {
        flush();
        outStream.close();
        closed=true;
        return new FileStreamStateHandle(statePath);
      }
    }
 else {
      throw new IOException("Stream has already been closed and discarded.");
    }
  }
}
