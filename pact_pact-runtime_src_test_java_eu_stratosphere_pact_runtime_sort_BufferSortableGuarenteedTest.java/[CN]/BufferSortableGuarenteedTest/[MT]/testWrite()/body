{
  AbstractInvokable memOwner=new DummyInvokable();
  MemorySegment memory=memoryManager.allocate(memOwner,MEMORY_SIZE);
  int writtenPairs=0, readPairs=0, position;
{
    TestData.Generator generator=new TestData.Generator(SEED,KEY_MAX,VALUE_LENGTH,KeyMode.SORTED,ValueMode.FIX_LENGTH);
    BufferSortableGuaranteed<TestData.Key,TestData.Value> buffer=newSortBuffer(memory);
    int writtenBytes=0;
    KeyValuePair<TestData.Key,TestData.Value> pair=generator.next();
    while (buffer.write(pair)) {
      writtenBytes+=generator.sizeOf(pair) + Integer.SIZE / 8;
      writtenPairs++;
      pair=generator.next();
    }
    LOG.debug("Written " + writtenPairs + " pairs to buffer which occupied "+ writtenBytes+ " of "+ MEMORY_SIZE+ " bytes.");
    position=buffer.position;
    memory=buffer.unbind();
  }
{
    Buffer.Input buffer=new Buffer.Input(memory);
    buffer.reset(position);
    IntegerRecord rec=new IntegerRecord();
    KeyValuePair<TestData.Key,TestData.Value> pair=new KeyValuePair<TestData.Key,TestData.Value>(new TestData.Key(),new TestData.Value());
    while (buffer.read(rec) && buffer.read(pair)) {
      readPairs++;
    }
    LOG.debug("Read " + readPairs + " pairs from buffer.");
    memory=buffer.dispose();
  }
  Assert.assertEquals(writtenPairs,readPairs);
  memoryManager.release(memory);
}
