{
  Properties kafkaProperties=new Properties();
  int kafkaPort=NetUtils.getAvailablePort();
  kafkaProperties.put("advertised.host.name",kafkaHost);
  kafkaProperties.put("port",Integer.toString(kafkaPort));
  kafkaProperties.put("broker.id",Integer.toString(brokerId));
  kafkaProperties.put("log.dir",tmpFolder.toString());
  kafkaProperties.put("zookeeper.connect",zookeeperConnectionString);
  kafkaProperties.put("message.max.bytes","" + (50 * 1024 * 1024));
  kafkaProperties.put("replica.fetch.max.bytes",String.valueOf(50 * 1024 * 1024));
  kafkaProperties.put("zookeeper.session.timeout.ms","20000");
  KafkaConfig kafkaConfig=new KafkaConfig(kafkaProperties);
  KafkaServer server=new KafkaServer(kafkaConfig,new KafkaLocalSystemTime());
  server.startup();
  return server;
}
