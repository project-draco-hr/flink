{
  File tempDir=new File(ConfigConstants.DEFAULT_TASK_MANAGER_TMP_PATH,UUID.randomUUID().toString());
  try {
    FsStateBackend fileBackend=new FsStateBackend(localFileUri(tempDir));
    DbBackendConfig conf2=new DbBackendConfig("flink","flink","jdbc:derby://localhost:1527/" + tempDir.getAbsolutePath() + "/flinkDB2;create=true");
    conf2.setDbAdapterClass(DerbyAdapter.class);
    DbStateBackend backend=new DbStateBackend(conf,fileBackend);
    DbStateBackend backend2=new DbStateBackend(conf2,fileBackend);
    Environment env=new DummyEnvironment("test",2,0);
    Environment env2=new DummyEnvironment("test",2,1);
    backend.initializeForJob(env);
    backend2.initializeForJob(env2);
    LazyDbKvState<Integer,String> kv=backend.createKvState(1,"state1",IntSerializer.INSTANCE,StringSerializer.INSTANCE,null);
    String tableName="kvstate_" + env.getJobID() + "_1_state1";
    assertTrue(isTableCreated(backend.getConnection(),tableName));
    assertEquals(0,kv.size());
    kv.setCurrentKey(1);
    assertNull(kv.value());
    kv.update("1");
    assertEquals(1,kv.size());
    kv.setCurrentKey(2);
    assertNull(kv.value());
    kv.update("2");
    assertEquals(2,kv.size());
    kv.setCurrentKey(1);
    assertEquals("1",kv.value());
    assertEquals(2,kv.size());
    kv.shapshot(682375462378L,100);
    kv.setCurrentKey(1);
    kv.update("u1");
    kv.setCurrentKey(2);
    kv.update("u2");
    kv.setCurrentKey(3);
    kv.update("u3");
    assertTrue(containsKey(backend.getConnection(),tableName,1,1));
    kv.notifyCheckpointComplete(682375462378L);
    KvStateSnapshot<Integer,String,DbStateBackend> snapshot2=kv.shapshot(682375462379L,200);
    assertTrue(containsKey(backend.getConnection(),tableName,1,1));
    assertTrue(containsKey(backend.getConnection(),tableName,1,682375462379L));
    kv.notifyCheckpointComplete(682375462379L);
    assertFalse(containsKey(backend.getConnection(),tableName,1,1));
    assertTrue(containsKey(backend.getConnection(),tableName,1,682375462379L));
    assertEquals(3,kv.size());
    kv.setCurrentKey(1);
    assertEquals("u1",kv.value());
    kv.setCurrentKey(2);
    assertEquals("u2",kv.value());
    kv.setCurrentKey(3);
    assertEquals("u3",kv.value());
    KvState<Integer,String,DbStateBackend> restored2=snapshot2.restoreState(backend,IntSerializer.INSTANCE,StringSerializer.INSTANCE,null,getClass().getClassLoader(),6823754623710L);
    assertEquals(0,restored2.size());
    restored2.setCurrentKey(1);
    assertEquals("u1",restored2.value());
    restored2.setCurrentKey(2);
    assertEquals("u2",restored2.value());
    restored2.setCurrentKey(3);
    assertEquals("u3",restored2.value());
    LazyDbKvState<Integer,String> kv2=backend2.createKvState(1,"state2",IntSerializer.INSTANCE,StringSerializer.INSTANCE,"a");
    kv2.setCurrentKey(1);
    kv2.update("c");
    assertEquals("c",kv2.value());
    kv2.update(null);
    assertEquals("a",kv2.value());
    KvStateSnapshot<Integer,String,DbStateBackend> snapshot3=kv2.shapshot(682375462380L,400);
    kv2.notifyCheckpointComplete(682375462380L);
    try {
      snapshot3.restoreState(backend,IntSerializer.INSTANCE,StringSerializer.INSTANCE,"a",getClass().getClassLoader(),System.currentTimeMillis());
      fail();
    }
 catch (    IOException e) {
    }
    backend.close();
    backend2.close();
  }
  finally {
    deleteDirectorySilently(tempDir);
  }
}
