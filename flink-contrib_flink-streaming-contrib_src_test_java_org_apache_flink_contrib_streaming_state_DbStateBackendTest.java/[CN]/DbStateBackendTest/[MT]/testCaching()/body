{
  List<String> urls=Lists.newArrayList(url1,url2);
  DbBackendConfig conf=new DbBackendConfig("flink","flink",urls);
  conf.setDbAdapter(new DerbyAdapter());
  conf.setKvCacheSize(3);
  conf.setMaxKvInsertBatchSize(2);
  conf.setMaxKvCacheEvictFraction(0.6f);
  DbStateBackend backend=new DbStateBackend(conf);
  Environment env=new DummyEnvironment("test",2,0);
  String tableName="dummy_test_caching_state1";
  assertFalse(isTableCreated(DriverManager.getConnection(url1,"flink","flink"),tableName));
  assertFalse(isTableCreated(DriverManager.getConnection(url2,"flink","flink"),tableName));
  backend.initializeForJob(env,"dummy_test_caching",IntSerializer.INSTANCE);
  ValueState<String> state=backend.createValueState(IntSerializer.INSTANCE,new ValueStateDescriptor<>("state1",StringSerializer.INSTANCE,"a"));
  LazyDbValueState<Integer,Integer,String> kv=(LazyDbValueState<Integer,Integer,String>)state;
  assertTrue(isTableCreated(DriverManager.getConnection(url1,"flink","flink"),tableName));
  assertTrue(isTableCreated(DriverManager.getConnection(url2,"flink","flink"),tableName));
  Map<Tuple2<Integer,Integer>,Optional<String>> cache=kv.getStateCache();
  Map<Tuple2<Integer,Integer>,Optional<String>> modified=kv.getModified();
  assertEquals(0,kv.size());
  kv.setCurrentNamespace(1);
  kv.setCurrentKey(1);
  assertEquals("a",kv.value());
  kv.update(null);
  assertEquals(1,kv.size());
  kv.setCurrentKey(2);
  assertEquals("a",kv.value());
  kv.update("2");
  assertEquals(2,kv.size());
  assertEquals("2",kv.value());
  kv.setCurrentKey(1);
  assertEquals("a",kv.value());
  kv.setCurrentKey(3);
  kv.update("3");
  assertEquals("3",kv.value());
  assertTrue(modified.containsKey(Tuple2.of(1,1)));
  assertTrue(modified.containsKey(Tuple2.of(2,1)));
  assertTrue(modified.containsKey(Tuple2.of(3,1)));
  kv.setCurrentKey(4);
  kv.update("4");
  assertEquals("4",kv.value());
  assertFalse(modified.containsKey(Tuple2.of(1,1)));
  assertFalse(modified.containsKey(Tuple2.of(2,1)));
  assertTrue(modified.containsKey(Tuple2.of(3,1)));
  assertTrue(modified.containsKey(Tuple2.of(4,1)));
  assertEquals(Optional.of("3"),cache.get(Tuple2.of(3,1)));
  assertEquals(Optional.of("4"),cache.get(Tuple2.of(4,1)));
  assertFalse(cache.containsKey(Tuple2.of(1,1)));
  assertFalse(cache.containsKey(Tuple2.of(2,1)));
  kv.snapshot(682375462378L,100);
  assertTrue(modified.isEmpty());
  kv.setCurrentKey(2);
  assertEquals("2",kv.value());
  kv.update(null);
  assertEquals("a",kv.value());
  assertTrue(modified.containsKey(Tuple2.of(2,1)));
  assertEquals(1,modified.size());
  assertEquals(Optional.of("3"),cache.get(Tuple2.of(3,1)));
  assertEquals(Optional.of("4"),cache.get(Tuple2.of(4,1)));
  assertEquals(Optional.absent(),cache.get(Tuple2.of(2,1)));
  assertFalse(cache.containsKey(Tuple2.of(1,1)));
  assertTrue(modified.containsKey(Tuple2.of(2,1)));
  assertFalse(modified.containsKey(Tuple2.of(3,1)));
  assertFalse(modified.containsKey(Tuple2.of(4,1)));
  assertTrue(cache.containsKey(Tuple2.of(3,1)));
  assertTrue(cache.containsKey(Tuple2.of(4,1)));
  kv.setCurrentKey(5);
  kv.value();
  kv.setCurrentKey(6);
  kv.value();
  kv.setCurrentKey(7);
  kv.value();
  assertFalse(modified.containsKey(Tuple2.of(5,1)));
  assertTrue(modified.containsKey(Tuple2.of(6,1)));
  assertTrue(modified.containsKey(Tuple2.of(7,1)));
  assertFalse(cache.containsKey(Tuple2.of(1,1)));
  assertFalse(cache.containsKey(Tuple2.of(2,1)));
  assertFalse(cache.containsKey(Tuple2.of(3,1)));
  assertFalse(cache.containsKey(Tuple2.of(4,1)));
  kv.setCurrentKey(2);
  assertEquals("a",kv.value());
  long checkpointTs=System.currentTimeMillis();
  KvStateSnapshot<Integer,Integer,ValueState<String>,ValueStateDescriptor<String>,DbStateBackend> snapshot1=kv.snapshot(682375462379L,checkpointTs);
  assertTrue(modified.isEmpty());
  kv.setCurrentKey(1);
  kv.update("123");
  kv.setCurrentKey(3);
  kv.update("456");
  kv.setCurrentKey(2);
  kv.notifyCheckpointComplete(682375462379L);
  kv.update("2");
  kv.setCurrentKey(4);
  kv.update("4");
  kv.update("5");
  kv.snapshot(6823754623710L,checkpointTs + 10);
  KvState<Integer,Integer,ValueState<String>,ValueStateDescriptor<String>,DbStateBackend> restored=snapshot1.restoreState(backend,IntSerializer.INSTANCE,getClass().getClassLoader(),6823754623711L);
  LazyDbValueState<Integer,Integer,String> lazyRestored=(LazyDbValueState<Integer,Integer,String>)restored;
  cache=lazyRestored.getStateCache();
  modified=lazyRestored.getModified();
  restored.setCurrentNamespace(1);
  @SuppressWarnings("unchecked") ValueState<String> restoredState=(ValueState<String>)restored;
  restored.setCurrentKey(1);
  assertEquals("a",restoredState.value());
  assertEquals(cache.get(Tuple2.of(1,1)),Optional.<String>absent());
  restored.setCurrentKey(2);
  assertEquals("a",restoredState.value());
  assertEquals(cache.get(Tuple2.of(2,1)),Optional.<String>absent());
  restored.setCurrentKey(3);
  assertEquals("3",restoredState.value());
  restored.setCurrentKey(4);
  assertEquals("4",restoredState.value());
  backend.close();
}
