{
  Object key=keySelector.getKey(element);
  OUT accumulator=values.get(key);
  FoldFunction<IN,OUT> folder=((FoldFunction<IN,OUT>)userFunction);
  if (accumulator != null) {
    OUT folded=folder.fold(outTypeSerializer.copy(accumulator),element);
    values.put(key,folded);
    output.collect(folded);
  }
 else {
    OUT first=folder.fold(outTypeSerializer.copy(initialValue),element);
    values.put(key,first);
    output.collect(first);
  }
}
