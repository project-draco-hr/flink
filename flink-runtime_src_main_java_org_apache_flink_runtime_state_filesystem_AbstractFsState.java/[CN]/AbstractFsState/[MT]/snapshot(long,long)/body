{
  try (FsStateBackend.FsCheckpointStateOutputStream out=backend.createCheckpointStateOutputStream(checkpointId,timestamp)){
    DataOutputViewStreamWrapper outView=new DataOutputViewStreamWrapper(new DataOutputStream(out));
    outView.writeInt(state.size());
    for (    Map.Entry<N,Map<K,SV>> namespaceState : state.entrySet()) {
      N namespace=namespaceState.getKey();
      namespaceSerializer.serialize(namespace,outView);
      outView.writeInt(namespaceState.getValue().size());
      for (      Map.Entry<K,SV> entry : namespaceState.getValue().entrySet()) {
        keySerializer.serialize(entry.getKey(),outView);
        stateSerializer.serialize(entry.getValue(),outView);
      }
    }
    outView.flush();
    return createHeapSnapshot(out.closeAndGetPath());
  }
 }
