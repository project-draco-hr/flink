{
  this.sumOfTimeStamps+=durationOfLastBufferTransfer;
  if (this.sumOfTimeStamps < GRANULARITY) {
    this.sumOfBufferSizes+=sizeOfLastUncompressedBuffer;
    this.sumOfTransferDurations+=durationOfLastBufferTransfer;
  }
 else {
    final double currentDataRate=(double)this.sumOfBufferSizes / ((double)this.sumOfTransferDurations * 128.0f);
    if (this.lastDataRate < 0.0f) {
      this.lastDataRate=currentDataRate;
    }
    final int nextCompressionLevel=selectNextCompressionLevel(currentDataRate);
    final int diff=nextCompressionLevel - this.currentSelection;
    if (diff > 0) {
      this.increasedCompressionLevel=true;
    }
 else     if (diff < 0) {
      this.increasedCompressionLevel=false;
    }
    this.currentSelection=nextCompressionLevel;
    this.lastDataRate=currentDataRate;
    this.sumOfBufferSizes=0;
    this.sumOfTransferDurations=0;
    this.sumOfTimeStamps=0;
  }
  return this.currentSelection;
}
