{
  if (applicationClient == null) {
    LeaderRetrievalService leaderRetrievalService;
    try {
      leaderRetrievalService=LeaderRetrievalUtils.createLeaderRetrievalService(flinkConfig);
    }
 catch (    Exception e) {
      throw new RuntimeException("Could not create the leader retrieval service.",e);
    }
    LOG.info("Start application client.");
    applicationClient=actorSystemLoader.get().actorOf(Props.create(ApplicationClient.class,flinkConfig,leaderRetrievalService),"applicationClient");
    if (perJobCluster) {
      logAndSysout("Waiting until all TaskManagers have connected");
      for (GetClusterStatusResponse currentStatus, lastStatus=null; ; lastStatus=currentStatus) {
        currentStatus=getClusterStatus();
        if (currentStatus != null && !currentStatus.equals(lastStatus)) {
          logAndSysout("TaskManager status (" + currentStatus.numRegisteredTaskManagers() + "/"+ clusterDescriptor.getTaskManagerCount()+ ")");
          if (currentStatus.numRegisteredTaskManagers() >= clusterDescriptor.getTaskManagerCount()) {
            logAndSysout("All TaskManagers are connected");
            break;
          }
        }
 else         if (lastStatus == null) {
          logAndSysout("No status updates from the YARN cluster received so far. Waiting ...");
        }
        try {
          Thread.sleep(250);
        }
 catch (        InterruptedException e) {
          LOG.error("Interrupted while waiting for TaskManagers");
          throw new RuntimeException("Interrupted while waiting for TaskManagers",e);
        }
      }
    }
  }
  return applicationClient;
}
