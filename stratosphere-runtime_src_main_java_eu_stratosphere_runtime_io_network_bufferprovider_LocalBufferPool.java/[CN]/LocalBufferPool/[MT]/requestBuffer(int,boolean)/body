{
  if (minBufferSize > this.bufferSize) {
    throw new IllegalArgumentException(String.format("Too large buffer requested (requested %d, maximum %d).",minBufferSize,this.bufferSize));
  }
  while (true) {
    boolean isAsyncRequest=false;
synchronized (this.buffers) {
      while (this.numRequestedBuffers > this.numDesignatedBuffers) {
        final MemorySegment buffer=this.buffers.poll();
        if (buffer == null) {
          break;
        }
        this.globalBufferPool.returnBuffer(buffer);
        this.numRequestedBuffers--;
      }
      while (this.buffers.isEmpty()) {
        if (this.numRequestedBuffers < this.numDesignatedBuffers) {
          final MemorySegment buffer=this.globalBufferPool.requestBuffer();
          if (buffer != null) {
            this.buffers.add(buffer);
            this.numRequestedBuffers++;
            continue;
          }
        }
        if (this.hasAsyncEventOccurred && isBlocking) {
          this.hasAsyncEventOccurred=false;
          isAsyncRequest=true;
          break;
        }
        if (isBlocking) {
          this.buffers.wait(WAIT_TIME);
        }
 else {
          return null;
        }
      }
      if (!isAsyncRequest) {
        return new Buffer(this.buffers.poll(),minBufferSize,this.recycler);
      }
    }
  }
}
