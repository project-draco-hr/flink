{
  Thread.currentThread().setContextClassLoader(prog.getUserCodeClassLoader());
  if (prog.isUsingProgramEntryPoint()) {
    return run(prog.getPlanWithJars(),parallelism,wait);
  }
 else   if (prog.isUsingInteractiveMode()) {
    ContextEnvironment.setAsContext(this,prog.getAllLibraries(),prog.getUserCodeClassLoader(),parallelism);
    ContextEnvironment.enableLocalExecution(false);
    if (wait) {
      try {
        prog.invokeInteractiveModeForExecution();
      }
  finally {
        ContextEnvironment.enableLocalExecution(true);
      }
    }
 else {
      Thread backGroundRunner=new Thread("Program Runner"){
        public void run(){
          try {
            prog.invokeInteractiveModeForExecution();
          }
 catch (          Throwable t) {
            LOG.error("The program execution failed.",t);
          }
 finally {
            ContextEnvironment.enableLocalExecution(true);
          }
        }
      }
;
      backGroundRunner.start();
    }
    return null;
  }
 else {
    throw new RuntimeException();
  }
}
