{
  Thread.currentThread().setContextClassLoader(prog.getUserCodeClassLoader());
  if (prog.isUsingProgramEntryPoint()) {
    return runDetached(prog.getPlanWithJars(),parallelism);
  }
 else   if (prog.isUsingInteractiveMode()) {
    LOG.info("Starting program in interactive mode");
    ContextEnvironmentFactory factory=new ContextEnvironmentFactory(this,prog.getAllLibraries(),prog.getClasspaths(),prog.getUserCodeClassLoader(),parallelism,false);
    ContextEnvironment.setAsContext(factory);
    try {
      prog.invokeInteractiveModeForExecution();
      return ((DetachedEnvironment)factory.getLastEnvCreated()).finalizeExecute();
    }
  finally {
      ContextEnvironment.unsetContext();
    }
  }
 else {
    throw new RuntimeException("PackagedProgram does not have a valid invocation mode.");
  }
}
