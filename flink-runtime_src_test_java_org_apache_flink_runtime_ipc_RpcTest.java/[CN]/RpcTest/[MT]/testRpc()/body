{
  try {
    Server server=null;
    TestProtocol proxy=null;
    try {
      int port=getAvailablePort();
      server=RPC.getServer(new TestProtocolImpl(),"localhost",port,4);
      server.start();
      proxy=RPC.getProxy(TestProtocol.class,new InetSocketAddress("localhost",port),NetUtils.getSocketFactory());
      assertEquals(19,proxy.methodWithPrimitives(16,new StringValue("abc")));
      assertEquals(new DoubleValue(17.0),proxy.methodWithWritables(new LongValue(17)));
    }
  finally {
      if (proxy != null) {
        RPC.stopProxy(proxy);
      }
      if (server != null) {
        server.stop();
      }
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.getMessage());
  }
}
