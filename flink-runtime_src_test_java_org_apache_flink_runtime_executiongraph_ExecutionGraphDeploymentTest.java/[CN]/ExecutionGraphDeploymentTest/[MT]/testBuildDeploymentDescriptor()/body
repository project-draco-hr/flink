{
  try {
    TestingUtils.setCallingThreadDispatcher(system);
    final JobID jobId=new JobID();
    final JobVertexID jid1=new JobVertexID();
    final JobVertexID jid2=new JobVertexID();
    final JobVertexID jid3=new JobVertexID();
    final JobVertexID jid4=new JobVertexID();
    AbstractJobVertex v1=new AbstractJobVertex("v1",jid1);
    AbstractJobVertex v2=new AbstractJobVertex("v2",jid2);
    AbstractJobVertex v3=new AbstractJobVertex("v3",jid3);
    AbstractJobVertex v4=new AbstractJobVertex("v4",jid4);
    v1.setParallelism(10);
    v2.setParallelism(10);
    v3.setParallelism(10);
    v4.setParallelism(10);
    v1.setInvokableClass(RegularPactTask.class);
    v2.setInvokableClass(RegularPactTask.class);
    v3.setInvokableClass(RegularPactTask.class);
    v4.setInvokableClass(RegularPactTask.class);
    v2.connectNewDataSetAsInput(v1,DistributionPattern.ALL_TO_ALL);
    v3.connectNewDataSetAsInput(v2,DistributionPattern.ALL_TO_ALL);
    v4.connectNewDataSetAsInput(v2,DistributionPattern.ALL_TO_ALL);
    ExecutionGraph eg=new ExecutionGraph(jobId,"some job",new Configuration(),AkkaUtils.getDefaultTimeout());
    List<AbstractJobVertex> ordered=Arrays.asList(v1,v2,v3,v4);
    eg.attachJobGraph(ordered);
    ExecutionJobVertex ejv=eg.getAllVertices().get(jid2);
    ExecutionVertex vertex=ejv.getTaskVertices()[3];
    final TestActorRef<? extends Actor> simpleTaskManager=TestActorRef.create(system,Props.create(ExecutionGraphTestUtils.SimpleAcknowledgingTaskManager.class));
    ExecutionGraphTestUtils.SimpleAcknowledgingTaskManager tm=(ExecutionGraphTestUtils.SimpleAcknowledgingTaskManager)simpleTaskManager.underlyingActor();
    final Instance instance=getInstance(simpleTaskManager);
    final SimpleSlot slot=instance.allocateSimpleSlot(jobId);
    assertEquals(ExecutionState.CREATED,vertex.getExecutionState());
    vertex.deployToSlot(slot);
    assertEquals(ExecutionState.DEPLOYING,vertex.getExecutionState());
    TaskDeploymentDescriptor descr=tm.lastTDD;
    assertNotNull(descr);
    assertEquals(jobId,descr.getJobID());
    assertEquals(jid2,descr.getVertexID());
    assertEquals(3,descr.getIndexInSubtaskGroup());
    assertEquals(10,descr.getNumberOfSubtasks());
    assertEquals(RegularPactTask.class.getName(),descr.getInvokableClassName());
    assertEquals("v2",descr.getTaskName());
    List<ResultPartitionDeploymentDescriptor> producedPartitions=descr.getProducedPartitions();
    List<InputGateDeploymentDescriptor> consumedPartitions=descr.getInputGates();
    assertEquals(2,producedPartitions.size());
    assertEquals(1,consumedPartitions.size());
    assertEquals(10,producedPartitions.get(0).getNumberOfSubpartitions());
    assertEquals(10,producedPartitions.get(1).getNumberOfSubpartitions());
    assertEquals(10,consumedPartitions.get(0).getInputChannelDeploymentDescriptors().length);
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.getMessage());
  }
 finally {
    TestingUtils.setGlobalExecutionContext();
  }
}
