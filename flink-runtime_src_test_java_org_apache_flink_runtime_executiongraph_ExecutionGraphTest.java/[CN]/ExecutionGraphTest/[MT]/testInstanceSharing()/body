{
  final int degreeOfParallelism=4;
  File inputFile1=null;
  File outputFile1=null;
  JobID jobID=null;
  try {
    inputFile1=ServerTestUtils.createInputFile(0);
    outputFile1=new File(ServerTestUtils.getRandomFilename());
    final JobGraph jg=new JobGraph("Instance Sharing Test Job");
    jobID=jg.getJobID();
    final JobInputVertex input1=new JobInputVertex("Input 1",jg);
    input1.setInvokableClass(DataSourceTask.class);
    input1.setInputFormat(new TextInputFormat(new Path(inputFile1.toURI())));
    input1.setNumberOfSubtasks(degreeOfParallelism);
    final JobTaskVertex forward1=new JobTaskVertex("Forward 1",jg);
    forward1.setInvokableClass(ForwardTask1Input1Output.class);
    forward1.setNumberOfSubtasks(degreeOfParallelism);
    final JobTaskVertex forward2=new JobTaskVertex("Forward 2",jg);
    forward2.setInvokableClass(ForwardTask1Input1Output.class);
    forward2.setNumberOfSubtasks(degreeOfParallelism);
    final JobTaskVertex forward3=new JobTaskVertex("Forward 3",jg);
    forward3.setInvokableClass(ForwardTask1Input1Output.class);
    forward3.setNumberOfSubtasks(degreeOfParallelism);
    final JobOutputVertex output1=new JobOutputVertex("Output 1",jg);
    output1.setInvokableClass(DataSinkTask.class);
    output1.setOutputFormat(new DiscardingOuputFormat<Object>());
    output1.setNumberOfSubtasks(degreeOfParallelism);
    input1.connectTo(forward1,ChannelType.IN_MEMORY,DistributionPattern.POINTWISE);
    forward1.connectTo(forward2,ChannelType.IN_MEMORY,DistributionPattern.POINTWISE);
    forward2.connectTo(forward3,ChannelType.NETWORK,DistributionPattern.POINTWISE);
    forward3.connectTo(output1,ChannelType.IN_MEMORY);
    input1.setVertexToShareInstancesWith(forward1);
    forward1.setVertexToShareInstancesWith(forward2);
    forward2.setVertexToShareInstancesWith(forward3);
    forward3.setVertexToShareInstancesWith(output1);
    LibraryCacheManager.register(jobID,new String[0]);
    final ExecutionGraph eg=new ExecutionGraph(jg,1);
    assertEquals(1,eg.getNumberOfStages());
    final ExecutionStage stage=eg.getStage(0);
    assertEquals(5,stage.getNumberOfStageMembers());
    final int numberOfRequiredSlots=stage.getMaxNumberSubtasks();
    assertEquals(degreeOfParallelism,numberOfRequiredSlots);
  }
 catch (  GraphConversionException e) {
    fail(e.getMessage());
  }
catch (  JobGraphDefinitionException e) {
    fail(e.getMessage());
  }
catch (  IOException ioe) {
    fail(ioe.getMessage());
  }
 finally {
    if (inputFile1 != null) {
      inputFile1.delete();
    }
    if (outputFile1 != null) {
      outputFile1.delete();
    }
    if (jobID != null) {
      try {
        LibraryCacheManager.unregister(jobID);
      }
 catch (      IOException e) {
      }
    }
  }
}
