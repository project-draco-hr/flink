{
  final OutputStream os=this.socket.getOutputStream();
  final MessageDigest md=(jobId == null || key == null) ? BlobUtils.createMessageDigest() : null;
  final byte[] buf=new byte[AbstractID.SIZE];
  final byte[] xferBuf=new byte[BlobServer.BUFFER_SIZE];
  sendPutHeader(os,jobId,key,buf);
  while (true) {
    final int read=inputStream.read(xferBuf);
    if (read < 0) {
      break;
    }
    if (read > 0) {
      BlobServer.writeLength(read,buf,os);
      os.write(xferBuf,0,read);
      if (md != null) {
        md.update(xferBuf,0,read);
      }
    }
  }
  if (md == null) {
    return null;
  }
  final InputStream is=this.socket.getInputStream();
  final BlobKey localKey=new BlobKey(md.digest());
  final BlobKey remoteKey=BlobKey.readFromInputStream(is);
  if (!localKey.equals(remoteKey)) {
    throw new IOException("Detected data corruption during transfer");
  }
  return localKey;
}
