{
  int degreeOfParallelism=2;
  JobGraph jobGraph=new JobGraph("PageRank");
  JobInputVertex pageWithRankInput=JobGraphUtils.createInput(PageWithRankInputFormat.class,"file://" + PlayConstants.PLAY_DIR + "test-inputs/pagerank/pageWithRank","PageWithRankInput",jobGraph,degreeOfParallelism);
  JobInputVertex transitionMatrixInput=JobGraphUtils.createInput(TransitionMatrixInputFormat.class,"file://" + PlayConstants.PLAY_DIR + "test-inputs/pagerank/transitionMatrix","TransitionMatrixInput",jobGraph,degreeOfParallelism);
  TaskConfig transitionMatrixInputConfig=new TaskConfig(transitionMatrixInput.getConfiguration());
  transitionMatrixInputConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(transitionMatrixInput.getConfiguration(),"pact.out.param.0.",new int[]{1},new Class[]{PactLong.class});
  JobTaskVertex head=JobGraphUtils.createTask(BulkIterationHeadPactTask.class,"BulkIterationHead",jobGraph,degreeOfParallelism);
  TaskConfig headConfig=new TaskConfig(head.getConfiguration());
  headConfig.setDriver(MapDriver.class);
  headConfig.setStubClass(IdentityMap.class);
  headConfig.setMemorySize(3 * JobGraphUtils.MEGABYTE);
  headConfig.setBackChannelMemoryFraction(0.8f);
  headConfig.setNumberOfIterations(15);
  JobTaskVertex intermediate=JobGraphUtils.createTask(BulkIterationIntermediatePactTask.class,"BulkIterationIntermediate",jobGraph,degreeOfParallelism);
  TaskConfig intermediateConfig=new TaskConfig(intermediate.getConfiguration());
  intermediateConfig.setDriver(MatchDriver.class);
  intermediateConfig.setStubClass(DotProductMatch.class);
  intermediateConfig.setLocalStrategy(TaskConfig.LocalStrategy.HYBRIDHASH_FIRST);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateConfig.getConfiguration(),"pact.in.param.0.",new int[]{0},new Class[]{PactLong.class});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateConfig.getConfiguration(),"pact.in.param.1.",new int[]{0},new Class[]{PactLong.class});
  intermediateConfig.setMemorySize(20 * JobGraphUtils.MEGABYTE);
  intermediateConfig.setGateCached(1);
  intermediateConfig.setInputGateCacheMemoryFraction(0.5f);
  JobTaskVertex tail=JobGraphUtils.createTask(BulkIterationTailPactTask.class,"BulkIterationTail",jobGraph,degreeOfParallelism);
  TaskConfig tailConfig=new TaskConfig(tail.getConfiguration());
  tailConfig.setLocalStrategy(TaskConfig.LocalStrategy.SORT);
  tailConfig.setDriver(ReduceDriver.class);
  tailConfig.setStubClass(DotProductReducer.class);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(tail.getConfiguration(),"pact.in.param.0.",new int[]{0},new Class[]{PactLong.class});
  tailConfig.setMemorySize(3 * JobGraphUtils.MEGABYTE);
  tailConfig.setNumFilehandles(2);
  JobOutputVertex sync=JobGraphUtils.createSync(jobGraph,degreeOfParallelism);
  JobOutputVertex output=JobGraphUtils.createFileOutput(jobGraph,"FinalOutput",degreeOfParallelism);
  TaskConfig outputConfig=new TaskConfig(output.getConfiguration());
  outputConfig.setStubClass(PageWithRankOutFormat.class);
  outputConfig.setStubParameter(FileOutputFormat.FILE_PARAMETER_KEY,"file:///tmp/stratosphere/iterations");
  JobOutputVertex fakeTailOutput=JobGraphUtils.createFakeOutput(jobGraph,"FakeTailOutput",degreeOfParallelism);
  JobGraphUtils.connectLocal(pageWithRankInput,head);
  JobGraphUtils.connectLocal(head,intermediate,DistributionPattern.BIPARTITE,ShipStrategy.BROADCAST);
  JobGraphUtils.connectLocal(transitionMatrixInput,intermediate,DistributionPattern.BIPARTITE,ShipStrategy.PARTITION_HASH);
  intermediateConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,degreeOfParallelism);
  JobGraphUtils.connectLocal(intermediate,tail,DistributionPattern.POINTWISE,ShipStrategy.FORWARD);
  tailConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,1);
  JobGraphUtils.connectLocal(head,sync);
  JobGraphUtils.connectLocal(head,output);
  JobGraphUtils.connectLocal(tail,fakeTailOutput);
  fakeTailOutput.setVertexToShareInstancesWith(tail);
  tail.setVertexToShareInstancesWith(head);
  pageWithRankInput.setVertexToShareInstancesWith(head);
  transitionMatrixInput.setVertexToShareInstancesWith(head);
  intermediate.setVertexToShareInstancesWith(head);
  output.setVertexToShareInstancesWith(head);
  sync.setVertexToShareInstancesWith(head);
  GlobalConfiguration.loadConfiguration(PlayConstants.PLAY_DIR + "local-conf");
  Configuration conf=GlobalConfiguration.getConfiguration();
  JobGraphUtils.submit(jobGraph,conf);
}
