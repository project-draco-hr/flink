{
  final Buffer buffer=TestBufferFactory.createBuffer(32);
  BufferProvider bufferProvider=createBufferProvider(buffer);
  ResultPartitionWriter partitionWriter=createResultPartitionWriter(bufferProvider);
  doThrow(new IOException("Expected test exception")).when(partitionWriter).writeBuffer(eq(buffer),eq(0));
  RecordWriter<IntValue> recordWriter=new RecordWriter<IntValue>(partitionWriter);
  try {
    recordWriter.emit(new IntValue(0));
    verify(bufferProvider,times(1)).requestBufferBlocking();
    verify(partitionWriter,never()).writeBuffer(any(Buffer.class),anyInt());
    recordWriter.flush();
    fail("Did not throw expected Exception. This means that the record " + "writer did not request a buffer as expected.");
  }
 catch (  IOException expected) {
  }
  verify(partitionWriter,times(1)).writeBuffer(any(Buffer.class),anyInt());
  recordWriter.clearBuffers();
  assertTrue("Buffer not recycled.",buffer.isRecycled());
}
