{
  boolean releaseNettyBuffer=true;
  try {
    if (bufferOrEvent.isBuffer()) {
      BufferProvider bufferProvider=inputChannel.getBufferProvider();
      if (bufferProvider == null) {
        return false;
      }
      while (true) {
        Buffer buffer=bufferProvider.requestBuffer();
        if (buffer != null) {
          buffer.setSize(bufferOrEvent.getSize());
          bufferOrEvent.getNettyBuffer().readBytes(buffer.getNioBuffer());
          inputChannel.onBuffer(buffer,bufferOrEvent.sequenceNumber);
          return true;
        }
 else         if (bufferListener.waitForBuffer(bufferProvider,bufferOrEvent)) {
          releaseNettyBuffer=false;
          return false;
        }
 else         if (bufferProvider.isDestroyed()) {
          return false;
        }
      }
    }
 else {
      byte[] byteArray=new byte[bufferOrEvent.getSize()];
      bufferOrEvent.getNettyBuffer().readBytes(byteArray);
      Buffer buffer=new Buffer(new MemorySegment(byteArray),EventSerializer.RECYCLER,false);
      inputChannel.onBuffer(buffer,bufferOrEvent.sequenceNumber);
      return true;
    }
  }
  finally {
    if (releaseNettyBuffer) {
      bufferOrEvent.releaseBuffer();
    }
  }
}
