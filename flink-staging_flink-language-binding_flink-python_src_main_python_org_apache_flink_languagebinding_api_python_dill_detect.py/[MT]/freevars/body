def freevars(func):
    'get objects defined in enclosing code that are referred to by func\n\n    returns a dict of {name:object}'
    if PY3:
        im_func = '__func__'
        func_code = '__code__'
        func_closure = '__closure__'
    else:
        im_func = 'im_func'
        func_code = 'func_code'
        func_closure = 'func_closure'
    if ismethod(func):
        func = getattr(func, im_func)
    if isfunction(func):
        closures = (getattr(func, func_closure) or ())
        func = getattr(func, func_code).co_freevars
    else:
        return {}
    return dict(((name, c.cell_contents) for (name, c) in zip(func, closures)))
