{
  final Object entry=outConnections.get(receiver);
  final OutboundConnectionQueue channel;
  if (entry != null) {
    if (entry instanceof OutboundConnectionQueue) {
      channel=(OutboundConnectionQueue)entry;
    }
 else {
      ChannelInBuildup future=(ChannelInBuildup)entry;
      channel=future.waitForChannel();
    }
  }
 else {
    ChannelInBuildup inBuildup=new ChannelInBuildup(out,receiver,this,closeAfterIdleForMs);
    Object old=outConnections.putIfAbsent(receiver,inBuildup);
    if (old == null) {
      out.connect(receiver.getConnectionAddress()).addListener(inBuildup);
      channel=inBuildup.waitForChannel();
      Object previous=outConnections.put(receiver,channel);
      if (inBuildup != previous) {
        throw new IOException("Race condition during channel build up.");
      }
    }
 else     if (old instanceof ChannelInBuildup) {
      channel=((ChannelInBuildup)old).waitForChannel();
    }
 else {
      channel=(OutboundConnectionQueue)old;
    }
  }
  if (!channel.enqueue(envelope)) {
    LOG.debug("Retry enqueue on channel: " + channel + ".");
    enqueue(envelope,receiver);
  }
}
