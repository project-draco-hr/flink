{
  if (LOG.isDebugEnabled())   LOG.debug("Available memory per instance: " + memoryPerInstance);
  this.memoryPerInstance=memoryPerInstance;
  this.memoryConsumers=0;
  for (  SinkPlanNode node : sinks) {
    node.accept(this);
  }
  if (this.memoryConsumers > 0) {
    final int memoryPerTask=this.memoryPerInstance / this.memoryConsumers;
    if (LOG.isDebugEnabled())     LOG.debug("Memory per consumer: " + memoryPerTask);
    for (    PlanNode node : this.allNodes) {
      final int consumerCount=node.getMemoryConsumerCount();
      if (consumerCount > 0) {
        node.setMemoryPerTask(memoryPerTask * consumerCount);
        if (LOG.isDebugEnabled())         LOG.debug("Assigned " + (memoryPerTask * consumerCount) + " MB to "+ node.getPactContract().getName());
      }
    }
  }
  return new OptimizedPlan(this.sources,this.sinks,this.allNodes,jobName);
}
