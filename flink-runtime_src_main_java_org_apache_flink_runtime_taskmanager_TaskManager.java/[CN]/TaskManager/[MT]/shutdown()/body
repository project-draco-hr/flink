{
  if (!this.shutdownStarted.compareAndSet(false,true)) {
    return;
  }
  LOG.info("Shutting down TaskManager");
  cancelAndClearEverything(new Exception("Task Manager is shutting down"));
  this.heartbeatThread.interrupt();
  try {
    this.heartbeatThread.join(1000);
  }
 catch (  InterruptedException e) {
  }
  this.registeredId=null;
  stopProxy(this.jobManager);
  stopProxy(this.globalInputSplitProvider);
  stopProxy(this.lookupService);
  stopProxy(this.accumulatorProtocolProxy);
  try {
    this.taskManagerServer.stop();
  }
 catch (  Throwable t) {
    LOG.warn("TaskManager RPC server did not shut down properly.",t);
  }
  if (this.profiler != null) {
    this.profiler.shutdown();
  }
  try {
    this.channelManager.shutdown();
  }
 catch (  Throwable t) {
    LOG.warn("ChannelManager did not shutdown properly: " + t.getMessage(),t);
  }
  if (this.ioManager != null) {
    this.ioManager.shutdown();
  }
  if (this.memoryManager != null) {
    this.memoryManager.shutdown();
  }
  if (libraryCacheManager != null) {
    try {
      this.libraryCacheManager.shutdown();
    }
 catch (    IOException e) {
      LOG.warn("Could not properly shutdown the library cache manager.",e);
    }
  }
  this.fileCache.shutdown();
  if (this.executorService != null) {
    this.executorService.shutdown();
    try {
      this.executorService.awaitTermination(5000L,TimeUnit.MILLISECONDS);
    }
 catch (    InterruptedException e) {
      LOG.debug("Shutdown of executor thread pool interrupted",e);
    }
  }
  this.shutdownComplete=true;
}
