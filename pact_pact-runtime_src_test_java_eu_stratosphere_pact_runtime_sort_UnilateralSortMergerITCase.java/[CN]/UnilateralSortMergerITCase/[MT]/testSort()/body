{
  final Comparator<TestData.Key> keyComparator=new TestData.KeyComparator();
  MockRecordReader<PactRecord> reader=new MockRecordReader<PactRecord>();
  LOG.debug("Initializing sortmerger...");
  @SuppressWarnings("unchecked") SortMerger merger=new UnilateralSortMerger(memoryManager,ioManager,16 * 1024 * 1024,1024 * 1024 * 4,1,2,new Comparator[]{keyComparator},new int[0],new Class[]{TestData.Key.class},reader,parentTask,0.7f);
  LOG.debug("Emitting data...");
  TestData.Generator generator=new TestData.Generator(SEED,KEY_MAX,VALUE_LENGTH,KeyMode.RANDOM,ValueMode.FIX_LENGTH);
  for (int i=0; i < NUM_PAIRS; i++) {
    reader.emit(generator.next());
  }
  reader.close();
  ReadingIterator<PactRecord> iterator=merger.getIterator();
  LOG.debug("Checking results...");
  int pairsEmitted=0;
  PactRecord rec1=new PactRecord();
  PactRecord rec2=new PactRecord();
  final Key k1=new Key();
  final Key k2=new Key();
  rec1=iterator.next(rec1);
  while ((rec2=iterator.next(rec2)) != null) {
    pairsEmitted++;
    k1.setKey(rec1.getField(0,TestData.Key.class).getKey());
    k2.setKey(rec2.getField(0,TestData.Key.class).getKey());
    Assert.assertTrue(keyComparator.compare(k1,k2) <= 0);
    PactRecord tmp=rec1;
    rec1=rec2;
    rec2=tmp;
  }
  Assert.assertTrue(NUM_PAIRS == pairsEmitted);
  merger.close();
}
