{
  checkNotNull(jobManagerRef);
  checkNotNull(taskManagerRef);
synchronized (lock) {
    if (isShutdown) {
      throw new IllegalStateException("environment is shut down");
    }
    if (this.partitionConsumableNotifier == null && this.partitionManager == null && this.taskEventDispatcher == null && this.connectionManager == null) {
      LOG.debug("Starting result partition manager and network connection manager");
      this.partitionManager=new ResultPartitionManager();
      this.taskEventDispatcher=new TaskEventDispatcher();
      this.partitionConsumableNotifier=new JobManagerResultPartitionConsumableNotifier(jobManagerRef,taskManagerRef,new Timeout(jobManagerTimeout));
      this.partitionStateChecker=new JobManagerPartitionStateChecker(jobManagerRef,taskManagerRef);
      final Option<NettyConfig> nettyConfig=configuration.nettyConfig();
      connectionManager=nettyConfig.isDefined() ? new NettyConnectionManager(nettyConfig.get()) : new LocalConnectionManager();
      try {
        LOG.debug("Starting network connection manager");
        connectionManager.start(partitionManager,taskEventDispatcher,networkBufferPool);
      }
 catch (      Throwable t) {
        throw new IOException("Failed to instantiate network connection manager: " + t.getMessage(),t);
      }
    }
 else {
      throw new IllegalStateException("Network Environment is already associated with a JobManager/TaskManager");
    }
  }
}
