{
  if (partitionState == null) {
    LOG.debug("snapshotState() requested on not yet opened source; returning null.");
    return null;
  }
  if (!running) {
    LOG.debug("snapshotState() called on closed source");
    return null;
  }
  HashMap<KafkaTopicPartition,Long> currentOffsets=new HashMap<>();
  for (  Map.Entry<KafkaTopicPartition,KafkaPartitionState> entry : partitionState.entrySet()) {
    currentOffsets.put(entry.getKey(),entry.getValue().getOffset());
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Snapshotting state. Offsets: {}, checkpoint id: {}, timestamp: {}",KafkaTopicPartition.toString(currentOffsets),checkpointId,checkpointTimestamp);
  }
  pendingCheckpoints.put(checkpointId,currentOffsets);
  while (pendingCheckpoints.size() > MAX_NUM_PENDING_CHECKPOINTS) {
    pendingCheckpoints.remove(0);
  }
  return currentOffsets;
}
