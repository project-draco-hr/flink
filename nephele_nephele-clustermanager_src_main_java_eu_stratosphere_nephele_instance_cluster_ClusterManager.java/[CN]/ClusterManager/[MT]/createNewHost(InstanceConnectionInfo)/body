{
  InstanceType instanceType=this.ipToInstanceTypeMapping.get(instanceConnectionInfo.getAddress());
  if (instanceType == null) {
    LOG.warn("Received heart beat from unexpected instance " + instanceConnectionInfo);
    instanceType=getDefaultInstanceType();
  }
  String instanceName=instanceConnectionInfo.getHostName();
  NetworkNode parentNode=this.networkTopology.getRootNode();
  NetworkNode currentStubNode=null;
  while (true) {
    currentStubNode=this.networkTopology.getNodeByName(instanceName);
    if (currentStubNode != null) {
      break;
    }
    final int pos=instanceName.lastIndexOf('.');
    if (pos == -1) {
      break;
    }
    instanceName=instanceName.substring(0,pos);
  }
  if (currentStubNode == null) {
    instanceName=instanceConnectionInfo.getAddress().toString();
    instanceName=instanceName.replaceAll("/","");
    currentStubNode=this.networkTopology.getNodeByName(instanceName);
  }
  if (currentStubNode != null) {
    if (currentStubNode.getParentNode() != null) {
      parentNode=currentStubNode.getParentNode();
    }
    currentStubNode.remove();
  }
  LOG.info("Creating instance of type " + instanceType + " for "+ instanceConnectionInfo+ ", parent is "+ parentNode.getName());
  final ClusterInstance host=new ClusterInstance(instanceConnectionInfo,instanceType,parentNode,this.networkTopology);
  return host;
}
