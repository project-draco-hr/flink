{
  if (this.outgoingTransferEnvelope == null) {
    LOG.error("Cannot find transfer envelope for channel with ID " + this.byteBufferedOutputChannel.getID());
    return;
  }
  if (this.outgoingTransferEnvelope.getBuffer() == null) {
    LOG.error("Channel " + this.byteBufferedOutputChannel.getID() + " has no buffer attached");
    return;
  }
  try {
    this.outgoingTransferEnvelope.getBuffer().finishWritePhase();
  }
 catch (  final IOException ioe) {
    this.byteBufferedOutputChannel.reportIOException(ioe);
  }
  if (!this.isReceiverRunning) {
    final Buffer memBuffer=this.outgoingTransferEnvelope.getBuffer();
    final Buffer fileBuffer=this.outputGateContext.getFileBuffer(memBuffer.size());
    memBuffer.copyToBuffer(fileBuffer);
    this.outgoingTransferEnvelope.setBuffer(fileBuffer);
    this.queuedOutgoingEnvelopes.add(this.outgoingTransferEnvelope);
    this.outgoingTransferEnvelope=null;
    memBuffer.recycleBuffer();
    return;
  }
  while (!this.queuedOutgoingEnvelopes.isEmpty()) {
    this.outputGateContext.processEnvelope(this.queuedOutgoingEnvelopes.poll());
  }
  this.outputGateContext.processEnvelope(this.outgoingTransferEnvelope);
  this.outgoingTransferEnvelope=null;
}
