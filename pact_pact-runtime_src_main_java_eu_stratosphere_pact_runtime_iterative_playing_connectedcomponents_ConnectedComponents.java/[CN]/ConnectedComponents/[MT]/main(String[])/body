{
  int degreeOfParallelism=2;
  int numSubTasksPerInstance=degreeOfParallelism;
  String initialSolutionSetPath="file://" + PlayConstants.PLAY_DIR + "test-inputs/connectedComponents/initialSolutionset";
  String initialWorksetPath="file://" + PlayConstants.PLAY_DIR + "test-inputs/connectedComponents/initialWorkset";
  String graphPath="file://" + PlayConstants.PLAY_DIR + "test-inputs/connectedComponents/graph";
  String outputPath="file:///tmp/stratosphere/iterations";
  String confPath=PlayConstants.PLAY_DIR + "local-conf";
  int memoryPerTask=100;
  JobGraph jobGraph=new JobGraph("ConnectedComponents");
  JobInputVertex initialSolutionset=JobGraphUtils.createInput(LongLongInputFormat.class,initialSolutionSetPath,"InitialSolutionset",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig initialSolutionsetConfig=new TaskConfig(initialSolutionset.getConfiguration());
  initialSolutionsetConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(initialSolutionsetConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobInputVertex initialWorkset=JobGraphUtils.createInput(LongLongInputFormat.class,initialWorksetPath,"InitialWorkset",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  JobInputVertex graph=JobGraphUtils.createInput(LongLongInputFormat.class,graphPath,"Graph",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig graphConfig=new TaskConfig(graph.getConfiguration());
  graphConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(graphConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex head=JobGraphUtils.createTask(IterationHeadPactTask.class,"Head-Repartition",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig headConfig=new TaskConfig(head.getConfiguration());
  headConfig.setDriver(MapDriver.class);
  headConfig.setStubClass(IdentityMap.class);
  headConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  headConfig.setBackChannelMemoryFraction(0.5f);
  headConfig.setComparatorFactoryForOutput(PactRecordComparatorFactory.class,0);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(headConfig.getConfigForOutputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  headConfig.enableWorkset();
  headConfig.setWorksetHashjoinMemoryFraction(0.5f);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(headConfig.getConfigurationForWorksetHashjoinBuildside(),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(headConfig.getConfigurationForWorksetHashjoinProbeside(),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex intermediateMinimumComponentID=JobGraphUtils.createTask(IterationIntermediatePactTask.class,"Intermediate-MinimumComponentID",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig intermediateMinimumComponentIDConfig=new TaskConfig(intermediateMinimumComponentID.getConfiguration());
  intermediateMinimumComponentIDConfig.setDriver(ReduceDriver.class);
  intermediateMinimumComponentIDConfig.setStubClass(MinimumComponentIDReduce.class);
  intermediateMinimumComponentIDConfig.setLocalStrategy(TaskConfig.LocalStrategy.SORT);
  intermediateMinimumComponentIDConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  intermediateMinimumComponentIDConfig.setNumFilehandles(2);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateMinimumComponentIDConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex intermediateSolutionSetUpdate=JobGraphUtils.createTask(WorksetIterationSolutionsetJoinTask.class,"Intermediate-UpdateComponentID",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig intermediateSolutionSetUpdateConfig=new TaskConfig(intermediateSolutionSetUpdate.getConfiguration());
  intermediateSolutionSetUpdateConfig.setDriver(SolutionsetMatchDriver.class);
  intermediateSolutionSetUpdateConfig.setStubClass(UpdateCompontentIDMatch.class);
  intermediateSolutionSetUpdateConfig.setLocalStrategy(TaskConfig.LocalStrategy.HYBRIDHASH_SECOND);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateSolutionSetUpdateConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(intermediateSolutionSetUpdateConfig.getConfigForInputParameters(1),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  JobTaskVertex tail=JobGraphUtils.createTask(IterationTailPactTask.class,"Tail-NeighborComponentIDToWorkset",jobGraph,degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig tailConfig=new TaskConfig(tail.getConfiguration());
  tailConfig.setDriver(MatchDriver.class);
  tailConfig.setStubClass(NeighborComponentIDToWorksetMatch.class);
  tailConfig.setLocalStrategy(TaskConfig.LocalStrategy.HYBRIDHASH_SECOND);
  PactRecordComparatorFactory.writeComparatorSetupToConfig(tailConfig.getConfigForInputParameters(0),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  PactRecordComparatorFactory.writeComparatorSetupToConfig(tailConfig.getConfigForInputParameters(1),new int[]{0},new Class[]{PactLong.class},new boolean[]{true});
  tailConfig.setMemorySize(memoryPerTask * JobGraphUtils.MEGABYTE);
  tailConfig.setGateCached(0);
  tailConfig.setInputGateCacheMemoryFraction(0.5f);
  JobOutputVertex sync=JobGraphUtils.createSync(jobGraph,degreeOfParallelism);
  TaskConfig syncConfig=new TaskConfig(sync.getConfiguration());
  syncConfig.setNumberOfIterations(5);
  syncConfig.setConvergenceCriterion(WorksetEmptyConvergenceCriterion.class);
  JobOutputVertex output=JobGraphUtils.createFileOutput(jobGraph,"FinalOutput",degreeOfParallelism,numSubTasksPerInstance);
  TaskConfig outputConfig=new TaskConfig(output.getConfiguration());
  outputConfig.setStubClass(ConnectedComponentsOutFormat.class);
  outputConfig.setStubParameter(FileOutputFormat.FILE_PARAMETER_KEY,outputPath);
  JobOutputVertex fakeTailOutput=JobGraphUtils.createFakeOutput(jobGraph,"FakeTailOutput",degreeOfParallelism,numSubTasksPerInstance);
  JobGraphUtils.connect(initialWorkset,head,ChannelType.INMEMORY,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(head,intermediateMinimumComponentID,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  intermediateMinimumComponentIDConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,degreeOfParallelism);
  JobGraphUtils.connect(intermediateMinimumComponentID,intermediateSolutionSetUpdate,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  intermediateSolutionSetUpdateConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,1);
  JobGraphUtils.connect(initialSolutionset,intermediateSolutionSetUpdate,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  JobGraphUtils.connect(graph,tail,ChannelType.NETWORK,DistributionPattern.BIPARTITE,ShipStrategyType.PARTITION_HASH);
  JobGraphUtils.connect(intermediateSolutionSetUpdate,tail,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  tailConfig.setGateCached(0);
  tailConfig.setInputGateCacheMemoryFraction(0.5f);
  tailConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(1,1);
  JobGraphUtils.connect(head,sync,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(head,output,ChannelType.INMEMORY,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  syncConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(0,degreeOfParallelism);
  JobGraphUtils.connect(tail,sync,ChannelType.NETWORK,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  JobGraphUtils.connect(tail,fakeTailOutput,ChannelType.INMEMORY,DistributionPattern.POINTWISE,ShipStrategyType.FORWARD);
  syncConfig.setGateIterativeWithNumberOfEventsUntilInterrupt(1,degreeOfParallelism);
  initialWorkset.setVertexToShareInstancesWith(head);
  initialSolutionset.setVertexToShareInstancesWith(head);
  graph.setVertexToShareInstancesWith(head);
  intermediateMinimumComponentID.setVertexToShareInstancesWith(head);
  intermediateSolutionSetUpdate.setVertexToShareInstancesWith(head);
  tail.setVertexToShareInstancesWith(head);
  fakeTailOutput.setVertexToShareInstancesWith(head);
  output.setVertexToShareInstancesWith(head);
  sync.setVertexToShareInstancesWith(head);
  GlobalConfiguration.loadConfiguration(confPath);
  Configuration conf=GlobalConfiguration.getConfiguration();
  JobGraphUtils.submit(jobGraph,conf);
}
