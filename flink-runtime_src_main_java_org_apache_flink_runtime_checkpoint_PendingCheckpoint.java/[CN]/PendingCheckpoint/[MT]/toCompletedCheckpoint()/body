{
synchronized (lock) {
    if (discarded) {
      throw new IllegalStateException("pending checkpoint is discarded");
    }
    if (notYetAcknowledgedTasks.isEmpty()) {
      SuccessfulCheckpoint completed=new SuccessfulCheckpoint(jobId,checkpointId,checkpointTimestamp,new ArrayList<StateForTask>(collectedStates));
      discard();
      return completed;
    }
 else {
      throw new IllegalStateException("Cannot complete checkpoint while not all tasks are acknowledged");
    }
  }
}
