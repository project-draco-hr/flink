{
  super.snapshotState(out,checkpointId,timestamp);
  if (userFunction instanceof Checkpointed) {
    @SuppressWarnings("unchecked") Checkpointed<Serializable> chkFunction=(Checkpointed<Serializable>)userFunction;
    Serializable udfState;
    try {
      udfState=chkFunction.snapshotState(checkpointId,timestamp);
      if (udfState != null) {
        out.write(1);
        ObjectOutputStream os=new ObjectOutputStream(out);
        os.writeObject(udfState);
        os.flush();
      }
 else {
        out.write(0);
      }
    }
 catch (    Exception e) {
      throw new Exception("Failed to draw state snapshot from function: " + e.getMessage(),e);
    }
  }
}
