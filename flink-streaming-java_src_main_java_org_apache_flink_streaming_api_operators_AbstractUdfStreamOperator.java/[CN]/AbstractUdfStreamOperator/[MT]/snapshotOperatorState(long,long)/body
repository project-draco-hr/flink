{
  StreamTaskState state=super.snapshotOperatorState(checkpointId,timestamp);
  if (userFunction instanceof Checkpointed) {
    @SuppressWarnings("unchecked") Checkpointed<Serializable> chkFunction=(Checkpointed<Serializable>)userFunction;
    Serializable udfState;
    try {
      udfState=chkFunction.snapshotState(checkpointId,timestamp);
    }
 catch (    Exception e) {
      throw new Exception("Failed to draw state snapshot from function: " + e.getMessage(),e);
    }
    if (udfState != null) {
      try {
        StateBackend<?> stateBackend=getStateBackend();
        StateHandle<Serializable> handle=stateBackend.checkpointStateSerializable(udfState,checkpointId,timestamp);
        state.setFunctionState(handle);
      }
 catch (      Exception e) {
        throw new Exception("Failed to add the state snapshot of the function to the checkpoint: " + e.getMessage(),e);
      }
    }
  }
  return state;
}
