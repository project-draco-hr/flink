{
  if (event.getClass() == QueueEvent.class) {
    writeAndFlushNextEnvelopeIfPossible();
  }
 else   if (event.getClass() == IdleStateEvent.class) {
    boolean closeConnection=false;
synchronized (channel) {
      if (queuedEnvelopes.isEmpty() && !hasRequestedClose) {
        hasRequestedClose=true;
        closeConnection=true;
        connectionManager.close(receiver);
      }
    }
    if (closeConnection) {
      ctx.close().addListener(new ChannelCloseListener());
    }
  }
 else {
    throw new IllegalStateException("Triggered unknown event.");
  }
}
