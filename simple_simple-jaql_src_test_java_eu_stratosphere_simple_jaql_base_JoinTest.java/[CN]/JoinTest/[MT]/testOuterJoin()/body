{
  SopremoPlan actualPlan=parseScript("$users = read 'users.json';\n" + "$pages = read 'pages.json';\n" + "$result = join preserve $u in $users, $p in $pages\n"+ "  where $u.id == $p.userid\n"+ "  into { $u.name, $p.* };\n"+ "write $result to 'result.json';");
  EvaluationExpression retainFirst=new InputSelection(0).withTag(ExpressionTag.RETAIN);
  SopremoPlan expectedPlan=new SopremoPlan();
  Source users=new Source("users.json");
  Source pages=new Source("pages.json");
  Join join=new Join().withInputs(users,pages).withJoinCondition(new ComparativeExpression(new PathExpression(retainFirst,new ObjectAccess("id")),BinaryOperator.EQUAL,JsonUtil.createPath("1","userid"))).withResultProjection(new ObjectCreation(new ObjectCreation.FieldAssignment("name",new PathExpression(retainFirst,new ObjectAccess("name"))),new ObjectCreation.CopyFields(JsonUtil.createPath("1"))));
  Sink result=new Sink("result.json").withInputs(join);
  expectedPlan.setSinks(result);
  assertEquals(expectedPlan,actualPlan);
}
