{
  if (lastOffsets == null) {
    LOG.debug("snapshotState() requested on not yet opened source; returning null.");
    return null;
  }
  if (!running) {
    LOG.debug("snapshotState() called on closed source");
    return null;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Snapshotting state. Offsets: {}, checkpoint id: {}, timestamp: {}",KafkaTopicPartition.toString(lastOffsets),checkpointId,checkpointTimestamp);
  }
  @SuppressWarnings("unchecked") HashMap<KafkaTopicPartition,Long> currentOffsets=(HashMap<KafkaTopicPartition,Long>)lastOffsets.clone();
  pendingCheckpoints.put(checkpointId,currentOffsets);
  while (pendingCheckpoints.size() > MAX_NUM_PENDING_CHECKPOINTS) {
    pendingCheckpoints.remove(0);
  }
  return currentOffsets;
}
