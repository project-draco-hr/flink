{
  final ExecutionGraph eg=vertex.getExecutionGraph();
  final RuntimeEnvironment env=vertex.getEnvironment();
  for (int i=0; i < env.getNumberOfOutputGates(); ++i) {
    final OutputGate<? extends Record> outputGate=env.getOutputGate(i);
    for (int j=0; j < outputGate.getNumberOfOutputChannels(); ++j) {
      final AbstractOutputChannel<? extends Record> outputChannel=outputGate.getOutputChannel(j);
      if (outputChannel.getType() == ChannelType.FILE) {
        continue;
      }
      final ChannelID connectedChannelID=outputChannel.getConnectedChannelID();
      final ExecutionVertex connectedVertex=eg.getVertexByChannelID(connectedChannelID);
      if (connectedVertex == null) {
        LOG.error("Connected vertex is null");
        continue;
      }
      final AbstractInstance instance=connectedVertex.getAllocatedResource().getInstance();
      if (instance instanceof DummyInstance) {
        continue;
      }
      Set<ChannelID> channelIDs=entriesToInvalidate.get(instance);
      if (channelIDs == null) {
        channelIDs=new SerializableHashSet<ChannelID>();
        entriesToInvalidate.put(instance,channelIDs);
      }
      channelIDs.add(connectedChannelID);
    }
  }
  for (int i=0; i < env.getNumberOfInputGates(); ++i) {
    final InputGate<? extends Record> inputGate=env.getInputGate(i);
    for (int j=0; j < inputGate.getNumberOfInputChannels(); ++j) {
      final AbstractInputChannel<? extends Record> inputChannel=inputGate.getInputChannel(j);
      if (inputChannel.getType() == ChannelType.FILE) {
        continue;
      }
      final ChannelID connectedChannelID=inputChannel.getConnectedChannelID();
      final ExecutionVertex connectedVertex=eg.getVertexByChannelID(connectedChannelID);
      if (connectedVertex == null) {
        LOG.error("Connected vertex is null");
        continue;
      }
      final AbstractInstance instance=connectedVertex.getAllocatedResource().getInstance();
      if (instance instanceof DummyInstance) {
        continue;
      }
      Set<ChannelID> channelIDs=entriesToInvalidate.get(instance);
      if (channelIDs == null) {
        channelIDs=new SerializableHashSet<ChannelID>();
        entriesToInvalidate.put(instance,channelIDs);
      }
      channelIDs.add(connectedChannelID);
    }
  }
}
