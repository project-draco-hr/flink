{
  checkNotNull(pathInZooKeeper,"Path in ZooKeeper");
  checkNotNull(state,"State");
  StateHandle<T> stateHandle=storage.store(state);
  boolean success=false;
  try {
    byte[] serializedStateHandle=InstantiationUtil.serializeObject(stateHandle);
    client.create().withMode(createMode).forPath(pathInZooKeeper,serializedStateHandle);
    success=true;
    return stateHandle;
  }
  finally {
    if (!success) {
      if (stateHandle != null) {
        stateHandle.discardState();
      }
    }
  }
}
