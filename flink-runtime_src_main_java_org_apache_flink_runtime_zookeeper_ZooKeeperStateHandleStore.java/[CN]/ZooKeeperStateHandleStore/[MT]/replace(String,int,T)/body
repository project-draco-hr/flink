{
  checkNotNull(pathInZooKeeper,"Path in ZooKeeper");
  checkNotNull(state,"State");
  StateHandle<T> oldStateHandle=get(pathInZooKeeper);
  StateHandle<T> stateHandle=stateHandleProvider.createStateHandle(state);
  boolean success=false;
  try {
    byte[] serializedStateHandle=InstantiationUtil.serializeObject(stateHandle);
    client.setData().withVersion(expectedVersion).forPath(pathInZooKeeper,serializedStateHandle);
    success=true;
  }
  finally {
    if (success) {
      oldStateHandle.discardState();
    }
 else {
      stateHandle.discardState();
    }
  }
}
