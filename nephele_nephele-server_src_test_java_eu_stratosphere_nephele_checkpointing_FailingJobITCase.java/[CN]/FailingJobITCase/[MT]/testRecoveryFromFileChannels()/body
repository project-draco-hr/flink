{
  final JobGraph jobGraph=new JobGraph("Job with file channels");
  final JobGenericInputVertex input=new JobGenericInputVertex("Input",jobGraph);
  input.setInputClass(InputTask.class);
  input.setNumberOfSubtasks(DEGREE_OF_PARALLELISM);
  input.setNumberOfSubtasksPerInstance(DEGREE_OF_PARALLELISM);
  final JobTaskVertex innerVertex1=new JobTaskVertex("Inner vertex 1",jobGraph);
  innerVertex1.setTaskClass(InnerTask.class);
  innerVertex1.setNumberOfSubtasks(DEGREE_OF_PARALLELISM);
  innerVertex1.setNumberOfSubtasksPerInstance(DEGREE_OF_PARALLELISM);
  final JobGenericOutputVertex output=new JobGenericOutputVertex("Output",jobGraph);
  output.setOutputClass(OutputTask.class);
  output.setNumberOfSubtasks(DEGREE_OF_PARALLELISM);
  output.setNumberOfSubtasksPerInstance(DEGREE_OF_PARALLELISM);
  output.getConfiguration().setInteger(FAILED_AFTER_RECORD_KEY,153201);
  output.getConfiguration().setInteger(FAILURE_INDEX_KEY,1);
  innerVertex1.setVertexToShareInstancesWith(input);
  output.setVertexToShareInstancesWith(input);
  try {
    input.connectTo(innerVertex1,ChannelType.INMEMORY,CompressionLevel.NO_COMPRESSION);
    innerVertex1.connectTo(output,ChannelType.FILE,CompressionLevel.NO_COMPRESSION);
  }
 catch (  JobGraphDefinitionException e) {
    fail(StringUtils.stringifyException(e));
  }
synchronized (FAILED_ONCE) {
    FAILED_ONCE.clear();
  }
  JobClient jobClient=null;
  try {
    jobClient=new JobClient(jobGraph,configuration);
    jobClient.submitJobAndWait();
  }
 catch (  IOException ioe) {
    fail(StringUtils.stringifyException(ioe));
  }
catch (  JobExecutionException e) {
    fail(StringUtils.stringifyException(e));
  }
 finally {
    if (jobClient != null) {
      jobClient.close();
    }
  }
}
