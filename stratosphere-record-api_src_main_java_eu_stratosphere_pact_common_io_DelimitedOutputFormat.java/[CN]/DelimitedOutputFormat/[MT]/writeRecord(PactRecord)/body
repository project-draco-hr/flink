{
  int size;
  try {
    while ((size=serializeRecord(record,this.targetArray)) < 0) {
      if (-size > this.targetArray.length) {
        this.targetArray=new byte[-size];
      }
 else {
        this.targetArray=new byte[this.targetArray.length * 2];
      }
    }
  }
 catch (  Exception ex) {
    throw new IOException("Error while serializing the record to bytes: " + ex.getMessage(),ex);
  }
  if (this.bufferSize - this.pos > size + this.delimiter.length) {
    System.arraycopy(this.targetArray,0,this.buffer,this.pos,size);
    System.arraycopy(this.delimiter,0,this.buffer,pos + size,this.delimiter.length);
    pos+=size + this.delimiter.length;
  }
 else {
    int off=0;
    while (off < size) {
      int toCopy=Math.min(size - off,this.bufferSize - this.pos);
      System.arraycopy(this.targetArray,off,this.buffer,this.pos,toCopy);
      off+=toCopy;
      this.pos+=toCopy;
      if (this.pos == this.bufferSize) {
        this.pos=0;
        this.stream.write(this.buffer,0,this.bufferSize);
      }
    }
    off=0;
    while (off < this.delimiter.length) {
      int toCopy=Math.min(this.delimiter.length - off,this.bufferSize - this.pos);
      System.arraycopy(this.delimiter,off,this.buffer,this.pos,toCopy);
      off+=toCopy;
      this.pos+=toCopy;
      if (this.pos == this.bufferSize) {
        this.pos=0;
        this.stream.write(this.buffer,0,this.bufferSize);
      }
    }
  }
}
