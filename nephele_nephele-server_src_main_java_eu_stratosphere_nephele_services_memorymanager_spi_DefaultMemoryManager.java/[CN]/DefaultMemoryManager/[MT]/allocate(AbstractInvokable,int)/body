{
  if (segmentSize < 1) {
    throw new IllegalArgumentException();
  }
  if (owner == null) {
    throw new IllegalArgumentException("The owner of a memory segment must not be null.");
  }
synchronized (this.lock) {
    if (isShutDown) {
      throw new IllegalStateException("Memory Manager has been shut down.");
    }
    DefaultMemorySegment segment=internalAllocate(owner,segmentSize);
    ArrayList<DefaultMemorySegment> segsByThisOwner=allocatedSegments.get(owner);
    if (segsByThisOwner == null) {
      segsByThisOwner=new ArrayList<DefaultMemorySegment>();
      allocatedSegments.put(owner,segsByThisOwner);
    }
    segsByThisOwner.add(segment);
    return segment;
  }
}
