{
  ListIterator<FreeSegmentEntry> freeSegs=this.freeSegments.listIterator();
  while (freeSegs.hasNext()) {
    FreeSegmentEntry entry=freeSegs.next();
    if (segmentSize <= entry.end - entry.start) {
      int chunk=checkedDownCast(entry.start / chunkSize);
      int start=checkedDownCast(entry.start % chunkSize);
      MemorySegmentDescriptor descriptor=new MemorySegmentDescriptor(owner,memory[chunk],chunk,start,start + segmentSize);
      entry.start+=segmentSize;
      if (entry.start == entry.end) {
        freeSegs.remove();
      }
      return factory(descriptor);
    }
  }
  throw new MemoryAllocationException();
}
