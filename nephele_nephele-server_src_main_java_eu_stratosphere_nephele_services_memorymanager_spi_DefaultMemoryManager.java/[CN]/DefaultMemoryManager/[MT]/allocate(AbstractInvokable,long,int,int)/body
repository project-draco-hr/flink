{
  if (minSegmentSize > this.chunkSize) {
    throw new MemoryAllocationException("The memory chunks of this MemoryManager are too small to serve " + "segments of minimal size " + minSegmentSize);
  }
  if (LOG.isDebugEnabled() && owner.getEnvironment() != null) {
    LOG.info("Allocating " + totalMemory + " bytes for "+ owner.getEnvironment().getTaskName()+ " ("+ (owner.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ owner.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
  }
  final long memPerSeg=totalMemory / minNumSegments;
  final int segmentSize=(int)Math.min(memPerSeg,this.chunkSize);
  if (segmentSize < minSegmentSize) {
    throw new IllegalArgumentException("The requested memory cannot be distributed across the required " + "number of chunks without violating the requested minimal chunk size.");
  }
  return this.allocate(owner,minNumSegments,segmentSize);
}
