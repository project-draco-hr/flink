{
  if (segment == null || segment.isFree()) {
    return;
  }
  final DefaultMemorySegment defSeg=(DefaultMemorySegment)segment;
  final AbstractInvokable owner=defSeg.getSegmentDescriptor().owner;
synchronized (this.lock) {
    if (isShutDown) {
      throw new IllegalStateException("Memory manager has been shut down.");
    }
    try {
      ArrayList<DefaultMemorySegment> segsForOwner=this.allocatedSegments.get(owner);
      if (segsForOwner != null) {
        segsForOwner.remove(defSeg);
        if (segsForOwner.isEmpty()) {
          this.allocatedSegments.remove(owner);
        }
      }
    }
 catch (    Throwable t) {
      LOG.error("Error removing book-keeping reference to allocated memory segment.",t);
    }
 finally {
      internalRelease(defSeg);
    }
  }
}
