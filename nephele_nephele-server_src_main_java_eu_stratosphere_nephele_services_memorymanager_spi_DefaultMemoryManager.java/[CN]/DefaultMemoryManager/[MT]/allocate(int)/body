{
  if (segmentSize < 1) {
    throw new IllegalArgumentException();
  }
  for (int i=0; i < freeSegments.size(); i++) {
    FreeSegmentEntry entry=freeSegments.get(i);
    if (segmentSize <= entry.end - entry.start) {
      int chunk=(int)(entry.start / chunkSize);
      int start=(int)(entry.start % chunkSize);
      MemorySegmentDescriptor descriptor=new MemorySegmentDescriptor(memory[chunk],chunk,start,start + segmentSize);
      allocatedSegments.add(descriptor);
      MemorySegment segment=factory(descriptor);
      entry.start+=segmentSize;
      if (entry.start == entry.end) {
        freeSegments.remove(i);
      }
      return segment;
    }
  }
  throw new MemoryAllocationException();
}
