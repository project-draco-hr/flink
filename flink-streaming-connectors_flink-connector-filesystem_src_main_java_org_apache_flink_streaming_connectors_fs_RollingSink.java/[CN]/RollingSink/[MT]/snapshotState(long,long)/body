{
  if (writer != null) {
    writer.flush();
  }
  if (outStream != null) {
    outStream.flush();
    hflushOrSync(outStream);
    bucketState.currentFile=currentPartPath.toString();
    bucketState.currentFileValidLength=outStream.getPos();
  }
synchronized (bucketState.pendingFilesPerCheckpoint) {
    bucketState.pendingFilesPerCheckpoint.put(checkpointId,bucketState.pendingFiles);
  }
  bucketState.pendingFiles=new ArrayList<>();
  return bucketState;
}
