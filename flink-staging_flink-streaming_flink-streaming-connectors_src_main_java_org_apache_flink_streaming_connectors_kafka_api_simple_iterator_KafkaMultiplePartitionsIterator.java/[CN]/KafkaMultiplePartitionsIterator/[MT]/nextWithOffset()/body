{
  KafkaSinglePartitionIterator partition;
  while (true) {
    for (int i=nextPartition(lastCheckedPartitionIndex); i < partitions.size(); i=nextPartition(i)) {
      partition=partitions.get(i);
      if (partition.fetchHasNext()) {
        gotNewMessage=true;
        lastCheckedPartitionIndex=i;
        return partition.nextWithOffset();
      }
    }
    if (!gotNewMessage) {
      try {
        Thread.sleep(waitOnEmptyFetch);
      }
 catch (      InterruptedException e) {
        LOG.warn("Interrupted while waiting for new messages",e);
      }
    }
    gotNewMessage=false;
  }
}
