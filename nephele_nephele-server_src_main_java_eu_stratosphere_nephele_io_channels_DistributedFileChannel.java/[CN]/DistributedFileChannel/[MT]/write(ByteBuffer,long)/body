{
  if (position != this.nextExpectedWritePosition) {
    throw new IOException("Next expected write position is " + this.nextExpectedWritePosition);
  }
  if (this.outputStream == null) {
    this.outputStream=this.fs.create(this.checkpointFile,false,this.buf.length,REPLICATION,this.fs.getDefaultBlockSize());
  }
  int totalBytesWritten=0;
  while (src.hasRemaining()) {
    final int length=Math.min(this.buf.length,src.remaining());
    src.get(this.buf,0,length);
    this.outputStream.write(this.buf,0,length);
    totalBytesWritten+=length;
  }
  this.nextExpectedWritePosition+=totalBytesWritten;
  return totalBytesWritten;
}
