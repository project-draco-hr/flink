{
  while (true) {
    Pair<Instance,Locality> instanceLocalityPair=findInstance(requestedLocations,localOnly);
    if (instanceLocalityPair == null) {
      return null;
    }
    Instance instanceToUse=instanceLocalityPair.getLeft();
    Locality locality=instanceLocalityPair.getRight();
    if (LOG.isDebugEnabled()) {
      if (locality == Locality.LOCAL) {
        LOG.debug("Local assignment: " + vertex.getSimpleName() + " --> "+ instanceToUse);
      }
 else       if (locality == Locality.NON_LOCAL) {
        LOG.debug("Non-local assignment: " + vertex.getSimpleName() + " --> "+ instanceToUse);
      }
 else       if (locality == Locality.UNCONSTRAINED) {
        LOG.debug("Unconstrained assignment: " + vertex.getSimpleName() + " --> "+ instanceToUse);
      }
    }
    try {
      SimpleSlot slot=instanceToUse.allocateSimpleSlot(vertex.getJobId(),vertex.getJobvertexId());
      if (instanceToUse.hasResourcesAvailable()) {
        this.instancesWithAvailableResources.add(instanceToUse);
      }
      if (slot != null) {
        slot.setLocality(locality);
        return slot;
      }
    }
 catch (    InstanceDiedException e) {
      removeInstance(instanceToUse);
    }
  }
}
