{
  int noKeys=100;
  int noKeyCnt=10000;
  MockRecordReader reader=new MockRecordReader();
  LOG.debug("initializing sortmerger");
  TestCountCombiner comb=new TestCountCombiner();
  Sorter<PactRecord> merger=new CombiningUnilateralSortMerger<PactRecord>(comb,this.memoryManager,this.ioManager,reader,this.parentTask,this.serializer,this.comparator,3 * 1024 * 1024,64,0.005f);
  final PactRecord rec=new PactRecord();
  rec.setField(1,new PactInteger(1));
  final TestData.Key key=new TestData.Key();
  for (int i=0; i < noKeyCnt; i++) {
    for (int j=0; j < noKeys; j++) {
      key.setKey(j);
      rec.setField(0,key);
      reader.emit(rec);
    }
  }
  reader.close();
  MutableObjectIterator<PactRecord> iterator=merger.getIterator();
  Iterator<Integer> result=getReducingIterator(iterator,serializer,comparator.duplicate());
  while (result.hasNext()) {
    Assert.assertEquals(noKeyCnt,result.next().intValue());
  }
  merger.close();
  Assert.assertTrue(comb.opened == comb.closed);
}
