{
  if (iteratorToRead == null) {
    throw new IllegalStateException("Kafka iterator not initialized properly.");
  }
  final Object checkpointLock=ctx.getCheckpointLock();
  while (running && iteratorToRead.hasNext()) {
    MessageAndMetadata<byte[],byte[]> message=iteratorToRead.next();
    if (lastOffsets.getState()[message.partition()] >= message.offset()) {
      LOG.info("Skipping message with offset {} from partition {}",message.offset(),message.partition());
      continue;
    }
    OUT next=deserializationSchema.deserialize(message.message());
    if (deserializationSchema.isEndOfStream(next)) {
      LOG.info("DeserializationSchema signaled end of stream for this source");
      break;
    }
synchronized (checkpointLock) {
      lastOffsets.getState()[message.partition()]=message.offset();
      ctx.collect(next);
    }
    if (LOG.isTraceEnabled()) {
      LOG.trace("Processed record with offset {} from partition {}",message.offset(),message.partition());
    }
  }
}
