{
  while (true) {
    BufferOrEvent next;
    if (currentBuffered != null) {
      next=currentBuffered.getNext();
      if (next == null) {
        currentBuffered=queuedBuffered.pollFirst();
        if (currentBuffered != null) {
          currentBuffered.open();
        }
        return getNextNonBlocked();
      }
    }
 else {
      next=inputGate.getNextBufferOrEvent();
    }
    if (next != null) {
      if (isBlocked(next.getChannelIndex())) {
        bufferSpiller.add(next);
      }
 else       if (next.isBuffer() || next.getEvent().getClass() != CheckpointBarrier.class) {
        return next;
      }
 else       if (!endOfStream) {
        processBarrier((CheckpointBarrier)next.getEvent(),next.getChannelIndex());
      }
    }
 else     if (!endOfStream) {
      endOfStream=true;
      releaseBlocks();
      return getNextNonBlocked();
    }
 else {
      return null;
    }
  }
}
