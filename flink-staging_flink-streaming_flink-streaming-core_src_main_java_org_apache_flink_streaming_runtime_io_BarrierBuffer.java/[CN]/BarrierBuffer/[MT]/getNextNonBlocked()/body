{
  while (true) {
    final SpillingBufferOrEvent nextBuffered=nonProcessed.pollFirst();
    final BufferOrEvent next=nextBuffered == null ? inputGate.getNextBufferOrEvent() : nextBuffered.getBufferOrEvent();
    if (next != null) {
      if (isBlocked(next.getChannelIndex())) {
        blockedNonProcessed.add(new SpillingBufferOrEvent(next,bufferSpiller,spillReader));
      }
 else       if (next.isBuffer() || next.getEvent().getClass() != CheckpointBarrier.class) {
        return next;
      }
 else       if (!endOfStream) {
        processBarrier((CheckpointBarrier)next.getEvent(),next.getChannelIndex());
      }
    }
 else     if (!endOfStream) {
      endOfStream=true;
      releaseBlocks();
      return getNextNonBlocked();
    }
 else {
      return null;
    }
  }
}
