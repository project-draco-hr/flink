{
  BufferOrEvent bufferOrEvent=getNonProcessed();
  if (bufferOrEvent != null) {
    return bufferOrEvent;
  }
 else   if (blockedNonProcessed.isEmpty() && inputFinished) {
    return endOfStreamEvent;
  }
 else {
    while (true) {
      if (!inputFinished) {
        bufferOrEvent=inputGate.getNextBufferOrEvent();
        if (!bufferOrEvent.isBuffer() && bufferOrEvent.getEvent() instanceof EndOfPartitionEvent) {
          if (inputGate.isFinished()) {
            endOfStreamEvent=bufferOrEvent;
            inputFinished=true;
          }
        }
 else {
          if (isBlocked(bufferOrEvent.getChannelIndex())) {
            blockedNonProcessed.add(new SpillingBufferOrEvent(bufferOrEvent,bufferSpiller,spillReader));
          }
 else {
            return bufferOrEvent;
          }
        }
      }
 else {
        actOnAllBlocked();
        return getNextNonBlocked();
      }
    }
  }
}
