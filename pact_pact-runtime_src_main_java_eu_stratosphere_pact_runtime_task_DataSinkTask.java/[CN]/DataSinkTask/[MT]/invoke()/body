{
  LOG.info("Start PACT code: " + this.getEnvironment().getTaskName() + " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
  final Path path=getFileOutputPath();
  final OutputFormat format=this.format;
  OutputPathOpenThread opot=new OutputPathOpenThread(path,this.getEnvironment().getIndexInSubtaskGroup() + 1,10000);
  opot.start();
  FSDataOutputStream fdos=null;
  CloseableInputProvider<KeyValuePair<Key,Value>> sortedInputProvider=null;
  try {
    sortedInputProvider=obtainInput();
    Iterator<KeyValuePair<Key,Value>> iter=sortedInputProvider.getIterator();
    LOG.debug("Iterator obtained: " + this.getEnvironment().getTaskName() + " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
    fdos=opot.getFSDataOutputStream();
    if (this.taskCanceled) {
      return;
    }
    LOG.debug("Start writing output to " + path.toString() + " : "+ this.getEnvironment().getTaskName()+ " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
    format.setOutput(fdos);
    format.open();
    while (!this.taskCanceled && iter.hasNext()) {
      KeyValuePair pair=iter.next();
      format.writePair(pair);
    }
  }
 catch (  Exception ex) {
    if (!this.taskCanceled) {
      LOG.error("Unexpected ERROR in PACT code: " + this.getEnvironment().getTaskName() + " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
      throw ex;
    }
  }
 finally {
    if (sortedInputProvider != null) {
      sortedInputProvider.close();
    }
    if (this.format != null) {
      try {
        this.format.close();
      }
 catch (      Throwable t) {
      }
    }
    if (fdos != null) {
      try {
        fdos.close();
      }
 catch (      Throwable t) {
      }
    }
  }
  if (!this.taskCanceled) {
    LOG.debug("Finished writing output to " + path.toString() + " : "+ this.getEnvironment().getTaskName()+ " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
    LOG.info("Finished PACT code: " + this.getEnvironment().getTaskName() + " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
  }
 else {
    LOG.warn("PACT code cancelled: " + this.getEnvironment().getTaskName() + " ("+ (this.getEnvironment().getIndexInSubtaskGroup() + 1)+ "/"+ this.getEnvironment().getCurrentNumberOfSubtasks()+ ")");
  }
}
