{
  final String tmpDir=ServerTestUtils.getTempDir();
  final ChannelCheckpoint channelCheckpoint=new ChannelCheckpoint(VERTEX_ID,SOURCE_CHANNEL_ID,tmpDir);
  when(this.byteBufferedChannelManager.getFileBufferManager()).thenReturn(this.fileBufferManager);
  try {
    doThrow(new EOFException()).when(this.incomingConnection).read();
  }
 catch (  IOException ioe) {
    fail(ioe.getMessage());
  }
catch (  InterruptedException e) {
    fail(e.getMessage());
  }
  try {
    final TransferEnvelope transferEnvelope=generateTransferEnvelope(SOURCE_CHANNEL_ID,TARGET_CHANNEL_ID,0);
    channelCheckpoint.addToCheckpoint(transferEnvelope);
    channelCheckpoint.makePersistent();
    channelCheckpoint.markChannelCheckpointAsFinished();
    channelCheckpoint.recover(this.byteBufferedChannelManager);
  }
 catch (  IOException ioe) {
    fail(ioe.getMessage());
  }
 finally {
    channelCheckpoint.discard();
  }
}
