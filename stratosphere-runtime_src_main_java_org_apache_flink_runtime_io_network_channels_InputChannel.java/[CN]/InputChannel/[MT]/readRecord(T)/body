{
  if (this.dataBuffer == null) {
    if (isClosed()) {
      return InputChannelResult.END_OF_STREAM;
    }
    BufferOrEvent boe=getNextBufferOrEvent();
    if (boe == null) {
      throw new IllegalStateException("Input channel was queries for data even though none was announced available.");
    }
    if (boe.isEvent()) {
      if (this.deserializer.hasUnfinishedData()) {
        throw new IllegalStateException("Channel received an event before completing the current partial record.");
      }
      AbstractEvent evt=boe.getEvent();
      if (evt.getClass() == ChannelCloseEvent.class) {
        this.brokerAggreedToCloseChannel=true;
        return InputChannelResult.END_OF_STREAM;
      }
 else       if (evt.getClass() == EndOfSuperstepEvent.class) {
        return InputChannelResult.END_OF_SUPERSTEP;
      }
 else       if (evt instanceof AbstractTaskEvent) {
        this.currentEvent=(AbstractTaskEvent)evt;
        return InputChannelResult.TASK_EVENT;
      }
 else {
        LOG.error("Received unknown event: " + evt);
        return InputChannelResult.NONE;
      }
    }
 else {
      this.dataBuffer=boe.getBuffer();
      this.deserializer.setNextMemorySegment(this.dataBuffer.getMemorySegment(),this.dataBuffer.size());
    }
  }
  DeserializationResult deserializationResult=this.deserializer.getNextRecord(target);
  if (deserializationResult.isBufferConsumed()) {
    releasedConsumedReadBuffer(this.dataBuffer);
    this.dataBuffer=null;
  }
  if (deserializationResult == DeserializationResult.INTERMEDIATE_RECORD_FROM_BUFFER) {
    return InputChannelResult.INTERMEDIATE_RECORD_FROM_BUFFER;
  }
 else   if (deserializationResult == DeserializationResult.LAST_RECORD_FROM_BUFFER) {
    return InputChannelResult.LAST_RECORD_FROM_BUFFER;
  }
 else   if (deserializationResult == DeserializationResult.PARTIAL_RECORD) {
    return InputChannelResult.NONE;
  }
 else {
    throw new IllegalStateException();
  }
}
