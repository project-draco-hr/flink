{
  if (allSlots.isEmpty()) {
    return null;
  }
  Map<Instance,List<SharedSlot>> slotsForJid=availableSlotsPerJid.get(jid);
  if (slotsForJid == null) {
    slotsForJid=new LinkedHashMap<Instance,List<SharedSlot>>();
    availableSlotsPerJid.put(jid,slotsForJid);
    for (    SharedSlot availableSlot : allSlots) {
      putIntoMultiMap(slotsForJid,availableSlot.getAllocatedSlot().getInstance(),availableSlot);
    }
  }
 else   if (slotsForJid.isEmpty()) {
    return null;
  }
  boolean didNotGetPreferred=false;
  if (preferredLocations != null) {
    for (    Instance location : preferredLocations) {
      didNotGetPreferred=true;
      SharedSlot slot=removeFromMultiMap(slotsForJid,location);
      if (slot != null) {
        SubSlot subslot=slot.allocateSubSlot(jid);
        subslot.setLocality(Locality.LOCAL);
        return subslot;
      }
    }
  }
  if (didNotGetPreferred && localOnly) {
    return null;
  }
  SharedSlot slot=pollFromMultiMap(slotsForJid);
  if (slot != null) {
    SubSlot subslot=slot.allocateSubSlot(jid);
    subslot.setLocality(didNotGetPreferred ? Locality.NON_LOCAL : Locality.UNCONSTRAINED);
    return subslot;
  }
 else {
    return null;
  }
}
