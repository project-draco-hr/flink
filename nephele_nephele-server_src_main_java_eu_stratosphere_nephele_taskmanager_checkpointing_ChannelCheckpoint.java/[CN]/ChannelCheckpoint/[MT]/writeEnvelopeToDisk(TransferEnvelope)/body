{
  TransferEnvelope duplicatTransferEnvelope=transferEnvelope;
  if (transferEnvelope.getProcessingLog().mustBeSentViaNetwork()) {
    duplicatTransferEnvelope=transferEnvelope.duplicate();
  }
  if (this.fileChannel == null) {
    final FileOutputStream fos=new FileOutputStream(getFilename());
    this.fileChannel=fos.getChannel();
  }
  if (this.transferEnvelopeSerializer == null) {
    this.transferEnvelopeSerializer=new TransferEnvelopeSerializer();
  }
  this.transferEnvelopeSerializer.setTransferEnvelope(duplicatTransferEnvelope);
  FileLock lock=this.fileChannel.lock();
  while (this.transferEnvelopeSerializer.write(this.fileChannel))   ;
  lock.release();
  transferEnvelope.getProcessingLog().setWrittenToCheckpoint();
  if (this.finishCheckpoint) {
    transferEnvelope.getProcessingLog().setSentViaNetwork();
  }
}
