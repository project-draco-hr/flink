{
  TransferEnvelope duplicatTransferEnvelope=transferEnvelope;
  if (transferEnvelope.getProcessingLog().mustBeSentViaNetwork()) {
    duplicatTransferEnvelope=transferEnvelope.duplicate();
  }
  if (this.fileChannel == null) {
    final FileOutputStream fos=new FileOutputStream(getFilename(),true);
    this.fileChannel=fos.getChannel();
  }
  if (this.transferEnvelopeSerializer == null) {
    this.transferEnvelopeSerializer=new TransferEnvelopeSerializer();
  }
synchronized (this.transferEnvelopeSerializer) {
    this.transferEnvelopeSerializer.setTransferEnvelope(duplicatTransferEnvelope);
    System.out.println("writing envelope " + duplicatTransferEnvelope.getSequenceNumber());
    while (this.transferEnvelopeSerializer.write(this.fileChannel))     ;
    transferEnvelope.getProcessingLog().setWrittenToCheckpoint();
    if (this.finishCheckpoint) {
      transferEnvelope.getProcessingLog().setSentViaNetwork();
    }
    this.offsets.add(this.fileChannel.size());
  }
}
