{
  boolean success=false;
  final File localBackupPath=new File(dbPath,"backup-" + checkpointId);
  final URI backupUri=new URI(checkpointPath + "/chk-" + checkpointId);
  try {
    if (!localBackupPath.exists()) {
      if (!localBackupPath.mkdirs()) {
        throw new RuntimeException("Could not create local backup path " + localBackupPath);
      }
    }
    try (BackupEngine backupEngine=BackupEngine.open(Env.getDefault(),new BackupableDBOptions(localBackupPath.getAbsolutePath()))){
      backupEngine.createNewBackup(db);
    }
     HDFSCopyFromLocal.copyFromLocal(localBackupPath,backupUri);
    KvStateSnapshot<K,N,S,SD,Backend> result=createRocksDBSnapshot(backupUri,checkpointId);
    success=true;
    return result;
  }
  finally {
    FileUtils.deleteDirectory(localBackupPath);
    if (!success) {
      FileSystem fs=FileSystem.get(backupUri,new Configuration());
      fs.delete(new Path(backupUri),true);
    }
  }
}
