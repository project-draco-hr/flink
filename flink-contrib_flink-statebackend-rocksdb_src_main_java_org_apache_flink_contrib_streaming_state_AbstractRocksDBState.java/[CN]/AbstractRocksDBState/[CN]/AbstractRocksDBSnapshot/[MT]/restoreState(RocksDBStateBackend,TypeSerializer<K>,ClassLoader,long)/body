{
  if (!this.keySerializer.equals(keySerializer)) {
    throw new IllegalArgumentException("Cannot restore the state from the snapshot with the given serializers. " + "State (K/V) was serialized with " + "(" + keySerializer + ") "+ "now is ("+ keySerializer+ ")");
  }
  if (!basePath.exists()) {
    if (!basePath.mkdirs()) {
      throw new RuntimeException("Could not create RocksDB base path " + basePath);
    }
  }
  final File localBackupPath=new File(basePath,"chk-" + checkpointId);
  if (localBackupPath.exists()) {
    try {
      LOG.warn("Deleting already existing local backup directory {}.",localBackupPath);
      FileUtils.deleteDirectory(localBackupPath);
    }
 catch (    IOException e) {
      throw new RuntimeException("Error cleaning RocksDB local backup directory.",e);
    }
  }
  writeHadoopConfig(new File(basePath,HADOOP_CONF_NAME));
  HDFSCopyToLocal.copyToLocal(new File(basePath,HADOOP_CONF_NAME),backupUri,basePath);
  return createRocksDBState(keySerializer,namespaceSerializer,stateDesc,basePath,checkpointPath,localBackupPath.getAbsolutePath(),stateBackend.getRocksDBOptions());
}
