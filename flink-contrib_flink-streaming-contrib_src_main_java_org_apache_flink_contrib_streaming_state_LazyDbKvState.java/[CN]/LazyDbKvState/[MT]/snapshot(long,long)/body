{
  if (timestamp <= nextTs) {
    throw new RuntimeException("Checkpoint timestamp is smaller than previous ts + 1, " + "this should not happen.");
  }
  for (  Entry<K,Optional<V>> state : cache.modified.entrySet()) {
    batchInsert.add(state,timestamp);
  }
  batchInsert.flush(timestamp);
  cache.modified.clear();
  nextTs=timestamp + 1;
  completedCheckpoints.put(checkpointId,timestamp);
  return new DbKvStateSnapshot<K,V>(kvStateId,timestamp,lastCompactedTs);
}
