{
  StreamExecutionEnvironment env=StreamExecutionEnvironment.getExecutionEnvironment();
  DataStream<Tuple2<Long,Long>> src1=env.fromElements(new Tuple2<>(0L,0L));
  DataStream<Tuple2<Long,Long>> src2=env.fromElements(new Tuple2<>(0L,0L));
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connected=src1.connect(src2);
  DataStream<Tuple2<Long,Long>> group1=src1.keyBy(0);
  DataStream<Tuple2<Long,Long>> group2=src1.keyBy(1,0);
  DataStream<Tuple2<Long,Long>> group3=src1.keyBy("f0");
  DataStream<Tuple2<Long,Long>> group4=src1.keyBy(new FirstSelector());
  int id1=createDownStreamId(group1);
  int id2=createDownStreamId(group2);
  int id3=createDownStreamId(group3);
  int id4=createDownStreamId(group4);
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),id1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),id2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),id3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),id4)));
  assertTrue(isKeyed(group1));
  assertTrue(isKeyed(group2));
  assertTrue(isKeyed(group3));
  assertTrue(isKeyed(group4));
  DataStream<Tuple2<Long,Long>> partition1=src1.keyBy(0);
  DataStream<Tuple2<Long,Long>> partition2=src1.keyBy(1,0);
  DataStream<Tuple2<Long,Long>> partition3=src1.keyBy("f0");
  DataStream<Tuple2<Long,Long>> partition4=src1.keyBy(new FirstSelector());
  int pid1=createDownStreamId(partition1);
  int pid2=createDownStreamId(partition2);
  int pid3=createDownStreamId(partition3);
  int pid4=createDownStreamId(partition4);
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),pid1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),pid2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),pid3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),pid4)));
  assertTrue(isKeyed(partition1));
  assertTrue(isKeyed(partition3));
  assertTrue(isKeyed(partition2));
  assertTrue(isKeyed(partition4));
  Partitioner<Long> longPartitioner=new Partitioner<Long>(){
    @Override public int partition(    Long key,    int numPartitions){
      return 100;
    }
  }
;
  DataStream<Tuple2<Long,Long>> customPartition1=src1.partitionCustom(longPartitioner,0);
  DataStream<Tuple2<Long,Long>> customPartition3=src1.partitionCustom(longPartitioner,"f0");
  DataStream<Tuple2<Long,Long>> customPartition4=src1.partitionCustom(longPartitioner,new FirstSelector());
  int cid1=createDownStreamId(customPartition1);
  int cid2=createDownStreamId(customPartition3);
  int cid3=createDownStreamId(customPartition4);
  assertTrue(isCustomPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),cid1)));
  assertTrue(isCustomPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),cid2)));
  assertTrue(isCustomPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),cid3)));
  assertFalse(isKeyed(customPartition1));
  assertFalse(isKeyed(customPartition3));
  assertFalse(isKeyed(customPartition4));
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedGroup1=connected.keyBy(0,0);
  Integer downStreamId1=createDownStreamId(connectedGroup1);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedGroup2=connected.keyBy(new int[]{0},new int[]{0});
  Integer downStreamId2=createDownStreamId(connectedGroup2);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedGroup3=connected.keyBy("f0","f0");
  Integer downStreamId3=createDownStreamId(connectedGroup3);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedGroup4=connected.keyBy(new String[]{"f0"},new String[]{"f0"});
  Integer downStreamId4=createDownStreamId(connectedGroup4);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedGroup5=connected.keyBy(new FirstSelector(),new FirstSelector());
  Integer downStreamId5=createDownStreamId(connectedGroup5);
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),downStreamId1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),downStreamId1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),downStreamId2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),downStreamId2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),downStreamId3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),downStreamId3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),downStreamId4)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),downStreamId4)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),downStreamId5)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),downStreamId5)));
  assertTrue(isKeyed(connectedGroup1));
  assertTrue(isKeyed(connectedGroup2));
  assertTrue(isKeyed(connectedGroup3));
  assertTrue(isKeyed(connectedGroup4));
  assertTrue(isKeyed(connectedGroup5));
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedPartition1=connected.keyBy(0,0);
  Integer connectDownStreamId1=createDownStreamId(connectedPartition1);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedPartition2=connected.keyBy(new int[]{0},new int[]{0});
  Integer connectDownStreamId2=createDownStreamId(connectedPartition2);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedPartition3=connected.keyBy("f0","f0");
  Integer connectDownStreamId3=createDownStreamId(connectedPartition3);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedPartition4=connected.keyBy(new String[]{"f0"},new String[]{"f0"});
  Integer connectDownStreamId4=createDownStreamId(connectedPartition4);
  ConnectedStreams<Tuple2<Long,Long>,Tuple2<Long,Long>> connectedPartition5=connected.keyBy(new FirstSelector(),new FirstSelector());
  Integer connectDownStreamId5=createDownStreamId(connectedPartition5);
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),connectDownStreamId1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),connectDownStreamId1)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),connectDownStreamId2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),connectDownStreamId2)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),connectDownStreamId3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),connectDownStreamId3)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),connectDownStreamId4)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),connectDownStreamId4)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src1.getId(),connectDownStreamId5)));
  assertTrue(isPartitioned(env.getStreamGraph().getStreamEdges(src2.getId(),connectDownStreamId5)));
  assertTrue(isKeyed(connectedPartition1));
  assertTrue(isKeyed(connectedPartition2));
  assertTrue(isKeyed(connectedPartition3));
  assertTrue(isKeyed(connectedPartition4));
  assertTrue(isKeyed(connectedPartition5));
}
