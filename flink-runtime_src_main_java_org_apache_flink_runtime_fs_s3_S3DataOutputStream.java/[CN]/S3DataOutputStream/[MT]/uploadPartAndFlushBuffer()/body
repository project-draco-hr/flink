{
  boolean operationSuccessful=false;
  if (this.uploadId == null) {
    this.uploadId=initiateMultipartUpload();
  }
  try {
    if (this.partNumber >= MAX_PART_NUMBER) {
      throw new IOException("Cannot upload any more data: maximum part number reached");
    }
    final InputStream inputStream=new InternalUploadInputStream(this.buf,this.bytesWritten);
    final UploadPartRequest request=new UploadPartRequest();
    request.setBucketName(this.bucket);
    request.setKey(this.object);
    request.setInputStream(inputStream);
    request.setUploadId(this.uploadId);
    request.setPartSize(this.bytesWritten);
    request.setPartNumber(this.partNumber++);
    final UploadPartResult result=this.s3Client.uploadPart(request);
    this.partETags.add(result.getPartETag());
    this.bytesWritten=0;
    operationSuccessful=true;
  }
 catch (  AmazonServiceException e) {
    throw new IOException(e.getMessage(),e);
  }
 finally {
    if (!operationSuccessful) {
      abortUpload();
    }
  }
}
