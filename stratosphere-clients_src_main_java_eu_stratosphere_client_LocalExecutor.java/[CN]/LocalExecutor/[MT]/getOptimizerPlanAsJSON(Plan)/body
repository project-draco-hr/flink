{
synchronized (this.lock) {
    final boolean shutDownAtEnd;
    if (this.nephele == null) {
      shutDownAtEnd=true;
      start();
    }
 else {
      shutDownAtEnd=false;
    }
    try {
      PactCompiler pc=new PactCompiler(new DataStatistics());
      OptimizedPlan op=pc.compile(plan);
      PlanJSONDumpGenerator gen=new PlanJSONDumpGenerator();
      return gen.getOptimizerPlanAsJSON(op);
    }
  finally {
      if (shutDownAtEnd) {
        stop();
      }
    }
  }
}
