{
  if (plan == null)   throw new IllegalArgumentException("The plan may not be null.");
  ContextChecker checker=new ContextChecker();
  checker.check(plan);
synchronized (this.lock) {
    final boolean shutDownAtEnd;
    if (this.nephele == null) {
      shutDownAtEnd=true;
      start();
    }
 else {
      shutDownAtEnd=false;
    }
    try {
      PactCompiler pc=new PactCompiler(new DataStatistics());
      OptimizedPlan op=pc.compile(plan);
      NepheleJobGraphGenerator jgg=new NepheleJobGraphGenerator();
      JobGraph jobGraph=jgg.compileJobGraph(op);
      JobClient jobClient=this.nephele.getJobClient(jobGraph);
      JobExecutionResult result=jobClient.submitJobAndWait();
      return result;
    }
  finally {
      if (shutDownAtEnd) {
        stop();
      }
    }
  }
}
