{
synchronized (fetchResponse) {
    while (!iter.hasNext()) {
      resetFetchResponse(readOffset);
      try {
        Thread.sleep(waitOnEmptyFetch);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
      }
    }
    MessageAndOffset messageAndOffset=iter.next();
    long currentOffset=messageAndOffset.offset();
    while (currentOffset < readOffset) {
      messageAndOffset=iter.next();
      currentOffset=messageAndOffset.offset();
    }
    readOffset=messageAndOffset.nextOffset();
    ByteBuffer payload=messageAndOffset.message().payload();
    byte[] bytes=new byte[payload.limit()];
    payload.get(bytes);
    return new MessageWithOffset(messageAndOffset.offset(),bytes);
  }
}
