{
  final EmbeddedChannel ch=new EmbeddedChannel(new OutboundEnvelopeEncoder(),new InboundEnvelopeDecoder(this.bufferProviderBroker));
  when(this.bufferProviderBroker.getBufferProvider(anyJobId(),anyChannelId())).thenReturn(this.bufferProvider);
  Envelope[] envelopes=new Envelope[]{nextEnvelope(true),nextEnvelope()};
  when(this.bufferProvider.registerBufferAvailabilityListener(Matchers.<BufferAvailabilityListener>anyObject())).thenReturn(BufferAvailabilityRegistration.NOT_REGISTERED_BUFFER_AVAILABLE);
  when(this.bufferProvider.requestBuffer(anyInt())).thenReturn(null).thenReturn(allocBuffer(envelopes[0].getBuffer().size()));
  ByteBuf buf=encode(ch,envelopes);
  decodeAndVerify(ch,buf,envelopes);
  Assert.assertEquals(0,buf.refCnt());
}
