{
  this.forwardingChain.processQueuedEvents();
  if (this.outgoingTransferEnvelope == null) {
    throw new IllegalStateException("Cannot find transfer envelope for channel with ID " + this.outputChannel.getID());
  }
  if (this.outgoingTransferEnvelope.getBuffer() != null) {
    throw new IllegalStateException("Channel " + this.outputChannel.getID() + " has already a buffer attached");
  }
  buffer.finishWritePhase();
  this.outgoingTransferEnvelope.setBuffer(buffer);
  this.forwardingChain.pushEnvelope(this.outgoingTransferEnvelope);
  this.outgoingTransferEnvelope=null;
}
