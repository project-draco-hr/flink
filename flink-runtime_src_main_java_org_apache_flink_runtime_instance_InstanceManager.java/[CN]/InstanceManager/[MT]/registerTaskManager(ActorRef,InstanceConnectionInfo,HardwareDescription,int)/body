{
synchronized (this.lock) {
    if (this.shutdown) {
      throw new IllegalStateException("InstanceManager is shut down.");
    }
    Instance prior=registeredHostsByConnection.get(taskManager);
    if (prior != null) {
      LOG.error("Registration attempt from TaskManager at " + taskManager.path() + ". This connection is already registered under ID "+ prior.getId());
      return null;
    }
    boolean wasDead=this.deadHosts.remove(taskManager);
    if (wasDead) {
      LOG.info("Registering TaskManager at " + taskManager.path() + " which was marked as dead earlier because of a heart-beat timeout.");
    }
    InstanceID id=null;
    do {
      id=new InstanceID();
    }
 while (registeredHostsById.containsKey(id));
    Instance host=new Instance(taskManager,connectionInfo,id,resources,numberOfSlots);
    registeredHostsById.put(id,host);
    registeredHostsByConnection.put(taskManager,host);
    totalNumberOfAliveTaskSlots+=numberOfSlots;
    if (LOG.isInfoEnabled()) {
      LOG.info(String.format("Registered TaskManager at %s as %s. Current number of registered hosts is %d.",taskManager.path(),id,registeredHostsById.size()));
    }
    host.reportHeartBeat();
    notifyNewInstance(host);
    return id;
  }
}
