{
  ActorRef taskManager=null;
  try {
    Configuration cfg=new Configuration();
    cfg.setInteger(ConfigConstants.TASK_MANAGER_MEMORY_SIZE_KEY,10);
    cfg.setInteger(ConfigConstants.TASK_MANAGER_DATA_PORT_KEY,dataPort);
    Option<String> jobMangerUrl=Option.apply(jobManager.path().toString());
    taskManager=TaskManager.startTaskManagerComponentsAndActor(cfg,system,"localhost",Option.<String>empty(),jobMangerUrl,useLocalCommunication,StreamingMode.BATCH_ONLY,TestingTaskManager.class);
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail("Could not create test TaskManager: " + e.getMessage());
  }
  if (waitForRegistration) {
    Future<Object> response=Patterns.ask(taskManager,TaskManagerMessages.getNotifyWhenRegisteredAtJobManagerMessage(),timeout);
    try {
      FiniteDuration d=new FiniteDuration(100,TimeUnit.SECONDS);
      Await.ready(response,d);
    }
 catch (    Exception e) {
      e.printStackTrace();
      fail("Exception while waiting for the task manager registration: " + e.getMessage());
    }
  }
  return taskManager;
}
