{
  final int numberOfSubtasks=64;
  File inputFile1=null;
  File inputFile2=null;
  File outputFile=null;
  File jarFile=new File(ServerTestUtils.getTempDir() + File.separator + "largeDoP.jar");
  JobClient jobClient=null;
  try {
    inputFile1=ServerTestUtils.createInputFile(0);
    inputFile2=ServerTestUtils.createInputFile(0);
    outputFile=new File(ServerTestUtils.getTempDir() + File.separator + ServerTestUtils.getRandomFilename());
    JarFileCreator jfc=new JarFileCreator(jarFile);
    jfc.addClass(UnionTask.class);
    jfc.createJarFile();
    final JobGraph jg=new JobGraph("Job with large DoP (" + numberOfSubtasks + ")");
    final JobFileInputVertex i1=new JobFileInputVertex("Input 1",jg);
    i1.setInvokableClass(FileLineReader.class);
    i1.setFilePath(new Path(inputFile1.toURI()));
    i1.setNumberOfSubtasks(numberOfSubtasks);
    final JobFileInputVertex i2=new JobFileInputVertex("Input 2",jg);
    i2.setInvokableClass(FileLineReader.class);
    i2.setFilePath(new Path(inputFile2.toURI()));
    i2.setNumberOfSubtasks(numberOfSubtasks);
    final JobTaskVertex f1=new JobTaskVertex("Forward 1",jg);
    f1.setInvokableClass(DoubleTargetTask.class);
    f1.setNumberOfSubtasks(numberOfSubtasks);
    JobFileOutputVertex o1=new JobFileOutputVertex("Output",jg);
    o1.setInvokableClass(FileLineWriter.class);
    o1.setFilePath(new Path(outputFile.toURI()));
    o1.setNumberOfSubtasks(numberOfSubtasks);
    i1.setVertexToShareInstancesWith(o1);
    i2.setVertexToShareInstancesWith(o1);
    f1.setVertexToShareInstancesWith(o1);
    i1.connectTo(f1,ChannelType.NETWORK,DistributionPattern.BIPARTITE);
    i2.connectTo(f1,ChannelType.NETWORK,DistributionPattern.BIPARTITE);
    f1.connectTo(o1,ChannelType.NETWORK,DistributionPattern.BIPARTITE);
    jg.addJar(new Path(jarFile.toURI()));
    jobClient=new JobClient(jg,configuration,getClass().getClassLoader());
    try {
      jobClient.submitJobAndWait();
    }
 catch (    JobExecutionException e) {
      return;
    }
catch (    Exception e) {
      e.printStackTrace();
      fail(e.getMessage());
    }
    fail("Undetected lack of resources");
  }
 catch (  JobGraphDefinitionException jgde) {
    fail(jgde.getMessage());
  }
catch (  IOException ioe) {
    fail(ioe.getMessage());
  }
 finally {
    if (inputFile1 != null) {
      inputFile1.delete();
    }
    if (inputFile2 != null) {
      inputFile2.delete();
    }
    if (outputFile != null) {
      if (outputFile.isDirectory()) {
        final String[] files=outputFile.list();
        final String outputDir=outputFile.getAbsolutePath();
        for (        final String file : files) {
          new File(outputDir + File.separator + file).delete();
        }
      }
      outputFile.delete();
    }
    if (jarFile != null) {
      jarFile.delete();
    }
    if (jobClient != null) {
      jobClient.close();
    }
  }
}
