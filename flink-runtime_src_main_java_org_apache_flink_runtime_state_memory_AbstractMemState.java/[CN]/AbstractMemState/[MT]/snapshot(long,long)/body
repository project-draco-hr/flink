{
  DataOutputSerializer out=new DataOutputSerializer(Math.max(size() * 16,16));
  out.writeInt(state.size());
  for (  Map.Entry<N,Map<K,SV>> namespaceState : state.entrySet()) {
    N namespace=namespaceState.getKey();
    namespaceSerializer.serialize(namespace,out);
    out.writeInt(namespaceState.getValue().size());
    for (    Map.Entry<K,SV> entry : namespaceState.getValue().entrySet()) {
      keySerializer.serialize(entry.getKey(),out);
      stateSerializer.serialize(entry.getValue(),out);
    }
  }
  byte[] bytes=out.getCopyOfBuffer();
  return createHeapSnapshot(bytes);
}
