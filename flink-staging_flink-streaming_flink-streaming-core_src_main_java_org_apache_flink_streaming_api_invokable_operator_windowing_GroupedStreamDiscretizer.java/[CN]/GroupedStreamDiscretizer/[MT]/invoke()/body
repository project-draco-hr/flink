{
  if (readNext() == null) {
    throw new RuntimeException("DataStream must not be empty");
  }
  while (nextRecord != null) {
    StreamDiscretizer<IN> groupInvokable=windowingGroups.get(keySelector.getKey(nextRecord.getObject()));
    if (groupInvokable == null) {
      groupInvokable=makeNewGroup(nextRecord);
    }
    for (    ActiveTriggerPolicy<IN> trigger : activeCentralTriggerPolicies) {
      Object[] result=trigger.preNotifyTrigger(nextRecord.getObject());
      for (      Object in : result) {
        if (!activeCentralEvictionPolicies.isEmpty()) {
          evictElements(centralActiveEviction(in));
        }
        for (        StreamDiscretizer<IN> group : windowingGroups.values()) {
          group.processFakeElement(in,trigger);
          checkForEmptyGroupBuffer(group);
        }
      }
    }
    for (    TriggerPolicy<IN> triggerPolicy : centralTriggerPolicies) {
      if (triggerPolicy.notifyTrigger(nextRecord.getObject())) {
        currentTriggerPolicies.add(triggerPolicy);
      }
    }
    if (currentTriggerPolicies.isEmpty()) {
      groupInvokable.processRealElement(nextRecord.getObject());
      checkForEmptyGroupBuffer(groupInvokable);
      if (!centralEvictionPolicies.isEmpty()) {
        evictElements(centralEviction(nextRecord.getObject(),false));
        deleteOrderForCentralEviction.add(groupInvokable);
      }
    }
 else {
      for (      StreamDiscretizer<IN> group : windowingGroups.values()) {
        if (group == groupInvokable) {
          group.processRealElement(nextRecord.getObject(),currentTriggerPolicies);
        }
 else {
          group.externalTriggerFakeElement(nextRecord.getObject(),currentTriggerPolicies);
        }
      }
      if (!centralEvictionPolicies.isEmpty()) {
        evictElements(centralEviction(nextRecord.getObject(),true));
        deleteOrderForCentralEviction.add(groupInvokable);
      }
    }
    currentTriggerPolicies.clear();
    readNext();
  }
  for (  Thread t : activePolicyThreads) {
    t.interrupt();
  }
  for (  StreamDiscretizer<IN> group : windowingGroups.values()) {
    group.emitFinalWindow(centralTriggerPolicies);
  }
}
