{
  final TestInstanceManager tim=new TestInstanceManager();
  final TestDeploymentManager tdm=new TestDeploymentManager();
  final QueueScheduler scheduler=new QueueScheduler(tdm,tim);
  final ExecutionGraph executionGraph=createExecutionGraph(ChannelType.FILE,tim);
  try {
    try {
      scheduler.schedulJob(executionGraph);
    }
 catch (    SchedulingException e) {
      fail(StringUtils.stringifyException(e));
    }
    tdm.waitForDeployment(1);
    assertEquals(executionGraph.getJobID(),tdm.getIDOfLastDeployedJob());
    List<ExecutionVertex> listOfDeployedVertices=tdm.getListOfLastDeployedVertices();
    assertNotNull(listOfDeployedVertices);
    assertEquals(1,listOfDeployedVertices.size());
    assertEquals(0,tim.getNumberOfReleaseMethodCalls());
    tdm.clear();
    ExecutionVertex vertex=listOfDeployedVertices.get(0);
    vertex.updateExecutionState(ExecutionState.STARTING);
    vertex.updateExecutionState(ExecutionState.RUNNING);
    vertex.updateExecutionState(ExecutionState.FINISHING);
    vertex.updateExecutionState(ExecutionState.FINISHED);
    assertEquals(0,tim.getNumberOfReleaseMethodCalls());
    tdm.waitForDeployment(2);
    assertEquals(executionGraph.getJobID(),tdm.getIDOfLastDeployedJob());
    listOfDeployedVertices=tdm.getListOfLastDeployedVertices();
    assertNotNull(listOfDeployedVertices);
    assertEquals(2,listOfDeployedVertices.size());
    vertex=listOfDeployedVertices.get(0);
    vertex.updateExecutionState(ExecutionState.STARTING);
    vertex.updateExecutionState(ExecutionState.RUNNING);
    vertex.updateExecutionState(ExecutionState.FINISHING);
    vertex.updateExecutionState(ExecutionState.FINISHED);
    vertex=listOfDeployedVertices.get(1);
    vertex.updateExecutionState(ExecutionState.STARTING);
    vertex.updateExecutionState(ExecutionState.RUNNING);
    vertex.updateExecutionState(ExecutionState.FINISHING);
    vertex.updateExecutionState(ExecutionState.FINISHED);
    assertEquals(1,tim.getNumberOfReleaseMethodCalls());
  }
  finally {
    try {
      LibraryCacheManager.unregister(executionGraph.getJobID());
    }
 catch (    IOException ioe) {
    }
  }
}
