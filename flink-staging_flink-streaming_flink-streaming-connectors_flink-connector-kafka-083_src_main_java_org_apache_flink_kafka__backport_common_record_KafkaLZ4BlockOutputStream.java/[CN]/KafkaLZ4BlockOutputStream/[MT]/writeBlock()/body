{
  if (bufferOffset == 0) {
    return;
  }
  int compressedLength=compressor.compress(buffer,0,bufferOffset,compressedBuffer,0);
  byte[] bufferToWrite=compressedBuffer;
  int compressMethod=0;
  if (compressedLength >= bufferOffset) {
    bufferToWrite=buffer;
    compressedLength=bufferOffset;
    compressMethod=LZ4_FRAME_INCOMPRESSIBLE_MASK;
  }
  Utils.writeUnsignedIntLE(out,compressedLength | compressMethod);
  out.write(bufferToWrite,0,compressedLength);
  if (flg.isBlockChecksumSet()) {
    int hash=checksum.hash(bufferToWrite,0,compressedLength,0);
    Utils.writeUnsignedIntLE(out,hash);
  }
  bufferOffset=0;
}
