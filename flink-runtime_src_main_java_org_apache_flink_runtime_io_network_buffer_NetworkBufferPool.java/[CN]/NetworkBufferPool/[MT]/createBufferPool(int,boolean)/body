{
synchronized (factoryLock) {
    if (isDestroyed) {
      throw new IllegalStateException("Network buffer pool has already been destroyed.");
    }
    if (numTotalRequiredBuffers + numRequiredBuffers > totalNumberOfMemorySegments) {
      throw new IOException(String.format("Insufficient number of network buffers: required %d, but only %d of %d available.",numRequiredBuffers,totalNumberOfMemorySegments - numTotalRequiredBuffers,totalNumberOfMemorySegments));
    }
    this.numTotalRequiredBuffers+=numRequiredBuffers;
    LocalBufferPool localBufferPool=new LocalBufferPool(this,numRequiredBuffers);
    if (!isFixedSize) {
      managedBufferPools.add(localBufferPool);
    }
    allBufferPools.add(localBufferPool);
    redistributeBuffers();
    return localBufferPool;
  }
}
