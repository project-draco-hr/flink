{
  final String configDir=getConfigDir();
  if (configDir == null) {
    fail("Cannot find configuration directory for cluster manager test");
  }
  GlobalConfiguration.loadConfiguration(configDir);
  final TestInstanceListener testInstanceListener=new TestInstanceListener();
  final ClusterManager cm=new ClusterManager();
  cm.setInstanceListener(testInstanceListener);
  Map<InstanceType,InstanceTypeDescription> instanceTypeDescriptions=null;
  try {
    final int ipcPort=ConfigConstants.DEFAULT_TASK_MANAGER_IPC_PORT;
    final int dataPort=ConfigConstants.DEFAULT_TASK_MANAGER_DATA_PORT;
    HardwareDescription hardwareDescription=HardwareDescriptionFactory.construct(2,2L * 1024L * 1024L* 1024L,2L * 1024L * 1024L* 1024L);
    InstanceConnectionInfo ici=new InstanceConnectionInfo(InetAddress.getByName("192.168.198.1"),ipcPort,dataPort);
    cm.reportHeartBeat(ici,hardwareDescription);
    instanceTypeDescriptions=cm.getMapOfAvailableInstanceTypes();
    assertEquals(3,instanceTypeDescriptions.size());
    Iterator<Map.Entry<InstanceType,InstanceTypeDescription>> it=instanceTypeDescriptions.entrySet().iterator();
    while (it.hasNext()) {
      final Map.Entry<InstanceType,InstanceTypeDescription> entry=it.next();
      if (LARGE_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(1,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else       if (MEDIUM_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(2,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else       if (SMALL_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(4,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else {
        fail("Unexpected instance type: " + entry.getKey());
      }
    }
    hardwareDescription=HardwareDescriptionFactory.construct(3,2L * 1024L * 1024L* 1024L,1024L * 1024L * 1024L);
    ici=new InstanceConnectionInfo(InetAddress.getByName("192.168.198.3"),ipcPort,dataPort);
    cm.reportHeartBeat(ici,hardwareDescription);
    instanceTypeDescriptions=cm.getMapOfAvailableInstanceTypes();
    assertEquals(3,instanceTypeDescriptions.size());
    it=instanceTypeDescriptions.entrySet().iterator();
    while (it.hasNext()) {
      final Map.Entry<InstanceType,InstanceTypeDescription> entry=it.next();
      if (LARGE_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(1,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else       if (MEDIUM_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(2,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else       if (SMALL_INSTANCE_TYPE_NAME.equals(entry.getKey().getIdentifier())) {
        assertEquals(5,entry.getValue().getMaximumNumberOfAvailableInstances());
      }
 else {
        fail("Unexpected instance type: " + entry.getKey());
      }
    }
  }
 catch (  UnknownHostException e) {
    fail(e.getMessage());
  }
 finally {
    if (cm != null) {
      cm.shutdown();
    }
  }
}
