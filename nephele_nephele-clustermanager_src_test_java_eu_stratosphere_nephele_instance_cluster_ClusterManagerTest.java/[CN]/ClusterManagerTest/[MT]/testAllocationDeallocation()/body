{
  GlobalConfiguration.loadConfiguration(System.getProperty("user.dir") + "/correct-conf");
  MyInstanceListener dummyInstanceListener=new MyInstanceListener();
  ClusterManager cm=new ClusterManager();
  cm.setInstanceListener(dummyInstanceListener);
  try {
    InetAddress inetAddress=null;
    try {
      inetAddress=InetAddress.getByName("192.168.198.1");
    }
 catch (    UnknownHostException e) {
      e.printStackTrace();
    }
    InstanceConnectionInfo instanceConnectionInfo=new InstanceConnectionInfo(inetAddress,1234,1235);
    cm.reportHeartBeat(instanceConnectionInfo);
    JobID jobID=new JobID();
    for (int i=0; i < 4; ++i) {
      cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
    }
    Thread.sleep(500);
    assertEquals(4,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
    try {
      cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
      assertTrue(false);
    }
 catch (    InstanceException e) {
      assertTrue(true);
    }
    List<AllocatedResource> resources=new ArrayList<AllocatedResource>(dummyInstanceListener.resourcesOfJobs.get(jobID));
    for (    AllocatedResource i : resources) {
      cm.releaseAllocatedResource(jobID,new Configuration(),i);
    }
    assertEquals(4,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
    for (int i=0; i < 4; ++i) {
      cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
    }
    Thread.sleep(500);
    assertEquals(8,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
  }
 catch (  InterruptedException e) {
    e.printStackTrace();
  }
 finally {
    if (cm != null) {
      cm.shutdown();
    }
  }
}
