{
  GlobalConfiguration.loadConfiguration(System.getProperty("user.dir") + "/correct-conf");
  MyInstanceListener dummyInstanceListener=new MyInstanceListener();
  ClusterManager cm=new ClusterManager();
  cm.setInstanceListener(dummyInstanceListener);
  InetAddress inetAddress=null;
  try {
    try {
      inetAddress=InetAddress.getByName("192.168.198.1");
    }
 catch (    UnknownHostException e) {
      fail(e.getMessage());
    }
    final InstanceConnectionInfo instanceConnectionInfo=new InstanceConnectionInfo(inetAddress,1234,1235);
    final HardwareDescription hardwareDescription=HardwareDescriptionFactory.construct(8,32L * 1024L * 1024L* 1024L,32L * 1024L * 1024L* 1024L);
    cm.reportHeartBeat(instanceConnectionInfo,hardwareDescription);
    final JobID jobID=new JobID();
    for (int i=0; i < 4; ++i) {
      try {
        cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
      }
 catch (      InstanceException e) {
        fail(e.getMessage());
      }
    }
    waitForInstanceArrival(dummyInstanceListener,4,1000);
    assertEquals(4,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
    try {
      cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
      assertTrue(false);
    }
 catch (    InstanceException e) {
      assertTrue(true);
    }
    final List<AllocatedResource> resources=new ArrayList<AllocatedResource>(dummyInstanceListener.resourcesOfJobs.get(jobID));
    for (    AllocatedResource i : resources) {
      try {
        cm.releaseAllocatedResource(jobID,new Configuration(),i);
      }
 catch (      InstanceException e) {
        fail(e.getMessage());
      }
    }
    assertEquals(4,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
    for (int i=0; i < 4; ++i) {
      try {
        cm.requestInstance(jobID,new Configuration(),cm.getDefaultInstanceType());
      }
 catch (      InstanceException e) {
        fail(e.getMessage());
      }
    }
    try {
      Thread.sleep(500);
    }
 catch (    InterruptedException e) {
      e.printStackTrace();
    }
    assertEquals(8,dummyInstanceListener.resourcesOfJobs.get(jobID).size());
  }
  finally {
    if (cm != null) {
      cm.shutdown();
    }
  }
}
