{
  final String configDir=getConfigDir();
  if (configDir == null) {
    fail("Cannot find configuration directory for cluster manager test");
  }
  GlobalConfiguration.loadConfiguration(configDir);
  final TestInstanceListener testInstanceListener=new TestInstanceListener();
  final ClusterManager cm=new ClusterManager(null);
  cm.setInstanceListener(testInstanceListener);
  try {
    final String ipAddress="192.168.198.1";
    final InstanceConnectionInfo instanceConnectionInfo=new InstanceConnectionInfo(InetAddress.getByName(ipAddress),ipAddress,null,1234,1235);
    final HardwareDescription hardwareDescription=HardwareDescriptionFactory.construct(8,8L * 1024L * 1024L* 1024L,8L * 1024L * 1024L* 1024L);
    cm.reportHeartBeat(instanceConnectionInfo,hardwareDescription);
    final JobID jobID=new JobID();
    final Configuration conf=new Configuration();
    final InstanceRequestMap instanceRequestMap=new InstanceRequestMap();
    instanceRequestMap.setNumberOfInstances(cm.getInstanceTypeByName(SMALL_INSTANCE_TYPE_NAME),2);
    instanceRequestMap.setNumberOfInstances(cm.getInstanceTypeByName(MEDIUM_INSTANCE_TYPE_NAME),1);
    try {
      cm.requestInstance(jobID,conf,instanceRequestMap,null);
    }
 catch (    InstanceException ie) {
      fail(ie.getMessage());
    }
    ClusterManagerTestUtils.waitForInstances(jobID,testInstanceListener,3,MAX_WAIT_TIME);
    final List<AllocatedResource> allocatedResources=testInstanceListener.getAllocatedResourcesForJob(jobID);
    assertEquals(3,allocatedResources.size());
    Iterator<AllocatedResource> it=allocatedResources.iterator();
    final Set<AllocationID> allocationIDs=new HashSet<AllocationID>();
    while (it.hasNext()) {
      final AllocatedResource allocatedResource=it.next();
      if (!LARGE_INSTANCE_TYPE_NAME.equals(allocatedResource.getInstance().getType().getIdentifier())) {
        fail("Allocated unexpected instance of type " + allocatedResource.getInstance().getType().getIdentifier());
      }
      if (allocationIDs.contains(allocatedResource.getAllocationID())) {
        fail("Discovered allocation ID " + allocatedResource.getAllocationID() + " at least twice");
      }
 else {
        allocationIDs.add(allocatedResource.getAllocationID());
      }
    }
    try {
      InstanceRequestMap instancem=new InstanceRequestMap();
      instancem.setNumberOfInstances(cm.getInstanceTypeByName(MEDIUM_INSTANCE_TYPE_NAME),1);
      cm.requestInstance(jobID,conf,instancem,null);
      fail("ClusterManager allowed to request more instances than actually available");
    }
 catch (    InstanceException ie) {
    }
    it=allocatedResources.iterator();
    try {
      while (it.hasNext()) {
        final AllocatedResource allocatedResource=it.next();
        cm.releaseAllocatedResource(jobID,conf,allocatedResource);
      }
    }
 catch (    InstanceException ie) {
      fail(ie.getMessage());
    }
    try {
      InstanceRequestMap instancem=new InstanceRequestMap();
      instancem.setNumberOfInstances(cm.getInstanceTypeByName(LARGE_INSTANCE_TYPE_NAME),1);
      cm.requestInstance(jobID,conf,instancem,null);
    }
 catch (    InstanceException ie) {
      fail(ie.getMessage());
    }
  }
 catch (  UnknownHostException e) {
    fail(e.getMessage());
  }
 finally {
    if (cm != null) {
      cm.shutdown();
    }
  }
}
