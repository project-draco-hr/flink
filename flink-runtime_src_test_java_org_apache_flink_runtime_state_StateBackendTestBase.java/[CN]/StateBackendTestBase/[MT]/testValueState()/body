{
  CheckpointStreamFactory streamFactory=createStreamFactory();
  KeyedStateBackend<Integer> backend=createKeyedBackend(IntSerializer.INSTANCE);
  ValueStateDescriptor<String> kvId=new ValueStateDescriptor<>("id",String.class,null);
  kvId.initializeSerializerUnlessSet(new ExecutionConfig());
  TypeSerializer<Integer> keySerializer=IntSerializer.INSTANCE;
  TypeSerializer<VoidNamespace> namespaceSerializer=VoidNamespaceSerializer.INSTANCE;
  TypeSerializer<String> valueSerializer=kvId.getSerializer();
  ValueState<String> state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") KvState<VoidNamespace> kvState=(KvState<VoidNamespace>)state;
  backend.setCurrentKey(1);
  assertNull(state.value());
  assertNull(getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  state.update("1");
  backend.setCurrentKey(2);
  assertNull(state.value());
  assertNull(getSerializedValue(kvState,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  state.update("2");
  backend.setCurrentKey(1);
  assertEquals("1",state.value());
  assertEquals("1",getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  KeyGroupsStateHandle snapshot1=runSnapshot(backend.snapshot(682375462378L,2,streamFactory));
  backend.setCurrentKey(1);
  state.update("u1");
  backend.setCurrentKey(2);
  state.update("u2");
  backend.setCurrentKey(3);
  state.update("u3");
  KeyGroupsStateHandle snapshot2=runSnapshot(backend.snapshot(682375462379L,4,streamFactory));
  backend.setCurrentKey(1);
  assertEquals("u1",state.value());
  assertEquals("u1",getSerializedValue(kvState,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("u2",state.value());
  assertEquals("u2",getSerializedValue(kvState,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(3);
  assertEquals("u3",state.value());
  assertEquals("u3",getSerializedValue(kvState,3,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.close();
  backend=restoreKeyedBackend(IntSerializer.INSTANCE,snapshot1);
  snapshot1.discardState();
  ValueState<String> restored1=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") KvState<VoidNamespace> restoredKvState1=(KvState<VoidNamespace>)restored1;
  backend.setCurrentKey(1);
  assertEquals("1",restored1.value());
  assertEquals("1",getSerializedValue(restoredKvState1,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("2",restored1.value());
  assertEquals("2",getSerializedValue(restoredKvState1,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.close();
  backend=restoreKeyedBackend(IntSerializer.INSTANCE,snapshot2);
  snapshot2.discardState();
  ValueState<String> restored2=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
  @SuppressWarnings("unchecked") KvState<VoidNamespace> restoredKvState2=(KvState<VoidNamespace>)restored2;
  backend.setCurrentKey(1);
  assertEquals("u1",restored2.value());
  assertEquals("u1",getSerializedValue(restoredKvState2,1,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(2);
  assertEquals("u2",restored2.value());
  assertEquals("u2",getSerializedValue(restoredKvState2,2,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.setCurrentKey(3);
  assertEquals("u3",restored2.value());
  assertEquals("u3",getSerializedValue(restoredKvState2,3,keySerializer,VoidNamespace.INSTANCE,namespaceSerializer,valueSerializer));
  backend.close();
}
