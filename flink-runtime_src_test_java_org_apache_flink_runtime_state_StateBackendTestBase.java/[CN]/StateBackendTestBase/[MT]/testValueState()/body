{
  backend.initializeForJob(new DummyEnvironment("test",1,0),"test_op",IntSerializer.INSTANCE);
  ValueStateDescriptor<String> kvId=new ValueStateDescriptor<>("id",String.class,null);
  kvId.initializeSerializerUnlessSet(new ExecutionConfig());
  ValueState<String> state=backend.getPartitionedState(null,VoidSerializer.INSTANCE,kvId);
  backend.setCurrentKey(1);
  assertNull(state.value());
  state.update("1");
  backend.setCurrentKey(2);
  assertNull(state.value());
  state.update("2");
  backend.setCurrentKey(1);
  assertEquals("1",state.value());
  HashMap<String,KvStateSnapshot<?,?,?,?,?>> snapshot1=backend.snapshotPartitionedState(682375462378L,2);
  for (  String key : snapshot1.keySet()) {
    if (snapshot1.get(key) instanceof AsynchronousKvStateSnapshot) {
      snapshot1.put(key,((AsynchronousKvStateSnapshot<?,?,?,?,?>)snapshot1.get(key)).materialize());
    }
  }
  backend.setCurrentKey(1);
  state.update("u1");
  backend.setCurrentKey(2);
  state.update("u2");
  backend.setCurrentKey(3);
  state.update("u3");
  HashMap<String,KvStateSnapshot<?,?,?,?,?>> snapshot2=backend.snapshotPartitionedState(682375462379L,4);
  for (  String key : snapshot2.keySet()) {
    if (snapshot2.get(key) instanceof AsynchronousKvStateSnapshot) {
      snapshot2.put(key,((AsynchronousKvStateSnapshot<?,?,?,?,?>)snapshot2.get(key)).materialize());
    }
  }
  backend.setCurrentKey(1);
  assertEquals("u1",state.value());
  backend.setCurrentKey(2);
  assertEquals("u2",state.value());
  backend.setCurrentKey(3);
  assertEquals("u3",state.value());
  backend.dispose();
  backend.initializeForJob(new DummyEnvironment("test",1,0),"test_op",IntSerializer.INSTANCE);
  backend.injectKeyValueStateSnapshots((HashMap)snapshot1,100);
  for (  String key : snapshot1.keySet()) {
    snapshot1.get(key).discardState();
  }
  ValueState<String> restored1=backend.getPartitionedState(null,VoidSerializer.INSTANCE,kvId);
  backend.setCurrentKey(1);
  assertEquals("1",restored1.value());
  backend.setCurrentKey(2);
  assertEquals("2",restored1.value());
  backend.dispose();
  backend.initializeForJob(new DummyEnvironment("test",1,0),"test_op",IntSerializer.INSTANCE);
  backend.injectKeyValueStateSnapshots((HashMap)snapshot2,100);
  for (  String key : snapshot2.keySet()) {
    snapshot2.get(key).discardState();
  }
  ValueState<String> restored2=backend.getPartitionedState(null,VoidSerializer.INSTANCE,kvId);
  backend.setCurrentKey(1);
  assertEquals("u1",restored2.value());
  backend.setCurrentKey(2);
  assertEquals("u2",restored2.value());
  backend.setCurrentKey(3);
  assertEquals("u3",restored2.value());
}
