{
  try {
    backend.initializeForJob(new DummyEnvironment("test",1,0),"test_op",IntSerializer.INSTANCE);
    ReducingStateDescriptor<String> kvId=new ReducingStateDescriptor<>("id",new AppendingReduce(),StringSerializer.INSTANCE);
    ReducingState<String> state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
    backend.setCurrentKey(1);
    state.add("1");
    backend.setCurrentKey(2);
    state.add("2");
    HashMap<String,KvStateSnapshot<?,?,?,?,?>> snapshot1=backend.snapshotPartitionedState(682375462378L,2);
    for (    String key : snapshot1.keySet()) {
      if (snapshot1.get(key) instanceof AsynchronousKvStateSnapshot) {
        snapshot1.put(key,((AsynchronousKvStateSnapshot<?,?,?,?,?>)snapshot1.get(key)).materialize());
      }
    }
    backend.dispose();
    backend.initializeForJob(new DummyEnvironment("test",1,0),"test_op",IntSerializer.INSTANCE);
    backend.injectKeyValueStateSnapshots((HashMap)snapshot1);
    for (    String key : snapshot1.keySet()) {
      snapshot1.get(key).discardState();
    }
    @SuppressWarnings("unchecked") TypeSerializer<String> fakeStringSerializer=(TypeSerializer<String>)(TypeSerializer<?>)FloatSerializer.INSTANCE;
    try {
      kvId=new ReducingStateDescriptor<>("id",new AppendingReduce(),fakeStringSerializer);
      state=backend.getPartitionedState(VoidNamespace.INSTANCE,VoidNamespaceSerializer.INSTANCE,kvId);
      state.get();
      fail("should recognize wrong serializers");
    }
 catch (    RuntimeException e) {
      if (!e.getMessage().contains("Trying to access state using wrong StateDescriptor")) {
        fail("wrong exception " + e);
      }
    }
catch (    Exception e) {
      fail("wrong exception " + e);
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    fail(e.getMessage());
  }
}
