{
  final int partitionFanOut=getPartitioningFanOutNoEstimates(this.availableMemory.size());
  if (partitionFanOut > MAX_NUM_PARTITIONS) {
    throw new RuntimeException("Hash join created ");
  }
  createPartitions(partitionFanOut,0);
  final int numBuckets=getInitialTableSize(this.availableMemory.size(),this.segmentSize,partitionFanOut,this.avgRecordLen);
  initTable(numBuckets,(byte)partitionFanOut);
  final int[] positions=this.buildSideKeyFields;
  final Class<? extends Key>[] keys=this.keyClasses;
  PactRecord record=new PactRecord();
  while (input.next(record)) {
    int hashCode=0;
    for (int i=0; i < positions.length; i++) {
      Key k=record.getField(positions[i],keys[i]);
      if (k != null) {
        hashCode^=hash(k.hashCode(),0);
      }
 else {
        throw new NullKeyFieldException(i);
      }
    }
    insertIntoTable(record,hashCode);
  }
  for (int i=0; i < this.partitionsBeingBuilt.size(); i++) {
    Partition p=this.partitionsBeingBuilt.get(i);
    p.finalizeBuildPhase(this.ioManager,this.currentEnumerator);
  }
}
