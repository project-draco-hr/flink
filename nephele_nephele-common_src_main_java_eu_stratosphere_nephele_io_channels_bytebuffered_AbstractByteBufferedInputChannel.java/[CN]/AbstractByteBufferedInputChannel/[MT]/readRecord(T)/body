{
  if (this.dataBuffer == null) {
    if (isClosed()) {
      return InputChannelResult.END_OF_STREAM;
    }
    BufferOrEvent boe=this.inputChannelBroker.getNextBufferOrEvent();
    if (boe == null) {
      throw new IllegalStateException("Input channel was queries for data even though none was announced available.");
    }
    if (boe.isEvent()) {
      if (this.deserializer.hasUnfinishedData()) {
        throw new IOException("Channel received an event before completing the current partial record.");
      }
      AbstractEvent evt=boe.getEvent();
      if (evt.getClass() == ByteBufferedChannelCloseEvent.class) {
        this.brokerAggreedToCloseChannel=true;
        return InputChannelResult.END_OF_STREAM;
      }
 else       if (evt.getClass() == EndOfSuperstepEvent.class) {
        return InputChannelResult.END_OF_SUPERSTEP;
      }
 else       if (evt instanceof AbstractTaskEvent) {
        this.currentEvent=(AbstractTaskEvent)evt;
        return InputChannelResult.TASK_EVENT;
      }
 else {
        LOG.error("Received unknown event: " + evt);
        return InputChannelResult.NONE;
      }
    }
 else {
      this.dataBuffer=boe.getBuffer();
    }
  }
  T nextRecord=this.deserializer.readData(target,this.dataBuffer);
  if (this.dataBuffer.remaining() == 0) {
    releasedConsumedReadBuffer(this.dataBuffer);
    this.dataBuffer=null;
    return nextRecord == null ? InputChannelResult.NONE : InputChannelResult.LAST_RECORD_FROM_BUFFER;
  }
 else {
    return nextRecord == null ? InputChannelResult.NONE : InputChannelResult.INTERMEDIATE_RECORD_FROM_BUFFER;
  }
}
