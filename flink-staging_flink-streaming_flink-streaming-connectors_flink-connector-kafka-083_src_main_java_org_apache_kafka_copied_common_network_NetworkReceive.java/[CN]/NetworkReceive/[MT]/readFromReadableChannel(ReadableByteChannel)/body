{
  int read=0;
  if (size.hasRemaining()) {
    int bytesRead=channel.read(size);
    if (bytesRead < 0)     throw new EOFException();
    read+=bytesRead;
    if (!size.hasRemaining()) {
      size.rewind();
      int receiveSize=size.getInt();
      if (receiveSize < 0)       throw new InvalidReceiveException("Invalid receive (size = " + receiveSize + ")");
      if (maxSize != UNLIMITED && receiveSize > maxSize)       throw new InvalidReceiveException("Invalid receive (size = " + receiveSize + " larger than "+ maxSize+ ")");
      this.buffer=ByteBuffer.allocate(receiveSize);
    }
  }
  if (buffer != null) {
    int bytesRead=channel.read(buffer);
    if (bytesRead < 0)     throw new EOFException();
    read+=bytesRead;
  }
  return read;
}
