{
  if (this.outgoingTransferEnvelope == null) {
    this.outgoingTransferEnvelope=createNewOutgoingTransferEnvelope();
  }
 else {
    if (this.outgoingTransferEnvelope.getBuffer() != null) {
      LOG.error("Channel " + this.byteBufferedOutputChannel.getID() + "' transfer envelope already has a buffer attached");
      return null;
    }
  }
  final CompressionLevel compressionLevel=this.byteBufferedOutputChannel.getCompressionLevel();
  BufferPairRequest byteBufferPair=null;
  if (compressionLevel == CompressionLevel.NO_COMPRESSION) {
    final int uncompressedBufferSize=calculateBufferSize();
    byteBufferPair=new BufferPairRequest(-1,uncompressedBufferSize,true);
  }
 else {
    final int compressedBufferSize=calculateBufferSize();
    final int uncompressedBufferSize=CompressionLoader.getUncompressedBufferSize(compressedBufferSize,compressionLevel);
    byteBufferPair=new BufferPairRequest(compressedBufferSize,uncompressedBufferSize,true);
  }
  final BufferPairResponse bufferResponse=this.byteBufferedOutputChannelGroup.requestEmptyWriteBuffers(this,byteBufferPair);
  if (compressionLevel == CompressionLevel.NO_COMPRESSION) {
    this.outgoingTransferEnvelope.setBuffer(bufferResponse.getUncompressedDataBuffer());
  }
 else {
    this.outgoingTransferEnvelope.setBuffer(bufferResponse.getCompressedDataBuffer());
    this.uncompressedDataBuffer=bufferResponse.getUncompressedDataBuffer();
  }
  return bufferResponse;
}
