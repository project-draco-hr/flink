{
  if (reduceFunction instanceof RichFunction) {
    throw new UnsupportedOperationException("Pre-aggregator of apply can not be a RichFunction.");
  }
  function=input.getExecutionEnvironment().clean(function);
  reduceFunction=input.getExecutionEnvironment().clean(reduceFunction);
  String callLocation=Utils.getCallLocationName();
  String udfName="WindowApply at " + callLocation;
  String opName="TriggerWindow(" + windowAssigner + ", "+ trigger+ ", "+ udfName+ ")";
  KeySelector<T,K> keySel=input.getKeySelector();
  OneInputStreamOperator<T,R> operator;
  boolean setProcessingTime=input.getExecutionEnvironment().getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime;
  if (evictor != null) {
    ListStateDescriptor<StreamRecord<T>> stateDesc=new ListStateDescriptor<>("window-contents",new StreamRecordSerializer<>(input.getType().createSerializer(getExecutionEnvironment().getConfig())));
    operator=new EvictingWindowOperator<>(windowAssigner,windowAssigner.getWindowSerializer(getExecutionEnvironment().getConfig()),keySel,input.getKeyType().createSerializer(getExecutionEnvironment().getConfig()),stateDesc,new ReduceApplyWindowFunction<>(reduceFunction,function),trigger,evictor).enableSetProcessingTime(setProcessingTime);
  }
 else {
    ReducingStateDescriptor<T> stateDesc=new ReducingStateDescriptor<>("window-contents",reduceFunction,input.getType().createSerializer(getExecutionEnvironment().getConfig()));
    operator=new WindowOperator<>(windowAssigner,windowAssigner.getWindowSerializer(getExecutionEnvironment().getConfig()),keySel,input.getKeyType().createSerializer(getExecutionEnvironment().getConfig()),stateDesc,function,trigger).enableSetProcessingTime(setProcessingTime);
  }
  return input.transform(opName,resultType,operator);
}
