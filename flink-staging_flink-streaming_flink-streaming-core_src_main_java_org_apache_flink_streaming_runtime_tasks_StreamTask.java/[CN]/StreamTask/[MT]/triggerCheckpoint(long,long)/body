{
synchronized (checkpointLock) {
    if (isRunning) {
      try {
        LOG.debug("Starting checkpoint {} on task {}",checkpointId,getName());
        List<Tuple2<StateHandle<Serializable>,Map<String,PartitionedStateHandle>>> chainedStates=new ArrayList<Tuple2<StateHandle<Serializable>,Map<String,PartitionedStateHandle>>>();
        WrapperStateHandle stateHandle;
        try {
          for (          StreamOperator<?> chainedOperator : outputHandler.getChainedOperators()) {
            if (chainedOperator instanceof StatefulStreamOperator) {
              chainedStates.add(((StatefulStreamOperator<?>)chainedOperator).getStateSnapshotFromFunction(checkpointId,timestamp));
            }
 else {
              chainedStates.add(null);
            }
          }
          stateHandle=CollectionUtils.exists(chainedStates,NotNullPredicate.INSTANCE) ? new WrapperStateHandle(chainedStates) : null;
        }
 catch (        Exception e) {
          throw new Exception("Error while drawing snapshot of the user state.",e);
        }
        outputHandler.broadcastBarrier(checkpointId,timestamp);
        if (stateHandle == null) {
          getEnvironment().acknowledgeCheckpoint(checkpointId);
        }
 else {
          getEnvironment().acknowledgeCheckpoint(checkpointId,stateHandle);
        }
      }
 catch (      Exception e) {
        if (isRunning) {
          throw e;
        }
      }
    }
  }
}
