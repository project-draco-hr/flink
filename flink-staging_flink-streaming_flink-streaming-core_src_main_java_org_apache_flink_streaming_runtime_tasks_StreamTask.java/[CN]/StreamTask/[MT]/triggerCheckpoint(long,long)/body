{
synchronized (checkpointLock) {
    if (isRunning) {
      try {
        LOG.debug("Starting checkpoint {} on task {}",checkpointId,getName());
        List<Map<String,PartitionedStateHandle>> chainedStates=new ArrayList<Map<String,PartitionedStateHandle>>();
        StateHandle<Serializable> stateHandle;
        try {
          if (streamOperator instanceof StatefulStreamOperator) {
            chainedStates.add(((StatefulStreamOperator<?>)streamOperator).getStateSnapshotFromFunction(checkpointId,timestamp));
          }
          if (hasChainedOperators) {
            for (            OneInputStreamOperator<?,?> chainedOperator : outputHandler.getChainedOperators()) {
              if (chainedOperator instanceof StatefulStreamOperator) {
                chainedStates.add(((StatefulStreamOperator<?>)chainedOperator).getStateSnapshotFromFunction(checkpointId,timestamp));
              }
            }
          }
          stateHandle=CollectionUtils.exists(chainedStates,NotNullPredicate.INSTANCE) ? new WrapperStateHandle(chainedStates) : null;
        }
 catch (        Exception e) {
          throw new Exception("Error while drawing snapshot of the user state.",e);
        }
        outputHandler.broadcastBarrier(checkpointId,timestamp);
        if (stateHandle == null) {
          getEnvironment().acknowledgeCheckpoint(checkpointId);
        }
 else {
          getEnvironment().acknowledgeCheckpoint(checkpointId,stateHandle);
        }
      }
 catch (      Exception e) {
        if (isRunning) {
          throw e;
        }
      }
    }
  }
}
