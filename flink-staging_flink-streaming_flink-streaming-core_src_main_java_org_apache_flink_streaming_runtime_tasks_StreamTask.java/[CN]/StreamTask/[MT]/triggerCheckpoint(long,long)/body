{
synchronized (checkpointLock) {
    if (isRunning) {
      try {
        LOG.info("Starting checkpoint {} on task {}",checkpointId,getName());
        LocalStateHandle state;
        try {
          Serializable userState=streamOperator.getStateSnapshotFromFunction(checkpointId,timestamp);
          if (chained) {
            List<Serializable> chainedStates=new ArrayList<Serializable>();
            chainedStates.add(userState);
            for (            StreamOperator<?,?> chainedOperator : outputHandler.getChainedOperators()) {
              chainedStates.add(chainedOperator.getStateSnapshotFromFunction(checkpointId,timestamp));
            }
            userState=CollectionUtils.exists(chainedStates,NotNullPredicate.INSTANCE) ? (Serializable)chainedStates : null;
          }
          state=userState == null ? null : new LocalStateHandle(userState);
        }
 catch (        Exception e) {
          throw new Exception("Error while drawing snapshot of the user state.",e);
        }
        outputHandler.broadcastBarrier(checkpointId,timestamp);
        if (state == null) {
          getEnvironment().acknowledgeCheckpoint(checkpointId);
        }
 else {
          getEnvironment().acknowledgeCheckpoint(checkpointId,state);
        }
      }
 catch (      Exception e) {
        if (isRunning) {
          throw e;
        }
      }
    }
  }
}
