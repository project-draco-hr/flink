{
  LOG.info("Starting KafkaITCase.test()");
  TestingServer zookeeper=null;
  KafkaServer broker1=null;
  try {
    zookeeper=getZookeeper();
    broker1=getKafkaServer(0);
    LOG.info("ZK and KafkaServer started. Creating test topic:");
    createTestTopic();
    LOG.info("Starting Kafka Topology in Flink:");
    startKafkaTopology();
    LOG.info("Test succeeded.");
  }
 catch (  Throwable t) {
    LOG.warn("Test failed with exception",t);
    Assert.fail("Test failed with: " + t.getMessage());
  }
 finally {
    LOG.info("Shutting down all services");
    if (broker1 != null) {
      broker1.shutdown();
    }
    if (zookeeper != null) {
      try {
        zookeeper.stop();
      }
 catch (      IOException e) {
        LOG.warn("ZK.stop() failed",e);
      }
    }
  }
}
