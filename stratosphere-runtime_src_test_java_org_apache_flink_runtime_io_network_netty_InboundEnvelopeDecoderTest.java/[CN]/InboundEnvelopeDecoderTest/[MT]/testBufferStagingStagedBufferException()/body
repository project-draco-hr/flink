{
  final EmbeddedChannel ch=new EmbeddedChannel(new OutboundEnvelopeEncoder(),new InboundEnvelopeDecoder(this.bufferProviderBroker));
  when(this.bufferProviderBroker.getBufferProvider(anyJobId(),anyChannelId())).thenReturn(this.bufferProvider);
  ByteBuf buf=encode(ch,nextEnvelope(true));
  when(this.bufferProvider.requestBuffer(anyInt())).thenReturn(null);
  when(this.bufferProvider.registerBufferAvailabilityListener(Matchers.<BufferAvailabilityListener>anyObject())).thenReturn(BufferAvailabilityRegistration.SUCCEEDED_REGISTERED);
  int refCount=buf.refCnt();
  decodeAndVerify(ch,buf);
  Assert.assertFalse(ch.config().isAutoRead());
  Assert.assertEquals(refCount + 1,buf.refCnt());
  try {
    decodeAndVerify(ch,buf);
    Assert.fail("Expected IllegalStateException not thrown");
  }
 catch (  IllegalStateException e) {
  }
  buf.release();
}
