{
  MetricRegistry registry=null;
  DatagramSocketReceiver receiver=null;
  Thread receiverThread=null;
  long timeout=5000;
  long joinTimeout=30000;
  String histogramName="histogram";
  try {
    receiver=new DatagramSocketReceiver();
    receiverThread=new Thread(receiver);
    receiverThread.start();
    int port=receiver.getPort();
    Configuration config=new Configuration();
    config.setString(MetricRegistry.KEY_METRICS_REPORTER_CLASS,StatsDReporter.class.getName());
    config.setString(MetricRegistry.KEY_METRICS_REPORTER_INTERVAL,"1 SECONDS");
    config.setString(MetricRegistry.KEY_METRICS_REPORTER_ARGUMENTS,"--host localhost --port " + port);
    registry=new MetricRegistry(config);
    TaskManagerMetricGroup metricGroup=new TaskManagerMetricGroup(registry,"localhost","tmId");
    TestingHistogram histogram=new TestingHistogram();
    metricGroup.histogram(histogramName,histogram);
    receiver.waitUntilNumLines(11,timeout);
    Set<String> lines=receiver.getLines();
    String prefix=metricGroup.getScopeString() + "." + histogramName;
    Set<String> expectedLines=new HashSet<>();
    expectedLines.add(prefix + ".count:1|g");
    expectedLines.add(prefix + ".mean:3.0|g");
    expectedLines.add(prefix + ".min:6|g");
    expectedLines.add(prefix + ".max:5|g");
    expectedLines.add(prefix + ".stddev:4.0|g");
    expectedLines.add(prefix + ".p75:0.75|g");
    expectedLines.add(prefix + ".p98:0.98|g");
    expectedLines.add(prefix + ".p99:0.99|g");
    expectedLines.add(prefix + ".p999:0.999|g");
    expectedLines.add(prefix + ".p95:0.95|g");
    expectedLines.add(prefix + ".p50:0.5|g");
    assertEquals(expectedLines,lines);
  }
  finally {
    if (registry != null) {
      registry.shutdown();
    }
    if (receiver != null) {
      receiver.stop();
    }
    if (receiverThread != null) {
      receiverThread.join(joinTimeout);
    }
  }
}
