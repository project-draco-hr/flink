{
  if (keyedStateBackend != null) {
    throw new RuntimeException("The keyed state backend can only be created once.");
  }
  String operatorIdentifier=createOperatorIdentifier(headOperator,configuration.getVertexID());
  if (lazyRestoreKeyGroupStates != null) {
    keyedStateBackend=stateBackend.restoreKeyedStateBackend(getEnvironment(),getEnvironment().getJobID(),operatorIdentifier,keySerializer,keyGroupAssigner,keyGroupRange,lazyRestoreKeyGroupStates,getEnvironment().getTaskKvStateRegistry());
    lazyRestoreKeyGroupStates=null;
  }
 else {
    keyedStateBackend=stateBackend.createKeyedStateBackend(getEnvironment(),getEnvironment().getJobID(),operatorIdentifier,keySerializer,keyGroupAssigner,keyGroupRange,getEnvironment().getTaskKvStateRegistry());
  }
  return (KeyedStateBackend<K>)keyedStateBackend;
}
