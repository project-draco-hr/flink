{
  if (s == null) {
    throw new NullPointerException();
  }
  if (this.utf8Encoder == null) {
    this.utf8Encoder=UTF8_ENCODER.get();
  }
  final int oldPosition=this.buffer.position();
  final CharBuffer charBuf=CharBuffer.wrap(s);
  final CoderResult result=this.utf8Encoder.encode(charBuf,this.buffer,true);
  if (result.isError()) {
    this.buffer.position(oldPosition);
    throw new IOException("Unexpected error while encoding string");
  }
  if (result.isUnderflow()) {
    this.buffer.position(oldPosition);
    throw new IOException("Unexpected buffer underflow");
  }
  if (result.isOverflow()) {
    this.buffer.position(oldPosition);
    throw new BufferOverflowException();
  }
  this.written=this.buffer.position() - oldPosition;
}
